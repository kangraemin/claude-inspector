<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Inspector</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js"></script>
  <style>
    :root {
      --bg: #1e1e1e; --surface: #252526; --surface2: #2d2d2d;
      --border: #3e3e42; --text: #d4d4d4; --dim: #858585;
      --blue: #569cd6; --green: #4ec9b0; --yellow: #dcdcaa;
      --red: #f48771; --purple: #c586c0; --orange: #ce9178;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg); color: var(--text);
      height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; height: 50px;
      background: var(--surface); border-bottom: 1px solid var(--border);
      flex-shrink: 0; gap: 12px;
    }
    /* â”€â”€ Window drag (macOS hiddenInset) â”€â”€ */
    .header { -webkit-app-region: drag; }
    .header-right, .header-right *, .logo { -webkit-app-region: no-drag; }

    .logo { display: flex; align-items: center; gap: 9px; }
    .logo-icon {
      width: 28px; height: 28px;
      background: linear-gradient(135deg, #569cd6, #c586c0);
      border-radius: 6px; display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 800; color: #fff; letter-spacing: -.5px;
    }
    .logo-text { font-size: 15px; font-weight: 700; }
    .logo-sub { font-size: 11px; color: var(--dim); }
    .header-right { display: flex; align-items: center; gap: 8px; }
    .model-select {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text);
      padding: 4px 8px; font-size: 12px; outline: none; cursor: pointer;
    }
    .api-group { display: flex; align-items: center; gap: 6px; }
    .api-label { font-size: 11px; color: var(--dim); }
    .api-saved {
      font-size: 10px; padding: 2px 6px; border-radius: 10px;
      background: rgba(78,201,176,.15); color: var(--green);
      border: 1px solid rgba(78,201,176,.3);
    }
    .api-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); transition: background .2s; }
    .api-dot.ok { background: var(--green); }
    .api-input {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text);
      padding: 5px 10px; font-size: 12px; width: 240px;
      font-family: 'SF Mono', monospace; outline: none; transition: border-color .15s;
    }
    .api-input:focus { border-color: var(--blue); }

    /* â”€â”€ History toggle button â”€â”€ */
    .hist-btn {
      padding: 4px 10px; border-radius: 5px; font-size: 11px;
      background: none; border: 1px solid var(--border);
      color: var(--dim); cursor: pointer; transition: all .15s; white-space: nowrap;
    }
    .hist-btn:hover { color: var(--text); border-color: var(--blue); }
    .hist-btn.active { color: var(--blue); border-color: var(--blue); background: rgba(86,156,214,.08); }

    /* â”€â”€ Tabs â”€â”€ */
    .tabs {
      display: flex; background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 12px; gap: 2px; flex-shrink: 0;
    }
    .tab {
      display: flex; align-items: center; gap: 7px;
      padding: 10px 16px; cursor: pointer;
      background: none; border: none; color: var(--dim); font-size: 13px;
      border-bottom: 2px solid transparent;
      transition: color .15s, border-color .15s; white-space: nowrap;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--text); border-bottom-color: var(--blue); }
    .badge {
      font-size: 10px; font-weight: 700;
      padding: 2px 6px; border-radius: 3px; font-family: 'SF Mono', monospace;
    }
    .tab[data-m="claude-md"]    .badge { background: var(--green);  color: #000; }
    .tab[data-m="output-style"] .badge { background: var(--blue);   color: #000; }
    .tab[data-m="slash-command"].badge { background: var(--yellow); color: #000; }
    .tab[data-m="skill"]        .badge { background: var(--purple); color: #fff; }
    .tab[data-m="sub-agent"]    .badge { background: var(--orange); color: #000; }

    /* â”€â”€ Layout â”€â”€ */
    .main { display: flex; flex: 1; overflow: hidden; }

    /* â”€â”€ Left: Config â”€â”€ */
    .config-panel {
      width: 400px; flex-shrink: 0;
      background: var(--surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .panel-header {
      padding: 9px 14px; font-size: 11px; text-transform: uppercase;
      letter-spacing: .8px; color: var(--dim);
      border-bottom: 1px solid var(--border); flex-shrink: 0;
      display: flex; align-items: center; justify-content: space-between;
    }
    .inject-chip {
      font-size: 10px; padding: 2px 7px; border-radius: 10px;
      background: rgba(86,156,214,.12); color: var(--blue);
      border: 1px solid rgba(86,156,214,.25);
      text-transform: none; letter-spacing: 0; font-family: 'SF Mono', monospace;
    }
    .config-body {
      flex: 1; overflow-y: auto; padding: 13px;
      display: flex; flex-direction: column; gap: 11px;
    }
    .field { display: flex; flex-direction: column; gap: 5px; }
    .field label {
      font-size: 11px; color: var(--dim); font-weight: 600;
      text-transform: uppercase; letter-spacing: .5px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .field input, .field textarea, .field select {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text);
      padding: 6px 10px; font-size: 12px;
      font-family: 'SF Mono', monospace; outline: none;
      transition: border-color .15s; resize: vertical;
    }
    .field input:focus, .field textarea:focus, .field select:focus { border-color: var(--blue); }
    .field textarea { min-height: 80px; }
    .field textarea.tall { min-height: 120px; }

    /* â”€â”€ File button â”€â”€ */
    .file-btn {
      padding: 2px 8px; border-radius: 4px; font-size: 10px;
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--dim); cursor: pointer; transition: all .15s;
      text-transform: none; letter-spacing: 0; font-weight: normal;
    }
    .file-btn:hover { color: var(--text); border-color: var(--blue); }

    /* â”€â”€ How-it-works box â”€â”€ */
    .how-box {
      background: rgba(86,156,214,.05); border: 1px solid rgba(86,156,214,.18);
      border-radius: 7px; padding: 11px 13px;
      display: flex; flex-direction: column; gap: 8px;
    }
    .how-title { font-size: 10px; font-weight: 700; color: var(--blue); text-transform: uppercase; letter-spacing: .7px; }
    .how-text { font-size: 12px; color: var(--dim); line-height: 1.55; }
    .how-text code {
      background: var(--surface2); padding: 1px 4px; border-radius: 3px;
      font-family: 'SF Mono', monospace; font-size: 11px; color: var(--text);
    }
    .example-row { display: flex; align-items: flex-start; gap: 6px; font-size: 11px; color: var(--dim); line-height: 1.45; }
    .example-row .ex-tag {
      flex-shrink: 0; background: rgba(78,201,176,.12); color: var(--green);
      border: 1px solid rgba(78,201,176,.25); border-radius: 4px;
      font-size: 10px; font-weight: 700; padding: 1px 5px;
    }
    .warn-row { display: flex; align-items: flex-start; gap: 6px; font-size: 11px; color: var(--yellow); line-height: 1.45; }
    .warn-row .w-icon { flex-shrink: 0; }

    /* â”€â”€ Flow diagram â”€â”€ */
    .flow { display: flex; flex-direction: column; gap: 0; }
    .flow-api-label {
      font-size: 10px; font-weight: 700; color: var(--blue);
      text-transform: uppercase; letter-spacing: .5px;
      margin-bottom: 4px; margin-top: 6px;
    }
    .flow-api-label:first-child { margin-top: 0; }
    .flow-step {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 4px; padding: 6px 10px;
      font-size: 11px; font-family: 'SF Mono', monospace; line-height: 1.4; color: var(--text);
    }
    .flow-step.hi-purple { border-color: var(--purple); color: var(--purple); background: rgba(197,134,192,.07); }
    .flow-step.hi-orange { border-color: var(--orange); color: var(--orange); background: rgba(206,145,120,.07); }
    .flow-step.hi-yellow { border-color: var(--yellow); color: var(--yellow); background: rgba(220,220,170,.07); }
    .flow-arrow { text-align: center; color: var(--dim); font-size: 11px; padding: 3px 0; }
    .flow-divider { border: none; border-top: 1px dashed var(--border); margin: 7px 0; }

    /* â”€â”€ Buttons â”€â”€ */
    .config-footer {
      padding: 11px 13px; border-top: 1px solid var(--border);
      display: flex; gap: 8px; flex-shrink: 0; align-items: center;
    }
    .btn {
      padding: 7px 14px; border-radius: 5px; font-size: 12px; font-weight: 600;
      cursor: pointer; border: none; transition: opacity .15s;
      display: flex; align-items: center; gap: 6px;
    }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .btn-send { background: var(--blue); color: #fff; flex: 1; justify-content: center; }
    .btn-sim  { background: var(--purple); color: #fff; flex: 1; justify-content: center; }
    .btn-sa   { background: var(--orange); color: #000; flex: 1; justify-content: center; }
    .btn-send:not(:disabled):hover, .btn-sim:not(:disabled):hover, .btn-sa:not(:disabled):hover { opacity: .82; }
    .btn-copy { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn-copy:hover { border-color: var(--blue); }

    /* â”€â”€ Right: Preview panel â”€â”€ */
    .preview-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .preview-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 7px 14px; background: var(--surface);
      border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .ptabs { display: flex; gap: 4px; }
    .ptab {
      padding: 4px 12px; font-size: 12px; border-radius: 4px; cursor: pointer;
      background: none; border: 1px solid transparent; color: var(--dim); transition: all .15s;
    }
    .ptab.active { background: var(--surface2); border-color: var(--border); color: var(--text); }
    .pactions { display: flex; align-items: center; gap: 8px; }

    /* â”€â”€ Size/Token pill â”€â”€ */
    .size-pill {
      font-size: 10px; padding: 2px 8px; border-radius: 10px;
      background: rgba(133,133,133,.1); color: var(--dim); border: 1px solid var(--border);
      font-family: 'SF Mono', monospace; white-space: nowrap;
    }
    .live-pill {
      display: flex; align-items: center; gap: 5px; font-size: 11px;
      padding: 3px 8px; border-radius: 10px;
      background: rgba(78,201,176,.1); color: var(--green); border: 1px solid rgba(78,201,176,.22);
    }
    .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
    .copy-small {
      padding: 4px 10px; font-size: 11px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 4px; color: var(--dim); cursor: pointer; transition: all .15s;
    }
    .copy-small:hover { color: var(--text); border-color: var(--blue); }

    /* â”€â”€ pview base â”€â”€ */
    .pview { flex: 1; overflow: auto; }
    .pview pre { margin: 0; padding: 16px; font-size: 12px; line-height: 1.65; min-height: 100%; }
    .pview code { font-family: 'SF Mono', 'Fira Code', monospace !important; }
    .pview.hidden { display: none; }

    /* â”€â”€ Response pane (flex override) â”€â”€ */
    #pv-response { display: flex; flex-direction: column; overflow: hidden; }
    #pv-response.hidden { display: none; }
    .resp-toolbar {
      padding: 6px 14px; background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: flex-end;
      flex-shrink: 0; gap: 8px;
    }
    .resp-md-label { font-size: 11px; color: var(--dim); }
    .resp-md-btn {
      padding: 3px 9px; font-size: 10px; border-radius: 4px; cursor: pointer;
      background: none; border: 1px solid var(--border);
      color: var(--dim); transition: all .15s; font-weight: 700; font-family: 'SF Mono', monospace;
    }
    .resp-md-btn:hover, .resp-md-btn.active { border-color: var(--blue); color: var(--blue); }
    .resp-scroll { flex: 1; overflow: auto; }
    #resp-view { padding: 16px; }
    .resp-text { font-size: 13px; line-height: 1.75; color: var(--text); }
    .resp-text:not(.md-rendered) { white-space: pre-wrap; }
    .resp-err { color: var(--red); font-family: monospace; font-size: 12px; }
    .resp-meta {
      margin-top: 14px; padding-top: 10px; border-top: 1px solid var(--border);
      display: flex; gap: 16px; flex-wrap: wrap;
    }
    .resp-stat { font-size: 11px; }
    .resp-stat span { color: var(--dim); }
    .resp-stat b { color: var(--text); }
    .resp-copy {
      margin-top: 10px; padding: 5px 12px; font-size: 11px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 4px; color: var(--dim); cursor: pointer; transition: all .15s; display: inline-block;
    }
    .resp-copy:hover { color: var(--text); border-color: var(--blue); }

    /* â”€â”€ Markdown rendered â”€â”€ */
    .md-rendered h1, .md-rendered h2, .md-rendered h3 { color: var(--text); margin: 14px 0 6px; font-weight: 600; }
    .md-rendered h1 { font-size: 17px; }
    .md-rendered h2 { font-size: 15px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
    .md-rendered h3 { font-size: 13px; color: var(--blue); }
    .md-rendered p { margin-bottom: 10px; line-height: 1.7; }
    .md-rendered ul, .md-rendered ol { padding-left: 22px; margin-bottom: 10px; }
    .md-rendered li { margin-bottom: 5px; line-height: 1.6; }
    .md-rendered code {
      background: var(--surface2); padding: 1px 5px; border-radius: 3px;
      font-family: 'SF Mono', monospace; font-size: 11.5px; color: var(--green);
    }
    .md-rendered pre {
      background: var(--surface2); padding: 10px 14px; border-radius: 6px;
      overflow-x: auto; margin: 10px 0; border: 1px solid var(--border);
    }
    .md-rendered pre code { background: none; padding: 0; color: var(--text); font-size: 12px; }
    .md-rendered blockquote {
      border-left: 3px solid var(--blue); padding-left: 14px;
      color: var(--dim); margin: 10px 0; font-style: italic;
    }
    .md-rendered strong { color: var(--text); }
    .md-rendered a { color: var(--blue); text-decoration: none; }
    .md-rendered a:hover { text-decoration: underline; }
    .md-rendered hr { border: none; border-top: 1px solid var(--border); margin: 14px 0; }
    .md-rendered table { border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 12px; }
    .md-rendered th, .md-rendered td { border: 1px solid var(--border); padding: 6px 10px; text-align: left; }
    .md-rendered th { background: var(--surface2); color: var(--blue); }

    /* â”€â”€ Export pane â”€â”€ */
    #pv-export { display: flex; flex-direction: column; overflow: hidden; }
    #pv-export.hidden { display: none; }
    .exp-toolbar {
      padding: 8px 12px; background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 4px; flex-shrink: 0;
    }
    .exp-tab {
      padding: 4px 11px; font-size: 11px; border-radius: 4px; cursor: pointer;
      background: none; border: 1px solid transparent; color: var(--dim); transition: all .15s;
    }
    .exp-tab.active { background: var(--surface2); border-color: var(--border); color: var(--text); }
    .exp-tab:hover { color: var(--text); }
    .exp-note {
      padding: 7px 14px; font-size: 11px; color: var(--yellow); line-height: 1.5;
      background: rgba(220,220,170,.05); border-bottom: 1px solid rgba(220,220,170,.15);
      flex-shrink: 0;
    }
    .exp-scroll { flex: 1; overflow: auto; }
    .exp-scroll pre { margin: 0; padding: 16px; min-height: 100%; }
    .exp-scroll code { font-family: 'SF Mono', 'Fira Code', monospace !important; font-size: 12px; line-height: 1.65; }

    /* â”€â”€ History panel â”€â”€ */
    .hist-panel {
      width: 260px; flex-shrink: 0;
      background: var(--surface); border-left: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .hist-panel.hidden { display: none; }
    .hist-list { flex: 1; overflow-y: auto; }
    .hist-entry {
      padding: 10px 13px; border-bottom: 1px solid var(--border);
      cursor: pointer; transition: background .12s;
    }
    .hist-entry:hover { background: var(--surface2); }
    .hist-entry:last-child { border-bottom: none; }
    .hist-mech { display: flex; align-items: center; font-size: 11px; color: var(--text); margin-bottom: 3px; }
    .hist-msg { font-size: 11px; color: var(--dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px; }
    .hist-time { font-size: 10px; color: var(--dim); opacity: .6; }
    .hist-empty { padding: 20px 16px; color: var(--dim); font-size: 12px; text-align: center; line-height: 1.7; }

    /* â”€â”€ Spinner â”€â”€ */
    .spin {
      display: inline-block; width: 13px; height: 13px;
      border: 2px solid var(--border); border-top-color: var(--blue);
      border-radius: 50%; animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Scrollbar â”€â”€ */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
  </style>
</head>
<body>

<header class="header">
  <div class="logo">
    <div class="logo-icon">CI</div>
    <span class="logo-text">Claude Inspector</span>
    <span class="logo-sub">Prompt Mechanism Visualizer</span>
  </div>
  <div class="header-right">
    <button class="hist-btn" id="histToggleBtn" onclick="toggleHistory()" title="ìš”ì²­ íˆìŠ¤í† ë¦¬ (ìµœê·¼ 10ê°œ)">History</button>
    <select class="model-select" id="modelSel">
      <option value="claude-sonnet-4-6">claude-sonnet-4-6</option>
      <option value="claude-opus-4-6">claude-opus-4-6</option>
      <option value="claude-haiku-4-5-20251001">claude-haiku-4-5</option>
    </select>
    <div class="api-group">
      <span class="api-label">API Key</span>
      <span class="api-saved" id="apiSaved" style="display:none">ì €ì¥ë¨</span>
      <div class="api-dot" id="apiDot"></div>
      <input type="password" class="api-input" id="apiKey"
        placeholder="sk-ant-api03-â€¦  (ì…ë ¥í•˜ë©´ ìë™ ì €ì¥)"
        oninput="onApiKeyChange()">
    </div>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" data-m="claude-md"     onclick="switchM('claude-md')">    <span class="badge">MD</span> CLAUDE.md</button>
  <button class="tab"        data-m="output-style"  onclick="switchM('output-style')">  <span class="badge">ST</span> Output Style</button>
  <button class="tab"        data-m="slash-command" onclick="switchM('slash-command')"> <span class="badge">/</span>  Slash Command</button>
  <button class="tab"        data-m="skill"         onclick="switchM('skill')">         <span class="badge">SK</span> Skill</button>
  <button class="tab"        data-m="sub-agent"     onclick="switchM('sub-agent')">     <span class="badge">SA</span> Sub-Agent</button>
</nav>

<div class="main">
  <div class="config-panel">
    <div class="panel-header">
      <span id="panelTitle">Configuration</span>
      <span class="inject-chip" id="injectChip">â€”</span>
    </div>
    <div class="config-body" id="configBody"></div>
    <div class="config-footer" id="configFooter"></div>
  </div>

  <div class="preview-panel">
    <div class="preview-header">
      <div class="ptabs">
        <button class="ptab active" id="ptab-payload"  onclick="showPTab('payload')">Payload</button>
        <button class="ptab"        id="ptab-response" onclick="showPTab('response')">Response</button>
        <button class="ptab"        id="ptab-export"   onclick="showPTab('export')">Export</button>
      </div>
      <div class="pactions">
        <span class="size-pill" id="sizePill">â€” KB</span>
        <span class="live-pill" id="livePill" style="display:none"><span class="live-dot"></span>Live</span>
        <button class="copy-small" onclick="copyPayload()">Copy JSON</button>
      </div>
    </div>

    <div class="pview" id="pv-payload">
      <pre><code class="language-json" id="payloadCode">{}</code></pre>
    </div>

    <div class="pview hidden" id="pv-response">
      <div class="resp-toolbar" id="respToolbar" style="display:none">
        <span class="resp-md-label">ì‘ë‹µ ë Œë”ë§</span>
        <button class="resp-md-btn" id="mdToggleBtn" onclick="toggleMd()">MD</button>
      </div>
      <div class="resp-scroll">
        <div id="resp-view"></div>
      </div>
    </div>

    <div class="pview hidden" id="pv-export">
      <div class="exp-toolbar">
        <button class="exp-tab active" data-lang="curl"       onclick="showExportLang('curl')">cURL</button>
        <button class="exp-tab"        data-lang="python"     onclick="showExportLang('python')">Python</button>
        <button class="exp-tab"        data-lang="typescript" onclick="showExportLang('typescript')">TypeScript</button>
        <button class="copy-small" style="margin-left:auto" onclick="copyExport()">Copy</button>
      </div>
      <div id="expNote" class="exp-note" style="display:none"></div>
      <div class="exp-scroll">
        <pre><code id="exportCode" class="language-bash"></code></pre>
      </div>
    </div>
  </div>

  <div class="hist-panel hidden" id="histPanel">
    <div class="panel-header">
      <span>ìš”ì²­ íˆìŠ¤í† ë¦¬</span>
      <span style="font-size:10px;color:var(--dim)" id="histCount">0 / 10</span>
    </div>
    <div class="hist-list" id="histList">
      <div class="hist-empty">ì•„ì§ ê¸°ë¡ ì—†ìŒ<br><small>API ì „ì†¡ í›„ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤</small></div>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ Mechanism definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const M = {
  'claude-md': {
    label: 'CLAUDE.md',
    inject: 'messages[].content â†’ system-reminder',
    sendable: true,
    howHtml: `
      <div class="how-title">âš¡ Claude Codeì—ì„œ ì‹¤ì œ ë™ì‘</div>
      <div class="how-text">
        í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— <code>CLAUDE.md</code>ê°€ ìˆìœ¼ë©´ Claude Codeê°€
        <strong>ëª¨ë“  ìš”ì²­</strong>ì— ìë™ìœ¼ë¡œ <code>&lt;system-reminder&gt;</code> íƒœê·¸ë¡œ ì£¼ì….
        ì„¤ì • ë¶ˆí•„ìš” â€” íŒŒì¼ ì¡´ì¬ë§Œìœ¼ë¡œ ë™ì‘.
      </div>
      <div class="example-row">
        <span class="ex-tag">ì˜ˆì‹œ</span>
        <span>íŒ€ ì½”ë”© ìŠ¤íƒ ë‹¤ë“œ, ì•„í‚¤í…ì²˜ ê²°ì •, ê¸°ìˆ  ìŠ¤íƒ ì •ë³´ë¥¼ ì ì–´ë‘ë©´ ëª¨ë“  íŒ€ì›ì˜ ìš”ì²­ì— ìë™ ì ìš©ë¨</span>
      </div>
      <div class="example-row">
        <span class="ex-tag">ë ˆì´ì–´</span>
        <span>ë©”ì‹œì§€ ë ˆë²¨ (system ì•„ë‹˜) â€” í”„ë¡œì íŠ¸ <em>ì»¨í…ìŠ¤íŠ¸</em>ì§€ Claudeì˜ <em>ì •ì²´ì„±</em>ì´ ì•„ë‹˜</span>
      </div>`,
    fields: [
      { id:'content', label:'CLAUDE.md ë‚´ìš©', type:'textarea', tall:true, fileBtn:true,
        val:`# Project Standards\n\n## Tech Stack\n- TypeScript (strict mode)\n- Bun runtime\n- React + Vite frontend\n\n## Conventions\n- Named exports only\n- File naming: kebab-case\n- Write tests for all features\n- No console.log in production` },
      { id:'userMessage', label:'User Message', type:'textarea',
        val:'How should I structure my TypeScript project?' }
    ]
  },

  'output-style': {
    label: 'Output Style',
    inject: 'system[] â†’ additional text block',
    sendable: true,
    howHtml: `
      <div class="how-title">âš¡ Claude Codeì—ì„œ ì‹¤ì œ ë™ì‘</div>
      <div class="how-text">
        <code>/output-style software-architect</code> ì‹¤í–‰ ì‹œ
        <code>system</code> ë°°ì—´ì— ìŠ¤íƒ€ì¼ ë¸”ë¡ì´ ì¶”ê°€ë¨.
        ì„¸ì…˜ì´ ëë‚  ë•Œê¹Œì§€ <strong>ëª¨ë“  ì‘ë‹µ</strong>ì— ì ìš©.
      </div>
      <div class="example-row">
        <span class="ex-tag">ì˜ˆì‹œ</span>
        <span>ì½”ë“œ ë¦¬ë·° ì„¸ì…˜ ì‹œì‘ ì „ "senior engineer" ìŠ¤íƒ€ì¼ ì„¤ì • â†’ ì´í›„ ëª¨ë“  ë‹µë³€ì´ ì•„í‚¤í…ì²˜ ê´€ì ìœ¼ë¡œ ë³€í•¨</span>
      </div>
      <div class="example-row">
        <span class="ex-tag">ë ˆì´ì–´</span>
        <span>ì‹œìŠ¤í…œ ë ˆë²¨ â€” CLAUDE.md(ë©”ì‹œì§€)ì™€ ë‹¬ë¦¬ Claudeì˜ <em>ì •ì²´ì„±/í–‰ë™</em>ì„ ë³€ê²½</span>
      </div>`,
    fields: [
      { id:'name', label:'ìŠ¤íƒ€ì¼ ì´ë¦„', type:'input', val:'software-architect' },
      { id:'content', label:'ìŠ¤íƒ€ì¼ ì§€ì¹¨', type:'textarea', tall:true,
        val:`You are operating as a senior software architect.\n\n## Response Guidelines\n- Lead with architectural decisions, not implementation details\n- Highlight trade-offs explicitly\n- Reference design patterns by name (Factory, Observer, CQRS)\n- Keep responses concise but precise` },
      { id:'userMessage', label:'User Message', type:'textarea',
        val:'Should I use Redux or React Context for state management?' }
    ]
  },

  'slash-command': {
    label: 'Slash Command',
    inject: 'messages[].content â†’ command-message',
    sendable: true,
    howHtml: `
      <div class="how-title">âš¡ Claude Codeì—ì„œ ì‹¤ì œ ë™ì‘</div>
      <div class="how-text">
        <code>.claude/commands/review.md</code> íŒŒì¼ ìƒì„± â†’
        <code>/review @file.js</code> ì…ë ¥ ì‹œ <code>{arg1}</code>ì´ ì¸ìˆ˜ë¡œ ì¹˜í™˜.
        <strong>Claudeê°€ ê²°ì •í•˜ëŠ” ê²Œ ì•„ë‹˜</strong> â€” ìˆœìˆ˜ ë¬¸ìì—´ ì¹˜í™˜.
      </div>
      <div class="example-row">
        <span class="ex-tag">ì˜ˆì‹œ</span>
        <span>ì½”ë“œ ë¦¬ë·°, PR ì²´í¬ë¦¬ìŠ¤íŠ¸, ë°°í¬ ì ˆì°¨ ë“± ë°˜ë³µ ì‘ì—…ì„ ëª…ì‹œì ìœ¼ë¡œ ì‹¤í–‰í•  ë•Œ</span>
      </div>
      <div class="example-row">
        <span class="ex-tag">vs Skill</span>
        <span>Slash CommandëŠ” <em>ì‚¬ìš©ìê°€ ì§ì ‘ í˜¸ì¶œ</em>, Skillì€ <em>Claudeê°€ ììœ¨ íŒë‹¨</em></span>
      </div>`,
    fields: [
      { id:'name', label:'ì»¤ë§¨ë“œ ì´ë¦„', type:'input', val:'review' },
      { id:'template', label:'ì»¤ë§¨ë“œ í…œí”Œë¦¿ ({arg1} ì¹˜í™˜)', type:'textarea', tall:true,
        val:`Perform a thorough code review of the following code:\n\n{arg1}\n\nFocus on:\n1. Logic errors and off-by-one bugs\n2. Security vulnerabilities\n3. Performance issues\n4. Code clarity and naming` },
      { id:'args', label:'ì¸ìˆ˜ ({arg1} ëŒ€ì²´ê°’)', type:'textarea',
        val:`function calculateTotal(items) {\n  let total = 0;\n  for (var i = 0; i <= items.length; i++) {\n    total += items[i].price;\n  }\n  return total;\n}` }
    ]
  },

  'skill': {
    label: 'Skill',
    inject: 'tool_result (Skill tool_use ì´í›„)',
    sendable: false, simulatable: true,
    howHtml: `
      <div class="how-title">âš¡ Claude Codeì—ì„œ ì‹¤ì œ ë™ì‘ (2ë‹¨ê³„)</div>
      <div class="flow">
        <div class="flow-step">ì‚¬ìš©ì: "git squash ì–´ë–»ê²Œ í•´?"</div>
        <div class="flow-arrow">â†“ description í•„ë“œì™€ ì‹œë§¨í‹± ë§¤ì¹­</div>
        <div class="flow-step hi-purple">ë§¤ì¹­ ì„±ê³µ â†’ tool_use: Skill { command: "git-helper" }</div>
        <div class="flow-arrow">â†“ SKILL.md ì „ì²´ ë‚´ìš© ì£¼ì…</div>
        <div class="flow-step hi-purple">tool_result: [ìŠ¤í‚¬ ë‚´ìš©]</div>
        <div class="flow-arrow">â†“</div>
        <div class="flow-step">Claude: ìŠ¤í‚¬ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‘ë‹µ</div>
      </div>
      <div class="warn-row" style="margin-top:6px">
        <span class="w-icon">âš ï¸</span>
        <span><strong>descriptionì´ ë¶€ì •í™•í•˜ë©´ ë§¤ì¹­ ì‹¤íŒ¨.</strong> "git, squash, commits, rebase" ê°™ì´ í‚¤ì›Œë“œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë‚˜ì—´í•´ì•¼ í•¨.</span>
      </div>
      <div class="example-row">
        <span class="ex-tag">â–¶ Simulate</span>
        <span>ì‹¤ì œ APIë¡œ ìŠ¤í‚¬ íš¨ê³¼ë¥¼ í™•ì¸ (ìŠ¤í‚¬ ë‚´ìš©ì„ systemì— ì£¼ì…í•˜ëŠ” ë‹¨ìˆœí™” ë²„ì „)</span>
      </div>`,
    fields: [
      { id:'name', label:'ìŠ¤í‚¬ ì´ë¦„', type:'input', val:'git-helper' },
      { id:'description', label:'ë§¤ì¹­ì— ì‚¬ìš©í•  description', type:'input',
        val:'Git workflows, commits, branches, rebasing, squashing, version control' },
      { id:'content', label:'ìŠ¤í‚¬ ë‚´ìš© (SKILL.md ë³¸ë¬¸)', type:'textarea', tall:true, fileBtn:true,
        val:`# Git Helper\n\nWhen invoked:\n1. Analyze the git-related request\n2. Provide exact commands with explanations\n3. Warn about destructive operations (reset --hard, force push)\n4. Suggest safe alternatives\n\nAlways include:\n- The exact git command(s)\n- What each command does\n- Any potential risks` },
      { id:'userMessage', label:'User Message (ìŠ¤í‚¬ íŠ¸ë¦¬ê±°)', type:'textarea',
        val:'How do I squash my last 3 commits?' }
    ]
  },

  'sub-agent': {
    label: 'Sub-Agent',
    inject: 'ê²©ë¦¬ëœ ë³„ë„ API í˜¸ì¶œ (Task ë„êµ¬)',
    sendable: false, simulatable: true,
    howHtml: `
      <div class="how-title">âš¡ Claude Codeì—ì„œ ì‹¤ì œ ë™ì‘ (API 2ë²ˆ í˜¸ì¶œ)</div>
      <div class="flow">
        <div class="flow-api-label">API Call #1 â€” ë©”ì¸ ëŒ€í™”</div>
        <div class="flow-step">ì‚¬ìš©ì: "auth êµ¬í˜„ ë¶„ì„í•´ì¤˜"</div>
        <div class="flow-arrow">â†“ Claudeê°€ ë³µì¡í•œ ì‘ì—…ìœ¼ë¡œ íŒë‹¨</div>
        <div class="flow-step hi-orange">tool_use: Task { subagent_type: "Explore", prompt: "â€¦" }</div>
        <hr class="flow-divider">
        <div class="flow-api-label">API Call #2 â€” Sub-Agent (ì™„ì „ ê²©ë¦¬)</div>
        <div class="flow-step hi-yellow">âš ï¸ ë©”ì¸ ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ì—†ìŒ</div>
        <div class="flow-step">âœ… CLAUDE.mdëŠ” ì—¬ì „íˆ ì£¼ì…ë¨</div>
        <div class="flow-step">Explore ì—ì´ì „íŠ¸ê°€ ììœ¨ì ìœ¼ë¡œ íƒìƒ‰/ë¶„ì„</div>
        <div class="flow-arrow">â†“ ê²°ê³¼ ë°˜í™˜</div>
        <div class="flow-api-label">ë‹¤ì‹œ API Call #1</div>
        <div class="flow-step hi-orange">tool_result: [sub-agent ë¶„ì„ ê²°ê³¼]</div>
        <div class="flow-step">Claude: ê²°ê³¼ ì¢…í•©í•˜ì—¬ ì‘ë‹µ</div>
      </div>
      <div class="warn-row" style="margin-top:6px">
        <span class="w-icon">âš ï¸</span>
        <span><strong>ì»¨í…ìŠ¤íŠ¸ ë¸Œë¦¬ì§• ì—†ìŒ.</strong> delegation promptì— í•„ìš”í•œ ëª¨ë“  ì •ë³´ë¥¼ ëª…ì‹œí•´ì•¼ í•¨.</span>
      </div>
      <div class="example-row">
        <span class="ex-tag">â–¶ Run</span>
        <span>Sub-Agent ëŒ€í™”ë§Œ ë‹¨ë… ì‹¤í–‰í•˜ì—¬ delegation prompt íš¨ê³¼ í™•ì¸</span>
      </div>`,
    fields: [
      { id:'type', label:'Sub-Agent íƒ€ì…', type:'select',
        options:['Explore','general-purpose','Plan','software-architect'], val:'Explore' },
      { id:'prompt', label:'Delegation Prompt (sub-agentì—ê²Œ ì „ë‹¬)', type:'textarea', tall:true,
        val:`Analyze the authentication flow in this codebase.\n\nContext: OAuth 2.0 with PKCE, Next.js application.\n\nFocus on:\n1. Token storage mechanisms\n2. Refresh token rotation logic\n3. Background token refresh handling\n\nReport back with a structured summary.` },
      { id:'userMessage', label:'User Message (ë©”ì¸ ëŒ€í™” íŠ¸ë¦¬ê±°)', type:'textarea',
        val:'Analyze our authentication implementation for security issues.' }
    ]
  }
};

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let current = 'claude-md';
let lastResponseText = '';
let mdEnabled = false;
let exportLang = 'curl';
let sessionHistory = [];

// â”€â”€â”€ Payload builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPayload(mech, cfg) {
  const sys = "You are Claude Code, Anthropic's official CLI for Claude.";
  const model = document.getElementById('modelSel').value;
  const msg = cfg.userMessage || '';

  if (mech === 'claude-md') {
    return {
      model, max_tokens: 1024, system: sys,
      messages: [{ role: 'user', content: [{ type: 'text',
        text: `<system-reminder>\nAs you answer the user's questions, you can use the following context:\n# claudeMd\nCodebase and user instructions are shown below. Be sure to adhere to these instructions. IMPORTANT: These instructions OVERRIDE any default behavior and you MUST follow them exactly as written.\n\nContents of /path/to/CLAUDE.md (project instructions, checked into the codebase):\n\n${cfg.content || ''}\n</system-reminder>\n\n${msg}`
      }] }]
    };
  }
  if (mech === 'output-style') {
    return {
      model, max_tokens: 1024,
      system: [
        { type: 'text', text: sys },
        { type: 'text', text: `# Output Style: ${cfg.name || 'custom'}\n\n${cfg.content || ''}` }
      ],
      messages: [{ role: 'user', content: msg }]
    };
  }
  if (mech === 'slash-command') {
    const expanded = (cfg.template || '').replace(/\{arg1\}/g, cfg.args || '');
    return {
      model, max_tokens: 1024, system: sys,
      messages: [{ role: 'user', content: [{ type: 'text',
        text: `<command-message>${cfg.name || 'command'} is runningâ€¦</command-message>\n\n${expanded}${cfg.args ? `\n\nARGUMENTS: ${cfg.args}` : ''}`
      }] }]
    };
  }
  if (mech === 'skill') {
    return {
      model, max_tokens: 1024, system: sys,
      messages: [
        { role: 'user', content: msg },
        { role: 'assistant', content: [{ type: 'tool_use', id: 'toolu_skill_01', name: 'Skill', input: { command: cfg.name || 'skill-name' } }] },
        { role: 'user',      content: [{ type: 'tool_result', tool_use_id: 'toolu_skill_01', content: cfg.content || '' }] }
      ]
    };
  }
  if (mech === 'sub-agent') {
    return {
      'âš¡ API Call #1 â€” Main Conversation': {
        model, max_tokens: 1024, system: sys,
        messages: [
          { role: 'user', content: msg },
          { role: 'assistant', content: [{ type: 'tool_use', id: 'toolu_task_01', name: 'Task',
              input: { subagent_type: cfg.type || 'Explore', prompt: cfg.prompt || '' } }] }
        ]
      },
      'ğŸ¤– API Call #2 â€” Sub-Agent (Isolated)': {
        model, max_tokens: 2048,
        system: `[${cfg.type || 'Explore'} specialized system prompt]\nâš ï¸  No main conversation context\nâœ… CLAUDE.md injected here too`,
        messages: [{ role: 'user', content: cfg.prompt || '' }]
      }
    };
  }
  return {};
}

// â”€â”€â”€ Sendable payload (for Export + simulate calls) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSendablePayload(mech, cfg) {
  const model = document.getElementById('modelSel').value;
  if (mech === 'skill') {
    return {
      model, max_tokens: 1024,
      system: [
        { type: 'text', text: "You are Claude Code, Anthropic's official CLI for Claude." },
        { type: 'text', text: `# Active Skill: ${cfg.name}\n\nDescription: ${cfg.description}\n\n${cfg.content}` }
      ],
      messages: [{ role: 'user', content: cfg.userMessage || '' }]
    };
  }
  if (mech === 'sub-agent') {
    return {
      model, max_tokens: 1024,
      system: `You are a ${cfg.type || 'general-purpose'} sub-agent. You operate in an isolated conversation with no access to the main conversation history.`,
      messages: [{ role: 'user', content: cfg.prompt || '' }]
    };
  }
  return buildPayload(mech, cfg);
}

// â”€â”€â”€ Collect config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function collectCfg() {
  const cfg = {};
  for (const f of M[current].fields) {
    const el = document.getElementById('f-' + f.id);
    cfg[f.id] = el ? el.value : (f.val || '');
  }
  return cfg;
}

// â”€â”€â”€ Update preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePreview() {
  const cfg = collectCfg();
  const payload = buildPayload(current, cfg);
  const json = JSON.stringify(payload, null, 2);
  const code = document.getElementById('payloadCode');
  code.textContent = json;
  hljs.highlightElement(code);

  // Size + token estimate
  const bytes = new TextEncoder().encode(JSON.stringify(payload)).length;
  const kb = (bytes / 1024).toFixed(1);
  const tokens = Math.ceil(bytes / 3.5);
  document.getElementById('sizePill').textContent = `${kb} KB Â· ~${tokens.toLocaleString()} tok`;

  // Update export tab if visible
  if (!document.getElementById('pv-export').classList.contains('hidden')) {
    updateExport(current, cfg);
  }
}

// â”€â”€â”€ Render form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderForm(mech) {
  const def = M[mech];
  document.getElementById('panelTitle').textContent = def.label;
  document.getElementById('injectChip').textContent = def.inject;

  let html = `<div class="how-box">${def.howHtml}</div>`;

  for (const f of def.fields) {
    const fileBtnHtml = f.fileBtn
      ? `<button class="file-btn" onclick="openFilePicker('f-${f.id}')">ğŸ“‚ íŒŒì¼ ì—´ê¸°</button>`
      : '';

    if (f.type === 'textarea') {
      html += `<div class="field"><label><span>${f.label}</span>${fileBtnHtml}</label>
        <textarea id="f-${f.id}" class="${f.tall?'tall':''}" oninput="updatePreview()">${esc(f.val||'')}</textarea></div>`;
    } else if (f.type === 'input') {
      html += `<div class="field"><label><span>${f.label}</span>${fileBtnHtml}</label>
        <input type="text" id="f-${f.id}" value="${esc(f.val||'')}" oninput="updatePreview()"></div>`;
    } else if (f.type === 'select') {
      const opts = (f.options||[]).map(o=>`<option${o===f.val?' selected':''}>${o}</option>`).join('');
      html += `<div class="field"><label><span>${f.label}</span></label>
        <select id="f-${f.id}" onchange="updatePreview()">${opts}</select></div>`;
    }
  }

  document.getElementById('configBody').innerHTML = html;

  // Footer
  const footer = document.getElementById('configFooter');
  const copyBtn = `<button class="btn btn-copy" onclick="copyPayload()">Copy JSON</button>`;
  if (def.sendable) {
    footer.innerHTML = copyBtn +
      `<button class="btn btn-send" id="actionBtn" onclick="sendToApi()">Send to Claude â†’</button>`;
  } else if (mech === 'skill') {
    footer.innerHTML = copyBtn +
      `<button class="btn btn-sim" id="actionBtn" onclick="simulateSkill()">â–¶ Simulate Effect</button>`;
  } else if (mech === 'sub-agent') {
    footer.innerHTML = copyBtn +
      `<button class="btn btn-sa" id="actionBtn" onclick="simulateSubAgent()">â–¶ Run Sub-Agent</button>`;
  }
}

// â”€â”€â”€ Switch mechanism â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchM(mech) {
  current = mech;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.m === mech));
  renderForm(mech);
  updatePreview();
  showPTab('payload');
  document.getElementById('livePill').style.display = 'none';
  document.getElementById('respToolbar').style.display = 'none';
  document.getElementById('resp-view').innerHTML = '';
}

// â”€â”€â”€ Preview tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPTab(tab) {
  ['payload', 'response', 'export'].forEach(t => {
    document.getElementById('pv-' + t).classList.toggle('hidden', t !== tab);
    document.getElementById('ptab-' + t).classList.toggle('active', t === tab);
  });
  if (tab === 'export') {
    const cfg = collectCfg();
    updateExport(current, cfg);
  }
}

// â”€â”€â”€ Copy payload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyPayload() {
  const text = document.getElementById('payloadCode').textContent;
  navigator.clipboard.writeText(text).then(() => {
    document.querySelectorAll('.btn-copy, [onclick="copyPayload()"]').forEach(b => {
      const o = b.textContent; b.textContent = 'âœ“ Copied';
      setTimeout(() => { b.textContent = o; }, 1500);
    });
  });
}

// â”€â”€â”€ Core send function â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callApi(payload, loadingMsg = 'Sendingâ€¦') {
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) {
    const inp = document.getElementById('apiKey');
    inp.focus(); inp.style.borderColor = 'var(--red)';
    setTimeout(() => { inp.style.borderColor = ''; }, 2000);
    return false;
  }

  const btn = document.getElementById('actionBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = `<span class="spin"></span> ${loadingMsg}`; }

  document.getElementById('resp-view').innerHTML =
    `<div style="color:var(--dim);padding-top:4px"><span class="spin"></span> ${loadingMsg}</div>`;
  document.getElementById('respToolbar').style.display = 'none';
  showPTab('response');

  try {
    const data = await window.electronAPI.sendToClaude(payload, apiKey);

    if (data.error) {
      document.getElementById('resp-view').innerHTML =
        `<div class="resp-err">Error: ${esc(data.error)}</div>`;
    } else if (data.response) {
      const r = data.response;
      const text = r.content?.filter(c => c.type === 'text').map(c => c.text).join('\n') || '(no text)';
      lastResponseText = text;
      const u = r.usage;
      const meta = u ? `
        <div class="resp-meta">
          <div class="resp-stat"><span>Model </span><b>${r.model}</b></div>
          <div class="resp-stat"><span>Input </span><b>${u.input_tokens.toLocaleString()} tok</b></div>
          <div class="resp-stat"><span>Output </span><b>${u.output_tokens.toLocaleString()} tok</b></div>
          <div class="resp-stat"><span>Stop </span><b>${r.stop_reason}</b></div>
        </div>` : '';
      document.getElementById('resp-view').innerHTML =
        `<div class="resp-text" id="respText"></div>
         <button class="resp-copy" onclick="copyResponse()">Copy Response</button>
         ${meta}`;
      renderResponseContent(text);
      document.getElementById('respToolbar').style.display = 'flex';
      document.getElementById('livePill').style.display = 'flex';
      saveHistory(current, collectCfg());
    }
    return true;
  } catch (e) {
    document.getElementById('resp-view').innerHTML =
      `<div class="resp-err">Network error: ${esc(e.message)}</div>`;
    return false;
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = btn.className.includes('btn-send') ? 'Send to Claude â†’'
                    : btn.className.includes('btn-sim') ? 'â–¶ Simulate Effect'
                    : 'â–¶ Run Sub-Agent';
    }
  }
}

// â”€â”€â”€ Send (direct mechanisms) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendToApi() {
  const cfg = collectCfg();
  callApi(buildPayload(current, cfg));
}

// â”€â”€â”€ Simulate Skill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function simulateSkill() {
  const cfg = collectCfg();
  callApi(buildSendablePayload('skill', cfg), 'Simulating skillâ€¦');
}

// â”€â”€â”€ Simulate Sub-Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function simulateSubAgent() {
  const cfg = collectCfg();
  callApi(buildSendablePayload('sub-agent', cfg), `Running ${cfg.type || 'Explore'} sub-agentâ€¦`);
}

// â”€â”€â”€ Copy response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyResponse() {
  navigator.clipboard.writeText(lastResponseText).then(() => {
    const btn = document.querySelector('.resp-copy');
    if (btn) { btn.textContent = 'âœ“ Copied'; setTimeout(() => { btn.textContent = 'Copy Response'; }, 1500); }
  });
}

// â”€â”€â”€ Markdown toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResponseContent(text) {
  const container = document.getElementById('respText');
  if (!container) return;
  if (mdEnabled && typeof marked !== 'undefined') {
    container.innerHTML = marked.parse(text);
    container.className = 'resp-text md-rendered';
  } else {
    container.textContent = text;
    container.className = 'resp-text';
  }
}

function toggleMd() {
  mdEnabled = !mdEnabled;
  const btn = document.getElementById('mdToggleBtn');
  if (btn) btn.classList.toggle('active', mdEnabled);
  renderResponseContent(lastResponseText);
}

// â”€â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateCurl(payload) {
  const body = JSON.stringify(payload, null, 2).replace(/'/g, "'\\''");
  return `curl https://api.anthropic.com/v1/messages \\
  -H "x-api-key: $ANTHROPIC_API_KEY" \\
  -H "anthropic-version: 2023-06-01" \\
  -H "content-type: application/json" \\
  -d '${body}'`;
}

function generatePython(payload) {
  const json = JSON.stringify(payload, null, 2);
  return `import json, anthropic

client = anthropic.Anthropic()

payload = json.loads("""
${json}
""")

response = client.messages.create(**payload)
print(response.content[0].text)`;
}

function generateTypeScript(payload) {
  const obj = JSON.stringify(payload, null, 2);
  return `import Anthropic from "@anthropic-ai/sdk";

const client = new Anthropic();

const response = await client.messages.create(${obj});

console.log(response.content[0].text);`;
}

function updateExport(mech, cfg) {
  const code = document.getElementById('exportCode');
  if (!code) return;

  const payload = buildSendablePayload(mech, cfg);

  // Note for skill/sub-agent
  const note = document.getElementById('expNote');
  if (note) {
    if (mech === 'skill') {
      note.style.display = 'block';
      note.textContent = 'âš ï¸  Skillì€ tool_use í”Œë¡œìš°ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” Simulate Effect (system ì£¼ì… ë²„ì „)ì˜ ì‹¤í–‰ ê°€ëŠ¥í•œ í˜ì´ë¡œë“œì…ë‹ˆë‹¤.';
    } else if (mech === 'sub-agent') {
      note.style.display = 'block';
      note.textContent = 'âš ï¸  Sub-AgentëŠ” 2ê°œì˜ API í˜¸ì¶œì„ ìƒì„±í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” API Call #2 (ê²©ë¦¬ëœ ì„œë¸Œì—ì´ì „íŠ¸)ì˜ ë‹¨ë… ì‹¤í–‰ í˜ì´ë¡œë“œì…ë‹ˆë‹¤.';
    } else {
      note.style.display = 'none';
    }
  }

  let text = '';
  if (exportLang === 'curl') {
    text = generateCurl(payload);
    code.className = 'language-bash';
  } else if (exportLang === 'python') {
    text = generatePython(payload);
    code.className = 'language-python';
  } else {
    text = generateTypeScript(payload);
    code.className = 'language-typescript';
  }

  code.textContent = text;
  hljs.highlightElement(code);
}

function showExportLang(lang) {
  exportLang = lang;
  document.querySelectorAll('.exp-tab').forEach(b => {
    b.classList.toggle('active', b.dataset.lang === lang);
  });
  const cfg = collectCfg();
  updateExport(current, cfg);
}

function copyExport() {
  const code = document.getElementById('exportCode');
  if (!code) return;
  navigator.clipboard.writeText(code.textContent).then(() => {
    const btns = document.querySelectorAll('[onclick="copyExport()"]');
    btns.forEach(b => {
      const o = b.textContent; b.textContent = 'âœ“';
      setTimeout(() => { b.textContent = o; }, 1500);
    });
  });
}

// â”€â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BADGE_STYLES = {
  'claude-md':    { bg: 'var(--green)',  color: '#000', label: 'MD' },
  'output-style': { bg: 'var(--blue)',   color: '#000', label: 'ST' },
  'slash-command':{ bg: 'var(--yellow)', color: '#000', label: '/'  },
  'skill':        { bg: 'var(--purple)', color: '#fff', label: 'SK' },
  'sub-agent':    { bg: 'var(--orange)', color: '#000', label: 'SA' },
};

function mechBadge(mech) {
  const s = BADGE_STYLES[mech] || { bg: 'var(--border)', color: 'var(--text)', label: '?' };
  return `<span style="background:${s.bg};color:${s.color};border-radius:3px;padding:1px 5px;font-size:9px;font-weight:700;margin-right:5px;font-family:'SF Mono',monospace">${s.label}</span>`;
}

function saveHistory(mech, cfg) {
  const def = M[mech];
  const userMsg = (cfg.userMessage || cfg.prompt || '').trim();
  const entry = {
    id: Date.now(),
    ts: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
    mech,
    mechLabel: def.label,
    userMsg: userMsg.slice(0, 60) + (userMsg.length > 60 ? 'â€¦' : ''),
    cfg: JSON.parse(JSON.stringify(cfg)),
  };
  sessionHistory.unshift(entry);
  if (sessionHistory.length > 10) sessionHistory.pop();
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById('histList');
  const countEl = document.getElementById('histCount');
  if (!list) return;
  if (countEl) countEl.textContent = `${sessionHistory.length} / 10`;
  if (sessionHistory.length === 0) {
    list.innerHTML = '<div class="hist-empty">ì•„ì§ ê¸°ë¡ ì—†ìŒ<br><small>API ì „ì†¡ í›„ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤</small></div>';
    return;
  }
  list.innerHTML = sessionHistory.map(e => `
    <div class="hist-entry" onclick="restoreHistory(${e.id})">
      <div class="hist-mech">${mechBadge(e.mech)}<span>${esc(e.mechLabel)}</span></div>
      <div class="hist-msg">${e.userMsg ? esc(e.userMsg) : '<em style="opacity:.5">ë©”ì‹œì§€ ì—†ìŒ</em>'}</div>
      <div class="hist-time">${e.ts}</div>
    </div>
  `).join('');
}

function restoreHistory(id) {
  const entry = sessionHistory.find(e => e.id === id);
  if (!entry) return;
  switchM(entry.mech);
  for (const [k, v] of Object.entries(entry.cfg)) {
    const el = document.getElementById('f-' + k);
    if (el) el.value = v;
  }
  updatePreview();
}

function toggleHistory() {
  const panel = document.getElementById('histPanel');
  const btn = document.getElementById('histToggleBtn');
  const isHidden = panel.classList.contains('hidden');
  panel.classList.toggle('hidden', !isHidden);
  btn.classList.toggle('active', isHidden);
}

// â”€â”€â”€ File picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openFilePicker(fieldId) {
  if (!window.electronAPI || !window.electronAPI.openFile) {
    alert('íŒŒì¼ ì—´ê¸°ëŠ” Electron ì•±ì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤.');
    return;
  }
  const content = await window.electronAPI.openFile();
  if (content !== null && content !== undefined) {
    const el = document.getElementById(fieldId);
    if (el) { el.value = content; updatePreview(); }
  }
}

// â”€â”€â”€ API key (with localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onApiKeyChange() {
  const v = document.getElementById('apiKey').value;
  localStorage.setItem('ci-api-key', v);
  const ok = v.trim().startsWith('sk-ant');
  document.getElementById('apiDot').className = 'api-dot' + (ok ? ' ok' : '');
  document.getElementById('apiSaved').style.display = v.trim() ? 'inline' : 'none';
}

// â”€â”€â”€ Util â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('modelSel').addEventListener('change', updatePreview);

const savedKey = localStorage.getItem('ci-api-key');
if (savedKey) {
  document.getElementById('apiKey').value = savedKey;
  onApiKeyChange();
}

switchM('claude-md');
</script>
</body>
</html>
