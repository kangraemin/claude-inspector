<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Inspector</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js"></script>
  <style>
    :root {
      --bg: #1e1e1e; --surface: #252526; --surface2: #2d2d2d;
      --border: #3e3e42; --text: #d4d4d4; --dim: #858585;
      --blue: #569cd6; --green: #4ec9b0; --yellow: #dcdcaa;
      --red: #f48771; --purple: #c586c0; --orange: #ce9178;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg); color: var(--text);
      height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px; height: 50px;
      background: var(--surface); border-bottom: 1px solid var(--border);
      flex-shrink: 0; gap: 12px;
    }
    /* â”€â”€ Window drag (macOS hiddenInset) â”€â”€ */
    .header { -webkit-app-region: drag; }
    .header-right, .header-right *, .logo { -webkit-app-region: no-drag; }
    body.darwin .header { padding-left: 76px; }

    .logo { display: flex; align-items: center; gap: 9px; }
    .logo-icon {
      width: 28px; height: 28px;
      background: linear-gradient(135deg, #569cd6, #c586c0);
      border-radius: 6px; display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 800; color: #fff; letter-spacing: -.5px;
    }
    .logo-text { font-size: 15px; font-weight: 700; }
    .logo-sub { font-size: 11px; color: var(--dim); }
    .header-right { display: flex; align-items: center; gap: 8px; }
    .model-select {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text);
      padding: 4px 8px; font-size: 12px; outline: none; cursor: pointer;
    }
    .api-group { display: flex; align-items: center; gap: 6px; }
    .api-label { font-size: 11px; color: var(--dim); }
    .api-saved {
      font-size: 10px; padding: 2px 6px; border-radius: 10px;
      background: rgba(78,201,176,.15); color: var(--green);
      border: 1px solid rgba(78,201,176,.3);
    }
    .api-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); transition: background .2s; }
    .api-dot.ok { background: var(--green); }
    .api-input {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text);
      padding: 5px 10px; font-size: 12px; width: 240px;
      font-family: 'SF Mono', monospace; outline: none; transition: border-color .15s;
    }
    .api-input:focus { border-color: var(--blue); }

    /* â”€â”€ History toggle button â”€â”€ */
    .hist-btn {
      padding: 4px 10px; border-radius: 5px; font-size: 11px;
      background: none; border: 1px solid var(--border);
      color: var(--dim); cursor: pointer; transition: all .15s; white-space: nowrap;
    }
    .hist-btn:hover { color: var(--text); border-color: var(--blue); }
    .hist-btn.active { color: var(--blue); border-color: var(--blue); background: rgba(86,156,214,.08); }

    /* â”€â”€ Tabs â”€â”€ */
    .tabs {
      display: flex; background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 12px; gap: 2px; flex-shrink: 0;
    }
    .tab {
      display: flex; align-items: center; gap: 7px;
      padding: 10px 16px; cursor: pointer;
      background: none; border: none; color: var(--dim); font-size: 13px;
      border-bottom: 2px solid transparent;
      transition: color .15s, border-color .15s; white-space: nowrap;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--text); border-bottom-color: var(--blue); }
    .badge {
      font-size: 10px; font-weight: 700;
      padding: 2px 6px; border-radius: 3px; font-family: 'SF Mono', monospace;
    }
    .tab[data-m="claude-md"]    .badge { background: var(--green);  color: #000; }
    .tab[data-m="output-style"] .badge { background: var(--blue);   color: #000; }
    .tab[data-m="slash-command"].badge { background: var(--yellow); color: #000; }
    .tab[data-m="skill"]        .badge { background: var(--purple); color: #fff; }
    .tab[data-m="sub-agent"]    .badge { background: var(--orange); color: #000; }
    .tab[data-m="proxy"]        .badge { background: var(--red);    color: #fff; }

    /* â”€â”€ Layout â”€â”€ */
    .main { display: flex; flex: 1; overflow: hidden; }

    /* â”€â”€ Left: Config â”€â”€ */
    .config-panel {
      width: 400px; flex-shrink: 0;
      background: var(--surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .panel-header {
      padding: 9px 14px; font-size: 11px; text-transform: uppercase;
      letter-spacing: .8px; color: var(--dim);
      border-bottom: 1px solid var(--border); flex-shrink: 0;
      display: flex; align-items: center; justify-content: space-between;
    }
    .inject-chip {
      font-size: 10px; padding: 2px 7px; border-radius: 10px;
      background: rgba(86,156,214,.12); color: var(--blue);
      border: 1px solid rgba(86,156,214,.25);
      text-transform: none; letter-spacing: 0; font-family: 'SF Mono', monospace;
    }
    .config-body {
      flex: 1; overflow-y: auto; padding: 13px;
      display: flex; flex-direction: column; gap: 11px;
    }
    .field { display: flex; flex-direction: column; gap: 5px; }
    .field label {
      font-size: 11px; color: var(--dim); font-weight: 600;
      text-transform: uppercase; letter-spacing: .5px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .field input, .field textarea, .field select {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text);
      padding: 6px 10px; font-size: 12px;
      font-family: 'SF Mono', monospace; outline: none;
      transition: border-color .15s; resize: vertical;
    }
    .field input:focus, .field textarea:focus, .field select:focus { border-color: var(--blue); }
    .field textarea { min-height: 80px; }
    .field textarea.tall { min-height: 120px; }

    /* â”€â”€ File button â”€â”€ */
    .file-btn {
      padding: 2px 8px; border-radius: 4px; font-size: 10px;
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--dim); cursor: pointer; transition: all .15s;
      text-transform: none; letter-spacing: 0; font-weight: normal;
    }
    .file-btn:hover { color: var(--text); border-color: var(--blue); }

    /* â”€â”€ How-it-works box â”€â”€ */
    .how-box {
      background: rgba(86,156,214,.05); border: 1px solid rgba(86,156,214,.18);
      border-radius: 7px; padding: 11px 13px;
      display: flex; flex-direction: column; gap: 8px;
    }
    .how-title { font-size: 10px; font-weight: 700; color: var(--blue); text-transform: uppercase; letter-spacing: .7px; }
    .how-text { font-size: 12px; color: var(--dim); line-height: 1.55; }
    .how-text code {
      background: var(--surface2); padding: 1px 4px; border-radius: 3px;
      font-family: 'SF Mono', monospace; font-size: 11px; color: var(--text);
    }
    .example-row { display: flex; align-items: flex-start; gap: 6px; font-size: 11px; color: var(--dim); line-height: 1.45; }
    .example-row .ex-tag {
      flex-shrink: 0; background: rgba(78,201,176,.12); color: var(--green);
      border: 1px solid rgba(78,201,176,.25); border-radius: 4px;
      font-size: 10px; font-weight: 700; padding: 1px 5px;
    }
    .warn-row { display: flex; align-items: flex-start; gap: 6px; font-size: 11px; color: var(--yellow); line-height: 1.45; }
    .warn-row .w-icon { flex-shrink: 0; }

    /* â”€â”€ Flow diagram â”€â”€ */
    .flow { display: flex; flex-direction: column; gap: 0; }
    .flow-api-label {
      font-size: 10px; font-weight: 700; color: var(--blue);
      text-transform: uppercase; letter-spacing: .5px;
      margin-bottom: 4px; margin-top: 6px;
    }
    .flow-api-label:first-child { margin-top: 0; }
    .flow-step {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 4px; padding: 6px 10px;
      font-size: 11px; font-family: 'SF Mono', monospace; line-height: 1.4; color: var(--text);
    }
    .flow-step.hi-purple { border-color: var(--purple); color: var(--purple); background: rgba(197,134,192,.07); }
    .flow-step.hi-orange { border-color: var(--orange); color: var(--orange); background: rgba(206,145,120,.07); }
    .flow-step.hi-yellow { border-color: var(--yellow); color: var(--yellow); background: rgba(220,220,170,.07); }
    .flow-arrow { text-align: center; color: var(--dim); font-size: 11px; padding: 3px 0; }
    .flow-divider { border: none; border-top: 1px dashed var(--border); margin: 7px 0; }

    /* â”€â”€ Buttons â”€â”€ */
    .config-footer {
      padding: 11px 13px; border-top: 1px solid var(--border);
      display: flex; gap: 8px; flex-shrink: 0; align-items: center;
    }
    .btn {
      padding: 7px 14px; border-radius: 5px; font-size: 12px; font-weight: 600;
      cursor: pointer; border: none; transition: opacity .15s;
      display: flex; align-items: center; gap: 6px;
    }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .btn-send { background: var(--blue); color: #fff; flex: 1; justify-content: center; }
    .btn-sim  { background: var(--purple); color: #fff; flex: 1; justify-content: center; }
    .btn-sa   { background: var(--orange); color: #000; flex: 1; justify-content: center; }
    .btn-send:not(:disabled):hover, .btn-sim:not(:disabled):hover, .btn-sa:not(:disabled):hover { opacity: .82; }
    .btn-copy { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn-copy:hover { border-color: var(--blue); }

    /* â”€â”€ Right: Preview panel â”€â”€ */
    .preview-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .preview-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 7px 14px; background: var(--surface);
      border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .ptabs { display: flex; gap: 4px; }
    .ptab {
      padding: 4px 12px; font-size: 12px; border-radius: 4px; cursor: pointer;
      background: none; border: 1px solid transparent; color: var(--dim); transition: all .15s;
    }
    .ptab.active { background: var(--surface2); border-color: var(--border); color: var(--text); }
    .pactions { display: flex; align-items: center; gap: 8px; }

    /* â”€â”€ Size/Token pill â”€â”€ */
    .size-pill {
      font-size: 10px; padding: 2px 8px; border-radius: 10px;
      background: rgba(133,133,133,.1); color: var(--dim); border: 1px solid var(--border);
      font-family: 'SF Mono', monospace; white-space: nowrap;
    }
    .live-pill {
      display: flex; align-items: center; gap: 5px; font-size: 11px;
      padding: 3px 8px; border-radius: 10px;
      background: rgba(78,201,176,.1); color: var(--green); border: 1px solid rgba(78,201,176,.22);
    }
    .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
    .copy-small {
      padding: 4px 10px; font-size: 11px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 4px; color: var(--dim); cursor: pointer; transition: all .15s;
    }
    .copy-small:hover { color: var(--text); border-color: var(--blue); }

    /* â”€â”€ pview base â”€â”€ */
    .pview { flex: 1; overflow: auto; }
    .pview pre { margin: 0; padding: 16px; font-size: 12px; line-height: 1.65; min-height: 100%; }
    .pview code { font-family: 'SF Mono', 'Fira Code', monospace !important; }
    .pview.hidden { display: none; }

    /* â”€â”€ Response pane (flex override) â”€â”€ */
    #pv-response { display: flex; flex-direction: column; overflow: hidden; }
    #pv-response.hidden { display: none; }
    .resp-toolbar {
      padding: 6px 14px; background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: flex-end;
      flex-shrink: 0; gap: 8px;
    }
    .resp-md-label { font-size: 11px; color: var(--dim); }
    .resp-md-btn {
      padding: 3px 9px; font-size: 10px; border-radius: 4px; cursor: pointer;
      background: none; border: 1px solid var(--border);
      color: var(--dim); transition: all .15s; font-weight: 700; font-family: 'SF Mono', monospace;
    }
    .resp-md-btn:hover, .resp-md-btn.active { border-color: var(--blue); color: var(--blue); }
    .resp-scroll { flex: 1; overflow: auto; }
    #resp-view { padding: 16px; }
    .resp-text { font-size: 13px; line-height: 1.75; color: var(--text); }
    .resp-text:not(.md-rendered) { white-space: pre-wrap; }
    .resp-err { color: var(--red); font-family: monospace; font-size: 12px; }
    .resp-meta {
      margin-top: 14px; padding-top: 10px; border-top: 1px solid var(--border);
      display: flex; gap: 16px; flex-wrap: wrap;
    }
    .resp-stat { font-size: 11px; }
    .resp-stat span { color: var(--dim); }
    .resp-stat b { color: var(--text); }
    .resp-copy {
      margin-top: 10px; padding: 5px 12px; font-size: 11px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 4px; color: var(--dim); cursor: pointer; transition: all .15s; display: inline-block;
    }
    .resp-copy:hover { color: var(--text); border-color: var(--blue); }

    /* â”€â”€ Markdown rendered â”€â”€ */
    .md-rendered h1, .md-rendered h2, .md-rendered h3 { color: var(--text); margin: 14px 0 6px; font-weight: 600; }
    .md-rendered h1 { font-size: 17px; }
    .md-rendered h2 { font-size: 15px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
    .md-rendered h3 { font-size: 13px; color: var(--blue); }
    .md-rendered p { margin-bottom: 10px; line-height: 1.7; }
    .md-rendered ul, .md-rendered ol { padding-left: 22px; margin-bottom: 10px; }
    .md-rendered li { margin-bottom: 5px; line-height: 1.6; }
    .md-rendered code {
      background: var(--surface2); padding: 1px 5px; border-radius: 3px;
      font-family: 'SF Mono', monospace; font-size: 11.5px; color: var(--green);
    }
    .md-rendered pre {
      background: var(--surface2); padding: 10px 14px; border-radius: 6px;
      overflow-x: auto; margin: 10px 0; border: 1px solid var(--border);
    }
    .md-rendered pre code { background: none; padding: 0; color: var(--text); font-size: 12px; }
    .md-rendered blockquote {
      border-left: 3px solid var(--blue); padding-left: 14px;
      color: var(--dim); margin: 10px 0; font-style: italic;
    }
    .md-rendered strong { color: var(--text); }
    .md-rendered a { color: var(--blue); text-decoration: none; }
    .md-rendered a:hover { text-decoration: underline; }
    .md-rendered hr { border: none; border-top: 1px solid var(--border); margin: 14px 0; }
    .md-rendered table { border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 12px; }
    .md-rendered th, .md-rendered td { border: 1px solid var(--border); padding: 6px 10px; text-align: left; }
    .md-rendered th { background: var(--surface2); color: var(--blue); }

    /* â”€â”€ Export pane â”€â”€ */
    #pv-export { display: flex; flex-direction: column; overflow: hidden; }
    #pv-export.hidden { display: none; }
    .exp-toolbar {
      padding: 8px 12px; background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 4px; flex-shrink: 0;
    }
    .exp-tab {
      padding: 4px 11px; font-size: 11px; border-radius: 4px; cursor: pointer;
      background: none; border: 1px solid transparent; color: var(--dim); transition: all .15s;
    }
    .exp-tab.active { background: var(--surface2); border-color: var(--border); color: var(--text); }
    .exp-tab:hover { color: var(--text); }
    .exp-note {
      padding: 7px 14px; font-size: 11px; color: var(--yellow); line-height: 1.5;
      background: rgba(220,220,170,.05); border-bottom: 1px solid rgba(220,220,170,.15);
      flex-shrink: 0;
    }
    .exp-scroll { flex: 1; overflow: auto; }
    .exp-scroll pre { margin: 0; padding: 16px; min-height: 100%; }
    .exp-scroll code { font-family: 'SF Mono', 'Fira Code', monospace !important; font-size: 12px; line-height: 1.65; }

    /* â”€â”€ History panel â”€â”€ */
    .hist-panel {
      width: 260px; flex-shrink: 0;
      background: var(--surface); border-left: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .hist-panel.hidden { display: none; }
    .hist-list { flex: 1; overflow-y: auto; }
    .hist-entry {
      padding: 10px 13px; border-bottom: 1px solid var(--border);
      cursor: pointer; transition: background .12s;
    }
    .hist-entry:hover { background: var(--surface2); }
    .hist-entry:last-child { border-bottom: none; }
    .hist-mech { display: flex; align-items: center; font-size: 11px; color: var(--text); margin-bottom: 3px; }
    .hist-msg { font-size: 11px; color: var(--dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px; }
    .hist-time { font-size: 10px; color: var(--dim); opacity: .6; }
    .hist-empty { padding: 20px 16px; color: var(--dim); font-size: 12px; text-align: center; line-height: 1.7; }

    /* â”€â”€ Spinner â”€â”€ */
    .spin {
      display: inline-block; width: 13px; height: 13px;
      border: 2px solid var(--border); border-top-color: var(--blue);
      border-radius: 50%; animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Scrollbar â”€â”€ */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

    /* â”€â”€ Landing â”€â”€ */
    .landing {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 40px; padding: 40px;
      background: var(--bg);
    }
    .landing-title { font-size: 20px; font-weight: 700; color: var(--text); text-align: center; }
    .landing-sub { font-size: 13px; color: var(--dim); text-align: center; margin-top: 6px; }
    .landing-cards { display: flex; gap: 24px; }
    .landing-card {
      width: 280px; padding: 28px 24px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; cursor: pointer;
      transition: border-color .2s, transform .15s, box-shadow .2s;
      display: flex; flex-direction: column; gap: 14px;
    }
    .landing-card:hover {
      border-color: var(--blue); transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    .landing-card.proxy:hover { border-color: var(--red); }
    .lc-icon { font-size: 32px; }
    .lc-title { font-size: 16px; font-weight: 700; color: var(--text); }
    .lc-desc { font-size: 12px; color: var(--dim); line-height: 1.65; }
    .lc-req {
      font-size: 11px; padding: 4px 10px; border-radius: 5px; align-self: flex-start;
      background: var(--surface2); border: 1px solid var(--border); color: var(--dim);
      font-family: 'SF Mono', monospace;
    }
    .landing-card:hover .lc-req { color: var(--text); }
    .lc-btn {
      margin-top: 4px; padding: 8px 16px; border-radius: 6px; font-size: 13px;
      font-weight: 600; cursor: pointer; border: none; transition: opacity .15s;
      text-align: center;
    }
    .landing-card .lc-btn { background: var(--blue); color: #fff; }
    .landing-card.proxy .lc-btn { background: var(--red); color: #fff; }
    .lc-btn:hover { opacity: .85; }
    .logo { cursor: pointer; }

    /* â”€â”€ Proxy panel â”€â”€ */
    #normalPanels { display: flex; flex: 1; overflow: hidden; }
    .proxy-panel { flex: 1; display: flex; overflow: hidden; }
    .proxy-ctrl {
      width: 320px; flex-shrink: 0;
      background: var(--surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .proxy-stream { flex: 1; display: flex; overflow: hidden; }
    .proxy-list {
      width: 280px; flex-shrink: 0;
      background: var(--surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .proxy-detail { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .proxy-status {
      display: flex; align-items: center; gap: 8px; font-size: 12px;
      padding: 8px 12px; border-radius: 6px;
      background: var(--surface2); border: 1px solid var(--border);
    }
    .proxy-status.running { border-color: rgba(78,201,176,.4); background: rgba(78,201,176,.07); }
    .proxy-status .ps-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); flex-shrink: 0; }
    .proxy-status.running .ps-dot { background: var(--green); animation: pulse 1.5s infinite; }
    .proxy-cmd {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 5px; padding: 8px 10px;
      font-family: 'SF Mono', monospace; font-size: 11px;
      line-height: 1.6; word-break: break-all;
    }
    .prx-entry {
      padding: 9px 13px; border-bottom: 1px solid var(--border);
      cursor: pointer; transition: background .12s;
    }
    .prx-entry:hover { background: var(--surface2); }
    .prx-entry.selected { background: rgba(86,156,214,.12); border-left: 3px solid var(--blue); }
    .prx-method { font-size: 10px; font-weight: 700; font-family: 'SF Mono', monospace; color: var(--green); margin-right: 5px; }
    .prx-path { font-size: 11px; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .prx-model { font-size: 10px; color: var(--dim); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .prx-ts { font-size: 10px; color: var(--dim); opacity: .6; flex-shrink: 0; margin-left: 6px; }
    .dtabs {
      display: flex; gap: 4px; padding: 7px 12px;
      border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0;
    }
    .dtab {
      padding: 3px 10px; font-size: 12px; border-radius: 4px; cursor: pointer;
      background: none; border: 1px solid transparent; color: var(--dim); transition: all .15s;
    }
    .dtab.active { background: var(--surface2); border-color: var(--border); color: var(--text); }
    .proxy-empty {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      flex: 1; color: var(--dim); font-size: 13px; text-align: center; gap: 8px; padding: 20px;
      line-height: 1.7;
    }

    /* â”€â”€ Messages view â”€â”€ */
    .msg-filter {
      display: flex; align-items: center; gap: 6px;
      padding: 7px 12px; border-bottom: 1px solid var(--border);
      flex-shrink: 0; background: var(--surface);
    }
    .mf-btn {
      padding: 3px 10px; font-size: 11px; border-radius: 4px;
      background: none; border: 1px solid var(--border);
      color: var(--dim); cursor: pointer; transition: all .15s;
    }
    .mf-btn.active { background: var(--surface2); border-color: var(--blue); color: var(--text); }
    .msg-count { font-size: 10px; color: var(--dim); margin-left: auto; }
    .msgs-list { display: flex; flex-direction: column; gap: 8px; padding: 12px; overflow-y: auto; }
    .msg-card { border-radius: 6px; border: 1px solid var(--border); overflow: hidden; font-size: 12px; }
    .msg-card.msg-user { border-color: rgba(86,156,214,.35); }
    .msg-card.msg-assistant { border-color: var(--border); opacity: .65; }
    .msg-role {
      padding: 4px 10px; font-size: 10px; font-weight: 700;
      text-transform: uppercase; letter-spacing: .6px; border-bottom: 1px solid var(--border);
    }
    .msg-card.msg-user .msg-role { color: var(--blue); background: rgba(86,156,214,.08); }
    .msg-card.msg-assistant .msg-role { color: var(--dim); background: var(--surface2); }
    .msg-body { padding: 8px 10px; display: flex; flex-direction: column; gap: 5px; }
    .msg-text {
      white-space: pre-wrap; word-break: break-word; line-height: 1.6;
      font-family: 'SF Mono', monospace; max-height: 220px; overflow-y: auto;
    }
    .msg-badge {
      display: inline-block; padding: 1px 6px; border-radius: 3px;
      font-size: 10px; font-weight: 700; margin: 1px 2px;
    }
    .msg-badge.green { background: rgba(78,201,176,.15); color: var(--green); border: 1px solid rgba(78,201,176,.3); }
    .msg-badge.cyan  { background: rgba(86,156,214,.15); color: var(--blue);  border: 1px solid rgba(86,156,214,.3); }
    .msg-badge.yellow { background: rgba(220,220,170,.1); color: var(--yellow); border: 1px solid rgba(220,220,170,.25); }
    .msg-badge.hl-active { outline: 2px solid currentColor; outline-offset: 1px; }
    .badge-expand-content.badge-section-hl {
      background: rgba(255,235,59,.08); border-left: 3px solid rgba(255,235,59,.5);
      padding-left: 8px;
    }
    .msg-tool { color: var(--purple); font-family: 'SF Mono', monospace; font-size: 11px; }
    .msg-tool-result { color: var(--green); font-family: 'SF Mono', monospace; font-size: 11px; }
    .msg-other { color: var(--dim); font-family: 'SF Mono', monospace; font-size: 11px; }
    /* typed vs injected separation */
    .msg-typed {
      background: rgba(86,156,214,.06); border-left: 2px solid var(--blue);
      padding: 6px 10px; border-radius: 0 4px 4px 0;
      white-space: pre-wrap; word-break: break-word; line-height: 1.6;
      font-family: 'SF Mono', monospace;
    }
    .msg-injected-row { margin: 2px 0; }
    .msg-badge.expandable { cursor: pointer; user-select: none; }
    .msg-badge.expandable::after { content: ' â–¶'; font-size: 8px; opacity: .7; }
    .msg-badge.expandable.open::after { content: ' â–¼'; }
    .badge-expand-content {
      display: none; margin-top: 4px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 4px; padding: 8px 10px;
      font-size: 11px; font-family: 'SF Mono', monospace;
      white-space: pre-wrap; word-break: break-word;
      max-height: 250px; overflow-y: auto; color: var(--dim);
    }
    /* search bar */
    .msg-search-bar {
      display: flex; align-items: center; gap: 6px;
      padding: 5px 10px; border-bottom: 1px solid var(--border);
      background: var(--surface); flex-shrink: 0;
    }
    .msg-search-input {
      flex: 1; background: var(--bg); border: 1px solid var(--border);
      color: var(--text); padding: 3px 8px; border-radius: 4px;
      font-size: 11px; font-family: 'SF Mono', monospace; outline: none;
    }
    .msg-search-input:focus { border-color: var(--blue); }
    .msg-search-clear {
      background: none; border: none; color: var(--dim); cursor: pointer;
      font-size: 13px; padding: 0 2px; line-height: 1;
    }
    mark.search-hl { background: rgba(255,235,59,.35); color: inherit; border-radius: 2px; padding: 0 1px; }
    mark.search-hl.current { background: rgba(255,152,0,.7); }
    .search-nav { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--dim); white-space: nowrap; }
    .search-nav-btn { background: none; border: 1px solid var(--border); color: var(--dim); border-radius: 4px; width: 22px; height: 22px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
    .search-nav-btn:hover { color: var(--fg); border-color: var(--fg); }

    /* â”€â”€ Analysis view â”€â”€ */
    .analysis-view { padding: 14px; display: flex; flex-direction: column; gap: 14px; }
    .analysis-chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .mech-chip {
      display: flex; align-items: center; gap: 5px;
      padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;
      font-family: 'SF Mono', monospace;
    }
    .mech-chip.found { opacity: 1; }
    .mech-chip.not-found { opacity: .25; }
    .mech-chip.cm  { background: rgba(78,201,176,.15);  color: var(--green);  border: 1px solid rgba(78,201,176,.35); }
    .mech-chip.st  { background: rgba(86,156,214,.15);  color: var(--blue);   border: 1px solid rgba(86,156,214,.35); }
    .mech-chip.sc  { background: rgba(220,220,170,.12); color: var(--yellow); border: 1px solid rgba(220,220,170,.3); }
    .mech-chip.sk  { background: rgba(197,134,192,.15); color: var(--purple); border: 1px solid rgba(197,134,192,.35); }
    .mech-chip.sa  { background: rgba(206,145,120,.15); color: var(--orange); border: 1px solid rgba(206,145,120,.35); }
    .mech-chip.mc  { background: rgba(78,201,220,.12);  color: #4ec9dc;       border: 1px solid rgba(78,201,220,.3); }
    .mech-chip.mn  { background: rgba(156,220,254,.12); color: #9cdcfe;       border: 1px solid rgba(156,220,254,.3); }
    .mech-chip.btn { cursor: pointer; transition: filter .1s; }
    .mech-chip.btn:hover { filter: brightness(1.3); }
    .mech-chip.btn.active { outline: 2px solid currentColor; outline-offset: 1px; }
    .mech-section-active { box-shadow: 0 0 0 2px rgba(255,255,255,.2); border-radius: 6px; }
    .mech-hl-text { background: rgba(80,200,120,.18); border-radius: 2px; outline: 1px solid rgba(80,200,120,.4); }
    .mech-hl-row { background: rgba(80,200,120,.12); border-radius: 4px; }
    .mech-filter-desc {
      padding: 6px 12px 8px; font-size: 11px;
      border-top: 1px solid var(--border); display: flex; align-items: flex-start; gap: 8px;
    }
    .mech-filter-desc-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; margin-top: 3px; }
    .mech-filter-desc-body { display: flex; flex-direction: column; gap: 2px; }
    .mech-filter-desc-who { font-size: 10px; color: var(--dim); opacity: .7; }
    .mech-filter-desc-what { color: var(--fg); line-height: 1.5; }
    .analysis-section { display: flex; flex-direction: column; gap: 6px; }
    .analysis-section-title {
      font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .8px;
      display: flex; align-items: center; gap: 6px;
    }
    .analysis-desc { font-size: 11px; color: var(--dim); margin: 4px 0 8px; line-height: 1.5; }
    .analysis-block {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 5px; padding: 9px 11px;
      font-size: 11px; font-family: 'SF Mono', monospace;
      line-height: 1.6; color: var(--text);
      white-space: pre-wrap; word-break: break-all;
      max-height: 180px; overflow-y: auto;
    }
    .analysis-block.highlight-green { border-color: rgba(78,201,176,.4); }
    .analysis-block.highlight-blue  { border-color: rgba(86,156,214,.4); }
    .analysis-block.highlight-yellow{ border-color: rgba(220,220,170,.35); }
    .analysis-block.highlight-purple{ border-color: rgba(197,134,192,.4); }
    .analysis-block.highlight-orange{ border-color: rgba(206,145,120,.4); }

    /* â”€â”€ JSON Tree Viewer â”€â”€ */
    .json-tree-view {
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 12px; line-height: 1.7;
      padding: 12px 16px; overflow: auto;
    }
    .jt-key  { color: #9cdcfe; }
    .jt-str  { color: var(--orange); }
    .jt-num  { color: var(--green); }
    .jt-bool { color: var(--blue); }
    .jt-null { color: var(--dim); }
    .jt-row  { display: block; }
    .jt-btn {
      display: inline-block; width: 14px; font-size: 8px; line-height: 1;
      color: var(--dim); cursor: pointer; user-select: none;
      text-align: center; vertical-align: middle; transition: color .1s;
    }
    .jt-btn:hover { color: var(--yellow); }
    .jt-tag {
      color: var(--dim); font-size: 10px; cursor: pointer;
      padding: 0 3px; vertical-align: middle;
    }
    .jt-tag:hover { color: var(--text); }
    .analysis-block .jt-row { white-space: normal; }
    .analysis-kv { display: flex; gap: 8px; font-size: 11px; font-family: 'SF Mono', monospace; }
    .analysis-kv .ak { color: var(--dim); flex-shrink: 0; }
    .analysis-kv .av { color: var(--text); }
    .analysis-none {
      color: var(--dim); font-size: 12px; text-align: center; padding: 24px 0;
      line-height: 1.8;
    }
  </style>
</head>
<body>

<header class="header">
  <div class="logo" onclick="switchM('home')" title="í™ˆìœ¼ë¡œ" data-i18n-title="header.goHome">
    <div class="logo-icon">CI</div>
    <span class="logo-text">Claude Inspector</span>
    <span class="logo-sub" data-i18n="header.logoSub">Prompt Mechanism Visualizer</span>
  </div>
  <div class="header-right">
    <button id="langToggleBtn" onclick="i18n.setLocale(i18n.locale==='ko'?'en':'ko')"
      style="padding:4px 10px;border-radius:5px;font-size:11px;background:none;border:1px solid var(--border);color:var(--dim);cursor:pointer;transition:all .15s;white-space:nowrap;font-weight:700;">EN</button>
    <button class="hist-btn" id="histToggleBtn" onclick="toggleHistory()" title="ìš”ì²­ íˆìŠ¤í† ë¦¬ (ìµœê·¼ 10ê°œ)" data-i18n-title="header.historyTitle"><span data-i18n="header.history">History</span></button>
    <select class="model-select" id="modelSel" style="display:none">
      <option value="claude-sonnet-4-6">claude-sonnet-4-6</option>
      <option value="claude-opus-4-6">claude-opus-4-6</option>
      <option value="claude-haiku-4-5-20251001">claude-haiku-4-5</option>
    </select>
    <div class="api-group" id="apiGroup">
      <span class="api-label">API Key</span>
      <span class="api-saved" id="apiSaved" style="display:none" data-i18n="header.apiSaved">ì €ì¥ë¨</span>
      <div class="api-dot" id="apiDot"></div>
      <input type="password" class="api-input" id="apiKey"
        placeholder="sk-ant-api03-â€¦  (ì…ë ¥í•˜ë©´ ìë™ ì €ì¥)"
        oninput="onApiKeyChange()" data-i18n-placeholder="apiInput.placeholder">
    </div>
  </div>
</header>

<nav class="tabs" id="tabNav">
  <button class="tab" data-m="claude-md"     onclick="switchM('claude-md')">    <span class="badge">MD</span> CLAUDE.md</button>
  <button class="tab"        data-m="output-style"  onclick="switchM('output-style')">  <span class="badge">ST</span> Output Style</button>
  <button class="tab"        data-m="slash-command" onclick="switchM('slash-command')"> <span class="badge">/</span>  Slash Command</button>
  <button class="tab"        data-m="skill"         onclick="switchM('skill')">         <span class="badge">SK</span> Skill</button>
  <button class="tab"        data-m="sub-agent"     onclick="switchM('sub-agent')">     <span class="badge">SA</span> Sub-Agent</button>
  <button class="tab"        data-m="proxy"         onclick="switchM('proxy')">         <span class="badge">PX</span> Proxy</button>
</nav>

<div class="main">

<div id="landingPanel" class="landing">
  <div>
    <div class="landing-title" data-i18n="landing.title">Claude Inspectorì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤</div>
    <div class="landing-sub" data-i18n="landing.subtitle">ì‚¬ìš© ëª©ì ì— ë§ëŠ” ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
  </div>
  <div class="landing-cards">
    <div class="landing-card" onclick="switchM('claude-md')">
      <div class="lc-icon">ğŸ”¬</div>
      <div class="lc-title">Simulator</div>
      <div class="lc-desc" data-i18n="landing.simDesc">
        5ê°€ì§€ í”„ë¡¬í”„íŠ¸ ë©”ì»¤ë‹ˆì¦˜(CLAUDE.md, Output Style, Slash Command, Skill, Sub-Agent)ì˜
        ì‹¤ì œ API í˜ì´ë¡œë“œë¥¼ ì§ì ‘ êµ¬ì„±í•˜ê³  í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
      </div>
      <span class="lc-req" data-i18n="landing.simReq">í•„ìš”: Anthropic API Key</span>
      <div class="lc-btn" data-i18n="landing.start">ì‹œì‘í•˜ê¸° â†’</div>
    </div>
    <div class="landing-card proxy" onclick="switchM('proxy')">
      <div class="lc-icon">ğŸ”Œ</div>
      <div class="lc-title">Proxy Mode</div>
      <div class="lc-desc" data-i18n="landing.proxyDesc">
        Claude Code CLIì˜ ì‹¤ì œ API íŠ¸ë˜í”½ì„ ê°€ë¡œì±„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.
        ì‹¤ì œ ì‚¬ìš© ì¤‘ ì–´ë–¤ í˜ì´ë¡œë“œê°€ ì˜¤ê°€ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
      <span class="lc-req" data-i18n="landing.proxyReq">í•„ìš”: Claude Code CLI ì„¤ì¹˜</span>
      <div class="lc-btn" data-i18n="landing.start">ì‹œì‘í•˜ê¸° â†’</div>
    </div>
  </div>
</div>

<div id="normalPanels" style="display:none">
  <div class="config-panel">
    <div class="panel-header">
      <span id="panelTitle">Configuration</span>
      <span class="inject-chip" id="injectChip">â€”</span>
    </div>
    <div class="config-body" id="configBody"></div>
    <div class="config-footer" id="configFooter"></div>
  </div>

  <div class="preview-panel">
    <div class="preview-header">
      <div class="ptabs">
        <button class="ptab active" id="ptab-payload"  onclick="showPTab('payload')">Payload</button>
        <button class="ptab"        id="ptab-response" onclick="showPTab('response')">Response</button>
        <button class="ptab"        id="ptab-export"   onclick="showPTab('export')">Export</button>
      </div>
      <div class="pactions">
        <span class="size-pill" id="sizePill">â€” KB</span>
        <span class="live-pill" id="livePill" style="display:none"><span class="live-dot"></span>Live</span>
        <button class="copy-small" onclick="copyPayload()" data-i18n="copy.json">Copy JSON</button>
      </div>
    </div>

    <div class="pview" id="pv-payload">
      <div class="json-tree-view" id="payloadCode"></div>
    </div>

    <div class="pview hidden" id="pv-response">
      <div class="resp-toolbar" id="respToolbar" style="display:none">
        <button class="copy-small" onclick="copyResponse()" data-i18n="copy.text">Copy Text</button>
      </div>
      <div class="resp-scroll">
        <div id="resp-view"></div>
      </div>
    </div>

    <div class="pview hidden" id="pv-export">
      <div class="exp-toolbar">
        <button class="exp-tab active" data-lang="curl"       onclick="showExportLang('curl')">cURL</button>
        <button class="exp-tab"        data-lang="python"     onclick="showExportLang('python')">Python</button>
        <button class="exp-tab"        data-lang="typescript" onclick="showExportLang('typescript')">TypeScript</button>
        <button class="copy-small" style="margin-left:auto" onclick="copyExport()" data-i18n="copy.copy">Copy</button>
      </div>
      <div id="expNote" class="exp-note" style="display:none"></div>
      <div class="exp-scroll">
        <pre><code id="exportCode" class="language-bash"></code></pre>
      </div>
    </div>
  </div>

  <div class="hist-panel hidden" id="histPanel">
    <div class="panel-header">
      <span data-i18n="history.title">ìš”ì²­ íˆìŠ¤í† ë¦¬</span>
      <span style="font-size:10px;color:var(--dim)" id="histCount">0 / 10</span>
    </div>
    <div class="hist-list" id="histList">
      <div class="hist-empty" data-i18n-html="history.empty">ì•„ì§ ê¸°ë¡ ì—†ìŒ<br><small>API ì „ì†¡ í›„ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤</small></div>
    </div>
  </div>
</div><!-- /#normalPanels -->

<div id="proxyPanel" class="proxy-panel" style="display:none">
  <!-- Control -->
  <div class="proxy-ctrl">
    <div class="panel-header">
      <span data-i18n="proxy.title">Proxy Control</span>
      <span class="inject-chip" style="color:var(--red);border-color:rgba(244,135,113,.3);background:rgba(244,135,113,.08)" data-i18n="proxy.liveCapture">ì‹¤ì‹œê°„ ìº¡ì²˜</span>
    </div>
    <div class="config-body">
      <div class="how-box" style="border-color:rgba(244,135,113,.25);background:rgba(244,135,113,.04)">
        <div class="how-title" style="color:var(--red)" data-i18n="proxy.interceptTitle">âš¡ ì‹¤ì œ API íŠ¸ë˜í”½ ì¸í„°ì…‰íŠ¸</div>
        <div class="how-text" data-i18n-html="proxy.interceptDesc">
          Claude Code CLIì˜ ì‹¤ì œ API ìš”ì²­ì„ ê°€ë¡œì±„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.<br>
          í”„ë¡ì‹œë¥¼ ì‹œì‘í•œ ë’¤ ì•„ë˜ ëª…ë ¹ìœ¼ë¡œ Claude Codeë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.
        </div>
      </div>
      <div class="field">
        <label data-i18n="proxy.port">í¬íŠ¸</label>
        <input type="number" id="proxyPort" value="9090" min="1024" max="65535" style="width:120px" oninput="updateProxyCmd()">
      </div>
      <div class="proxy-status" id="proxyStatus">
        <span class="ps-dot"></span>
        <span id="proxyStatusText" data-i18n="proxy.stopped">ì¤‘ì§€ë¨</span>
      </div>
      <div class="field">
        <label>
          <span data-i18n="proxy.runCommand">ì‹¤í–‰ ëª…ë ¹</span>
          <button class="copy-small" onclick="copyProxyCmd()" style="text-transform:none;letter-spacing:0;font-weight:normal" data-i18n="copy.copy">Copy</button>
        </label>
        <div class="proxy-cmd" id="proxyCmdBox">
          <span id="proxyCmdText" style="color:var(--dim)" data-i18n="proxy.startFirst">í”„ë¡ì‹œë¥¼ ë¨¼ì € ì‹œì‘í•˜ì„¸ìš”</span>
        </div>
      </div>
    </div>
    <div class="config-footer">
      <button class="btn btn-send" id="proxyStartBtn" style="flex:1;justify-content:center" onclick="toggleProxy()" data-i18n="proxy.startProxy">Start Proxy</button>
      <button class="btn btn-copy" onclick="clearProxyCaptures()" data-i18n="proxy.clear">Clear</button>
    </div>
  </div>

  <!-- Stream -->
  <div class="proxy-stream">
    <div class="proxy-list">
      <div class="panel-header">
        <span data-i18n="proxy.capturedRequests">ìº¡ì²˜ëœ ìš”ì²­</span>
        <span style="font-size:10px;color:var(--dim)" id="proxyCount">0</span>
      </div>
      <div class="hist-list" id="proxyList">
        <div class="hist-empty" data-i18n-html="proxy.noCaptures">ìº¡ì²˜ëœ ìš”ì²­ ì—†ìŒ<br><small>í”„ë¡ì‹œë¥¼ ì‹œì‘í•˜ê³ <br>Claude Codeë¥¼ ì‹¤í–‰í•˜ì„¸ìš”</small></div>
      </div>
    </div>
    <div class="proxy-detail">
      <div class="dtabs">
        <button class="dtab active" data-dtab="messages" onclick="showDetailTab('messages')">Messages</button>
        <button class="dtab"        data-dtab="request"  onclick="showDetailTab('request')">Request</button>
        <button class="dtab"        data-dtab="response" onclick="showDetailTab('response')">Response</button>
        <button class="dtab"        data-dtab="analysis" onclick="showDetailTab('analysis')" style="color:var(--purple)">Analysis</button>
        <button class="copy-small" style="margin-left:auto" onclick="copyProxyDetail()" data-i18n="copy.copy">Copy</button>
      </div>
      <div id="proxyDetailView" style="flex:1;overflow:hidden;display:flex;flex-direction:column">
        <div class="proxy-empty">
          <span style="font-size:28px">ğŸ”</span>
          <span data-i18n-html="proxy.selectRequest">ìš”ì²­ì„ ì„ íƒí•˜ë©´<br>í˜ì´ë¡œë“œê°€ í‘œì‹œë©ë‹ˆë‹¤</span>
        </div>
      </div>
    </div>
  </div>
</div><!-- /#proxyPanel -->

</div><!-- /.main -->

<script>
// â”€â”€â”€ i18n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LOCALES = {
  ko: {
    header: {
      history: 'History',
      historyTitle: 'ìš”ì²­ íˆìŠ¤í† ë¦¬ (ìµœê·¼ 10ê°œ)',
      apiSaved: 'ì €ì¥ë¨',
      goHome: 'í™ˆìœ¼ë¡œ',
      logoSub: 'Prompt Mechanism Visualizer',
    },
    landing: {
      title: 'Claude Inspectorì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤',
      subtitle: 'ì‚¬ìš© ëª©ì ì— ë§ëŠ” ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”',
      simDesc: '5ê°€ì§€ í”„ë¡¬í”„íŠ¸ ë©”ì»¤ë‹ˆì¦˜(CLAUDE.md, Output Style, Slash Command, Skill, Sub-Agent)ì˜ ì‹¤ì œ API í˜ì´ë¡œë“œë¥¼ ì§ì ‘ êµ¬ì„±í•˜ê³  í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.',
      simReq: 'í•„ìš”: Anthropic API Key',
      proxyDesc: 'Claude Code CLIì˜ ì‹¤ì œ API íŠ¸ë˜í”½ì„ ê°€ë¡œì±„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤. ì‹¤ì œ ì‚¬ìš© ì¤‘ ì–´ë–¤ í˜ì´ë¡œë“œê°€ ì˜¤ê°€ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
      proxyReq: 'í•„ìš”: Claude Code CLI ì„¤ì¹˜',
      start: 'ì‹œì‘í•˜ê¸° â†’',
    },
    history: {
      title: 'ìš”ì²­ íˆìŠ¤í† ë¦¬',
      empty: 'ì•„ì§ ê¸°ë¡ ì—†ìŒ<br><small>API ì „ì†¡ í›„ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤</small>',
      noMsg: 'ë©”ì‹œì§€ ì—†ìŒ',
    },
    proxy: {
      title: 'Proxy Control',
      liveCapture: 'ì‹¤ì‹œê°„ ìº¡ì²˜',
      interceptTitle: 'âš¡ ì‹¤ì œ API íŠ¸ë˜í”½ ì¸í„°ì…‰íŠ¸',
      interceptDesc: 'Claude Code CLIì˜ ì‹¤ì œ API ìš”ì²­ì„ ê°€ë¡œì±„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.<br>í”„ë¡ì‹œë¥¼ ì‹œì‘í•œ ë’¤ ì•„ë˜ ëª…ë ¹ìœ¼ë¡œ Claude Codeë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.',
      port: 'í¬íŠ¸',
      stopped: 'ì¤‘ì§€ë¨',
      running: 'í¬íŠ¸ {port}ì—ì„œ ì‹¤í–‰ ì¤‘',
      runCommand: 'ì‹¤í–‰ ëª…ë ¹',
      startFirst: 'í”„ë¡ì‹œë¥¼ ë¨¼ì € ì‹œì‘í•˜ì„¸ìš”',
      startProxy: 'Start Proxy',
      stopProxy: 'Stop Proxy',
      clear: 'Clear',
      capturedRequests: 'ìº¡ì²˜ëœ ìš”ì²­',
      noCaptures: 'ìº¡ì²˜ëœ ìš”ì²­ ì—†ìŒ<br><small>í”„ë¡ì‹œë¥¼ ì‹œì‘í•˜ê³ <br>Claude Codeë¥¼ ì‹¤í–‰í•˜ì„¸ìš”</small>',
      startFail: 'í”„ë¡ì‹œ ì‹œì‘ ì‹¤íŒ¨: ',
      selectRequest: 'ìš”ì²­ì„ ì„ íƒí•˜ë©´<br>í˜ì´ë¡œë“œê°€ í‘œì‹œë©ë‹ˆë‹¤',
      noMessages: 'messages ë°°ì—´ ì—†ìŒ',
      waitingResponse: 'ì‘ë‹µ ëŒ€ê¸° ì¤‘â€¦',
      noBody: 'ë°”ë”” ì—†ìŒ',
      noResults: 'ê²°ê³¼ ì—†ìŒ',
      msgCount: '{count} / {total}ê°œ',
    },
    messages: {
      filterUser: 'ë‚´ê°€ ë³´ë‚¸ ê²ƒ',
      filterTyped: 'ì§ì ‘ ì…ë ¥ë§Œ',
      filterAssistant: 'í´ë¡œë“œê°€ ë³´ë‚¸ ê²ƒ',
      filterAll: 'ì „ì²´',
      searchPlaceholder: 'ğŸ” ê²€ìƒ‰... (âŒ˜F)',
      searchClear: 'ê²€ìƒ‰ ì´ˆê¸°í™”',
    },
    analysis: {
      noMechanisms: 'ê°ì§€ëœ ë©”ì»¤ë‹ˆì¦˜ ì—†ìŒ<br><small>ì¼ë°˜ API ìš”ì²­ì´ê±°ë‚˜ ë¶„ì„ ì§€ì› ì™¸ íŒ¨í„´ì…ë‹ˆë‹¤</small>',
      claudeMdTitle: 'CLAUDE.md â€” system-reminder ì£¼ì…',
      claudeMdDesc: 'Claude Codeê°€ í”„ë¡œì íŠ¸/ê¸€ë¡œë²Œ CLAUDE.md ë‚´ìš©ì„ <system-reminder> íƒœê·¸ë¡œ ê°ì‹¸ì„œ messages[] ì•ˆì— ì‚½ì…',
      outputStyleTitle: 'Output Style â€” system[] ì¶”ê°€ ë¸”ë¡',
      outputStyleDesc: 'Claude Codeê°€ system í”„ë¡¬í”„íŠ¸ ë°°ì—´ì— ì¶”ê°€ ë¸”ë¡ìœ¼ë¡œ ì‚½ì… (ëª¨ë¸ ì‘ë‹µ ìŠ¤íƒ€ì¼ ì œì–´)',
      slashCmdTitle: 'â‘  ì…ë ¥ â€” Slash Command',
      slashCmdDesc: 'ì‚¬ìš©ìê°€ /{cmd}ì„ ì…ë ¥í•˜ë©´ Claude Codeê°€ <command-message> íƒœê·¸ë¡œ ê°ì‹¸ì„œ í”„ë¡¬í”„íŠ¸ì— ì£¼ì…',
      skillTitle: 'Skill (tool_use â†’ tool_result)',
      skillLinkedTitle: 'â‘¡ ì‹¤í–‰ â€” Skill (tool_use â†’ tool_result)',
      skillDesc: 'Claudeê°€ ìŠ¤í‚¬ì„ tool_useë¡œ í˜¸ì¶œí•˜ê³  ê²°ê³¼ë¥¼ tool_resultë¡œ ìˆ˜ì‹ ',
      skillLinkedDesc: 'Claudeê°€ ìœ„ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œë¥¼ ì½ê³ , ë§¤ì¹­ë˜ëŠ” ìŠ¤í‚¬ì„ tool_useë¡œ í˜¸ì¶œ',
      noToolResult: 'tool_result ì—†ìŒ (ë‹¤ìŒ ë©”ì‹œì§€ì— ìˆê±°ë‚˜ ì•„ì§ ìˆ˜ì‹  ì „)',
      subAgentDesc: 'Claudeê°€ Task toolë¡œ ë…ë¦½ì ì¸ ì„œë¸Œì—ì´ì „íŠ¸ API ìš”ì²­ì„ ìƒì„± (ë³„ë„ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰)',
      searchPlaceholder: 'ğŸ” ê²€ìƒ‰... (âŒ˜F, Enter=ë‹¤ìŒ)',
    },
    mechDesc: {
      cm: {
        who: 'Claude Code CLIê°€ ìë™ ì£¼ì… (ìš°ë¦¬ ì•±ì€ í‘œì‹œë§Œ í•¨)',
        what: 'CLAUDE.md íŒŒì¼ ë‚´ìš©ì„ <system-reminder> íƒœê·¸ë¡œ ê°ì‹¸ messages[] ì•ˆì— ì‚½ì…í•©ë‹ˆë‹¤.',
      },
      sc: {
        who: 'Claude Code CLIê°€ ìë™ ë˜í•‘ (ìš°ë¦¬ ì•±ì€ í‘œì‹œë§Œ í•¨)',
        what: '/ëª…ë ¹ì–´ ì…ë ¥ ì‹œ í•´ë‹¹ ë‚´ìš©ì„ <command-message> íƒœê·¸ë¡œ ê°ì‹¸ user ë©”ì‹œì§€ì— ì‚½ì…í•©ë‹ˆë‹¤.',
      },
      sk: {
        who: 'Claude Code CLIê°€ ìë™ ì£¼ì… (ìš°ë¦¬ ì•±ì€ í‘œì‹œë§Œ í•¨)',
        what: 'ìŠ¤í‚¬ì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ "The following skills are available..." ëª©ë¡ì„ <system-reminder>ë¡œ ì£¼ì…í•©ë‹ˆë‹¤.',
      },
      sa: {
        who: 'Claude Code CLIê°€ ë³„ë„ API í˜¸ì¶œ ìƒì„± (ìš°ë¦¬ ì•±ì€ í‘œì‹œë§Œ í•¨)',
        what: 'Task tool í˜¸ì¶œ ì‹œ Claude Codeê°€ ë…ë¦½ì ì¸ ë‘ ë²ˆì§¸ API ìš”ì²­ì„ ë§Œë“¤ì–´ ì„œë¸Œì—ì´ì „íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.',
      },
      mc: {
        who: 'Claudeê°€ MCP ë„êµ¬ í˜¸ì¶œ (tool_use)',
        what: 'Model Context Protocol ë„êµ¬ë¥¼ tool_useë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.',
      },
    },
    export: {
      skillNote: 'âš ï¸  Skillì€ tool_use í”Œë¡œìš°ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” Simulate Effect (system ì£¼ì… ë²„ì „)ì˜ ì‹¤í–‰ ê°€ëŠ¥í•œ í˜ì´ë¡œë“œì…ë‹ˆë‹¤.',
      subAgentNote: 'âš ï¸  Sub-AgentëŠ” 2ê°œì˜ API í˜¸ì¶œì„ ìƒì„±í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” API Call #2 (ê²©ë¦¬ëœ ì„œë¸Œì—ì´ì „íŠ¸)ì˜ ë‹¨ë… ì‹¤í–‰ í˜ì´ë¡œë“œì…ë‹ˆë‹¤.',
    },
    form: {
      fileOpen: 'ğŸ“‚ íŒŒì¼ ì—´ê¸°',
      fileElectronOnly: 'íŒŒì¼ ì—´ê¸°ëŠ” Electron ì•±ì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤.',
    },
    copy: {
      json: 'Copy JSON',
      text: 'í…ìŠ¤íŠ¸ ë³µì‚¬',
      copy: 'ë³µì‚¬',
      copied: 'âœ“ ë³µì‚¬ë¨',
      response: 'ì‘ë‹µ ë³µì‚¬',
    },
    api: {
      sending: 'ì „ì†¡ ì¤‘â€¦',
      simulatingSkill: 'ìŠ¤í‚¬ ì‹œë®¬ë ˆì´ì…˜ ì¤‘â€¦',
      runningSubAgent: '{type} ì„œë¸Œ ì—ì´ì „íŠ¸ ì‹¤í–‰ ì¤‘â€¦',
    },
    apiInput: {
      placeholder: 'sk-ant-api03-â€¦  (ì…ë ¥í•˜ë©´ ìë™ ì €ì¥)',
    },
    search: {
      prev: 'ì´ì „',
      next: 'ë‹¤ìŒ',
    },
    mech: {
      claudeMd: {
        howTitle: 'âš¡ Claude Codeì—ì„œ ì‹¤ì œ ë™ì‘',
        howText: 'í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— <code>CLAUDE.md</code>ê°€ ìˆìœ¼ë©´ Claude Codeê°€ <strong>ëª¨ë“  ìš”ì²­</strong>ì— ìë™ìœ¼ë¡œ <code>&lt;system-reminder&gt;</code> íƒœê·¸ë¡œ ì£¼ì…. ì„¤ì • ë¶ˆí•„ìš” â€” íŒŒì¼ ì¡´ì¬ë§Œìœ¼ë¡œ ë™ì‘.',
        ex1: 'íŒ€ ì½”ë”© ìŠ¤íƒ ë‹¤ë“œ, ì•„í‚¤í…ì²˜ ê²°ì •, ê¸°ìˆ  ìŠ¤íƒ ì •ë³´ë¥¼ ì ì–´ë‘ë©´ ëª¨ë“  íŒ€ì›ì˜ ìš”ì²­ì— ìë™ ì ìš©ë¨',
        ex1tag: 'ì˜ˆì‹œ',
        ex2: 'ë©”ì‹œì§€ ë ˆë²¨ (system ì•„ë‹˜) â€” í”„ë¡œì íŠ¸ <em>ì»¨í…ìŠ¤íŠ¸</em>ì§€ Claudeì˜ <em>ì •ì²´ì„±</em>ì´ ì•„ë‹˜',
        ex2tag: 'ë ˆì´ì–´',
        fContent: 'CLAUDE.md ë‚´ìš©',
        fUserMessage: 'User Message',
      },
      outputStyle: {
        howTitle: 'âš¡ Claude Codeì—ì„œ ì‹¤ì œ ë™ì‘',
        howText: '<code>/output-style software-architect</code> ì‹¤í–‰ ì‹œ <code>system</code> ë°°ì—´ì— ìŠ¤íƒ€ì¼ ë¸”ë¡ì´ ì¶”ê°€ë¨. ì„¸ì…˜ì´ ëë‚  ë•Œê¹Œì§€ <strong>ëª¨ë“  ì‘ë‹µ</strong>ì— ì ìš©.',
        ex1: 'ì½”ë“œ ë¦¬ë·° ì„¸ì…˜ ì‹œì‘ ì „ "senior engineer" ìŠ¤íƒ€ì¼ ì„¤ì • â†’ ì´í›„ ëª¨ë“  ë‹µë³€ì´ ì•„í‚¤í…ì²˜ ê´€ì ìœ¼ë¡œ ë³€í•¨',
        ex1tag: 'ì˜ˆì‹œ',
        ex2: 'ì‹œìŠ¤í…œ ë ˆë²¨ â€” CLAUDE.md(ë©”ì‹œì§€)ì™€ ë‹¬ë¦¬ Claudeì˜ <em>ì •ì²´ì„±/í–‰ë™</em>ì„ ë³€ê²½',
        ex2tag: 'ë ˆì´ì–´',
        fName: 'ìŠ¤íƒ€ì¼ ì´ë¦„',
        fContent: 'ìŠ¤íƒ€ì¼ ì§€ì¹¨',
        fUserMessage: 'User Message',
      },
      slashCommand: {
        howTitle: 'âš¡ Claude Codeì—ì„œ ì‹¤ì œ ë™ì‘',
        howText: '<code>.claude/commands/review.md</code> íŒŒì¼ ìƒì„± â†’ <code>/review @file.js</code> ì…ë ¥ ì‹œ <code>{arg1}</code>ì´ ì¸ìˆ˜ë¡œ ì¹˜í™˜. <strong>Claudeê°€ ê²°ì •í•˜ëŠ” ê²Œ ì•„ë‹˜</strong> â€” ìˆœìˆ˜ ë¬¸ìì—´ ì¹˜í™˜.',
        ex1: 'ì½”ë“œ ë¦¬ë·°, PR ì²´í¬ë¦¬ìŠ¤íŠ¸, ë°°í¬ ì ˆì°¨ ë“± ë°˜ë³µ ì‘ì—…ì„ ëª…ì‹œì ìœ¼ë¡œ ì‹¤í–‰í•  ë•Œ',
        ex1tag: 'ì˜ˆì‹œ',
        ex2: 'Slash CommandëŠ” <em>ì‚¬ìš©ìê°€ ì§ì ‘ í˜¸ì¶œ</em>, Skillì€ <em>Claudeê°€ ììœ¨ íŒë‹¨</em>',
        ex2tag: 'vs Skill',
        fName: 'ì»¤ë§¨ë“œ ì´ë¦„',
        fTemplate: 'ì»¤ë§¨ë“œ í…œí”Œë¦¿ ({arg1} ì¹˜í™˜)',
        fArgs: 'ì¸ìˆ˜ ({arg1} ëŒ€ì²´ê°’)',
      },
      skill: {
        howTitle: 'âš¡ Claude Codeì—ì„œ ì‹¤ì œ ë™ì‘ (2ë‹¨ê³„)',
        flowStep1: 'ì‚¬ìš©ì: "git squash ì–´ë–»ê²Œ í•´?"',
        flowArrow1: 'â†“ description í•„ë“œì™€ ì‹œë§¨í‹± ë§¤ì¹­',
        flowStep2: 'ë§¤ì¹­ ì„±ê³µ â†’ tool_use: Skill { command: "git-helper" }',
        flowArrow2: 'â†“ SKILL.md ì „ì²´ ë‚´ìš© ì£¼ì…',
        flowStep3: 'tool_result: [ìŠ¤í‚¬ ë‚´ìš©]',
        flowArrow3: 'â†“',
        flowStep4: 'Claude: ìŠ¤í‚¬ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‘ë‹µ',
        warnText: '<strong>descriptionì´ ë¶€ì •í™•í•˜ë©´ ë§¤ì¹­ ì‹¤íŒ¨.</strong> "git, squash, commits, rebase" ê°™ì´ í‚¤ì›Œë“œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë‚˜ì—´í•´ì•¼ í•¨.',
        ex1: 'ì‹¤ì œ APIë¡œ ìŠ¤í‚¬ íš¨ê³¼ë¥¼ í™•ì¸ (ìŠ¤í‚¬ ë‚´ìš©ì„ systemì— ì£¼ì…í•˜ëŠ” ë‹¨ìˆœí™” ë²„ì „)',
        ex1tag: 'â–¶ Simulate',
        fName: 'ìŠ¤í‚¬ ì´ë¦„',
        fDescription: 'ë§¤ì¹­ì— ì‚¬ìš©í•  description',
        fContent: 'ìŠ¤í‚¬ ë‚´ìš© (SKILL.md ë³¸ë¬¸)',
        fUserMessage: 'User Message (ìŠ¤í‚¬ íŠ¸ë¦¬ê±°)',
      },
      subAgent: {
        howTitle: 'âš¡ Claude Codeì—ì„œ ì‹¤ì œ ë™ì‘ (API 2ë²ˆ í˜¸ì¶œ)',
        apiCall1: 'API Call #1 â€” ë©”ì¸ ëŒ€í™”',
        flowStep1: 'ì‚¬ìš©ì: "auth êµ¬í˜„ ë¶„ì„í•´ì¤˜"',
        flowArrow1: 'â†“ Claudeê°€ ë³µì¡í•œ ì‘ì—…ìœ¼ë¡œ íŒë‹¨',
        flowStep2: 'tool_use: Task { subagent_type: "Explore", prompt: "â€¦" }',
        apiCall2: 'API Call #2 â€” Sub-Agent (ì™„ì „ ê²©ë¦¬)',
        flowStep3: 'âš ï¸ ë©”ì¸ ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ì—†ìŒ',
        flowStep4: 'âœ… CLAUDE.mdëŠ” ì—¬ì „íˆ ì£¼ì…ë¨',
        flowStep5: 'Explore ì—ì´ì „íŠ¸ê°€ ììœ¨ì ìœ¼ë¡œ íƒìƒ‰/ë¶„ì„',
        flowArrow2: 'â†“ ê²°ê³¼ ë°˜í™˜',
        apiCall3: 'ë‹¤ì‹œ API Call #1',
        flowStep6: 'tool_result: [sub-agent ë¶„ì„ ê²°ê³¼]',
        flowStep7: 'Claude: ê²°ê³¼ ì¢…í•©í•˜ì—¬ ì‘ë‹µ',
        warnText: '<strong>ì»¨í…ìŠ¤íŠ¸ ë¸Œë¦¬ì§• ì—†ìŒ.</strong> delegation promptì— í•„ìš”í•œ ëª¨ë“  ì •ë³´ë¥¼ ëª…ì‹œí•´ì•¼ í•¨.',
        ex1: 'Sub-Agent ëŒ€í™”ë§Œ ë‹¨ë… ì‹¤í–‰í•˜ì—¬ delegation prompt íš¨ê³¼ í™•ì¸',
        ex1tag: 'â–¶ Run',
        fType: 'Sub-Agent íƒ€ì…',
        fPrompt: 'Delegation Prompt (sub-agentì—ê²Œ ì „ë‹¬)',
        fUserMessage: 'User Message (ë©”ì¸ ëŒ€í™” íŠ¸ë¦¬ê±°)',
      },
      inject: {
        claudeMd: 'messages[].content â†’ system-reminder',
        outputStyle: 'system[] â†’ additional text block',
        slashCommand: 'messages[].content â†’ command-message',
        skill: 'tool_result (Skill tool_use ì´í›„)',
        subAgent: 'ê²©ë¦¬ëœ ë³„ë„ API í˜¸ì¶œ (Task ë„êµ¬)',
      },
      btn: {
        send: 'Send to Claude â†’',
        simulate: 'â–¶ Simulate Effect',
        runSubAgent: 'â–¶ Run Sub-Agent',
      },
    },
  },
  en: {
    header: {
      history: 'History',
      historyTitle: 'Request history (last 10)',
      apiSaved: 'Saved',
      goHome: 'Go Home',
      logoSub: 'Prompt Mechanism Visualizer',
    },
    landing: {
      title: 'Welcome to Claude Inspector',
      subtitle: 'Select a mode to get started',
      simDesc: 'Build and test real API payloads for all 5 prompt mechanisms (CLAUDE.md, Output Style, Slash Command, Skill, Sub-Agent).',
      simReq: 'Requires: Anthropic API Key',
      proxyDesc: 'Intercept and visualize live API traffic from the Claude Code CLI. See exactly what payloads are exchanged during real usage.',
      proxyReq: 'Requires: Claude Code CLI',
      start: 'Get Started â†’',
    },
    history: {
      title: 'Request History',
      empty: 'No history yet<br><small>Entries appear after API calls</small>',
      noMsg: 'No message',
    },
    proxy: {
      title: 'Proxy Control',
      liveCapture: 'Live Capture',
      interceptTitle: 'âš¡ Live API Traffic Intercept',
      interceptDesc: 'Intercepts real API requests from the Claude Code CLI and visualizes them in real time.<br>Start the proxy, then run Claude Code with the command below.',
      port: 'Port',
      stopped: 'Stopped',
      running: 'Running on port {port}',
      runCommand: 'Run Command',
      startFirst: 'Start the proxy first',
      startProxy: 'Start Proxy',
      stopProxy: 'Stop Proxy',
      clear: 'Clear',
      capturedRequests: 'Captured Requests',
      noCaptures: 'No captured requests<br><small>Start the proxy and<br>run Claude Code</small>',
      startFail: 'Failed to start proxy: ',
      selectRequest: 'Select a request to<br>view its payload',
      noMessages: 'No messages array',
      waitingResponse: 'Waiting for responseâ€¦',
      noBody: 'No body',
      noResults: 'No results',
      msgCount: '{count} / {total}',
    },
    messages: {
      filterUser: 'Sent by user',
      filterTyped: 'Typed only',
      filterAssistant: 'Sent by Claude',
      filterAll: 'All',
      searchPlaceholder: 'ğŸ” Search... (âŒ˜F)',
      searchClear: 'Clear search',
    },
    analysis: {
      noMechanisms: 'No mechanisms detected<br><small>Plain API request or unsupported pattern</small>',
      claudeMdTitle: 'CLAUDE.md â€” system-reminder injection',
      claudeMdDesc: 'Claude Code wraps project/global CLAUDE.md contents in <system-reminder> tags and inserts them inside messages[]',
      outputStyleTitle: 'Output Style â€” system[] extra block',
      outputStyleDesc: 'Claude Code inserts an extra block in the system prompt array (controls model response style)',
      slashCmdTitle: 'â‘  Input â€” Slash Command',
      slashCmdDesc: 'When user types /{cmd}, Claude Code wraps it in <command-message> tags and injects it into the prompt',
      skillTitle: 'Skill (tool_use â†’ tool_result)',
      skillLinkedTitle: 'â‘¡ Execute â€” Skill (tool_use â†’ tool_result)',
      skillDesc: 'Claude invokes a skill via tool_use and receives the result via tool_result',
      skillLinkedDesc: 'Claude reads the slash command above and calls the matching skill via tool_use',
      noToolResult: 'No tool_result (in the next message or not yet received)',
      subAgentDesc: 'Claude creates an isolated sub-agent API request via the Task tool (runs in a separate context)',
      searchPlaceholder: 'ğŸ” Search... (âŒ˜F, Enter=next)',
    },
    mechDesc: {
      cm: {
        who: 'Auto-injected by Claude Code CLI (this app only displays)',
        what: 'Wraps CLAUDE.md file contents in <system-reminder> tags and inserts them inside messages[].',
      },
      sc: {
        who: 'Auto-wrapped by Claude Code CLI (this app only displays)',
        what: 'When a /command is typed, its contents are wrapped in <command-message> tags and injected into the user message.',
      },
      sk: {
        who: 'Auto-injected by Claude Code CLI (this app only displays)',
        what: 'When skills are configured, a "The following skills are available..." list is injected via <system-reminder>.',
      },
      sa: {
        who: 'Claude Code CLI creates a separate API call (this app only displays)',
        what: 'When Task tool is called, Claude Code creates an independent second API request to run the sub-agent.',
      },
      mc: {
        who: 'Claude calls MCP tool (tool_use)',
        what: 'Calls a Model Context Protocol tool via tool_use.',
      },
    },
    export: {
      skillNote: 'âš ï¸  Skill requires the full tool_use flow. The payload below is the runnable version from Simulate Effect (system injection variant).',
      subAgentNote: 'âš ï¸  Sub-Agent generates 2 API calls. The payload below is the standalone payload for API Call #2 (isolated sub-agent).',
    },
    form: {
      fileOpen: 'ğŸ“‚ Open File',
      fileElectronOnly: 'File open is only supported in the Electron app.',
    },
    copy: {
      json: 'Copy JSON',
      text: 'Copy Text',
      copy: 'Copy',
      copied: 'âœ“ Copied',
      response: 'Copy Response',
    },
    api: {
      sending: 'Sendingâ€¦',
      simulatingSkill: 'Simulating skillâ€¦',
      runningSubAgent: 'Running {type} sub-agentâ€¦',
    },
    apiInput: {
      placeholder: 'sk-ant-api03-â€¦  (auto-saved on input)',
    },
    search: {
      prev: 'Previous',
      next: 'Next',
    },
    mech: {
      claudeMd: {
        howTitle: 'âš¡ How it works in Claude Code',
        howText: 'If <code>CLAUDE.md</code> exists in the project root, Claude Code automatically injects it into <strong>every request</strong> via a <code>&lt;system-reminder&gt;</code> tag. No configuration needed â€” presence of the file is enough.',
        ex1: 'Team coding standards, architecture decisions, and tech stack info are automatically applied to every team member\'s request',
        ex1tag: 'Example',
        ex2: 'Message level (not system) â€” project <em>context</em>, not Claude\'s <em>identity</em>',
        ex2tag: 'Layer',
        fContent: 'CLAUDE.md Content',
        fUserMessage: 'User Message',
      },
      outputStyle: {
        howTitle: 'âš¡ How it works in Claude Code',
        howText: 'Running <code>/output-style software-architect</code> adds a style block to the <code>system</code> array. Applied to <strong>all responses</strong> for the rest of the session.',
        ex1: 'Set "senior engineer" style before a code review session â†’ all subsequent answers shift to an architectural perspective',
        ex1tag: 'Example',
        ex2: 'System level â€” unlike CLAUDE.md (message), this changes Claude\'s <em>identity/behavior</em>',
        ex2tag: 'Layer',
        fName: 'Style Name',
        fContent: 'Style Instructions',
        fUserMessage: 'User Message',
      },
      slashCommand: {
        howTitle: 'âš¡ How it works in Claude Code',
        howText: 'Create <code>.claude/commands/review.md</code> â†’ typing <code>/review @file.js</code> substitutes <code>{arg1}</code> with the argument. <strong>Not decided by Claude</strong> â€” pure string substitution.',
        ex1: 'Explicitly run repetitive tasks like code review, PR checklists, and deployment procedures',
        ex1tag: 'Example',
        ex2: 'Slash Command is <em>directly invoked by user</em>; Skill is <em>autonomously chosen by Claude</em>',
        ex2tag: 'vs Skill',
        fName: 'Command Name',
        fTemplate: 'Command Template ({arg1} substitution)',
        fArgs: 'Arguments ({arg1} replacement)',
      },
      skill: {
        howTitle: 'âš¡ How it works in Claude Code (2 steps)',
        flowStep1: 'User: "How do I git squash?"',
        flowArrow1: 'â†“ Semantic match against description field',
        flowStep2: 'Match found â†’ tool_use: Skill { command: "git-helper" }',
        flowArrow2: 'â†“ Inject full SKILL.md content',
        flowStep3: 'tool_result: [skill content]',
        flowArrow3: 'â†“',
        flowStep4: 'Claude: responds using skill context',
        warnText: '<strong>Inaccurate description causes match failure.</strong> List keywords explicitly like "git, squash, commits, rebase".',
        ex1: 'Verify skill effect with real API (simplified version injecting skill content into system)',
        ex1tag: 'â–¶ Simulate',
        fName: 'Skill Name',
        fDescription: 'Description for matching',
        fContent: 'Skill Content (SKILL.md body)',
        fUserMessage: 'User Message (skill trigger)',
      },
      subAgent: {
        howTitle: 'âš¡ How it works in Claude Code (2 API calls)',
        apiCall1: 'API Call #1 â€” Main Conversation',
        flowStep1: 'User: "Analyze the auth implementation"',
        flowArrow1: 'â†“ Claude judges this as a complex task',
        flowStep2: 'tool_use: Task { subagent_type: "Explore", prompt: "â€¦" }',
        apiCall2: 'API Call #2 â€” Sub-Agent (Fully Isolated)',
        flowStep3: 'âš ï¸ No main conversation context',
        flowStep4: 'âœ… CLAUDE.md is still injected',
        flowStep5: 'Explore agent autonomously explores/analyzes',
        flowArrow2: 'â†“ Return result',
        apiCall3: 'Back to API Call #1',
        flowStep6: 'tool_result: [sub-agent analysis result]',
        flowStep7: 'Claude: synthesizes result and responds',
        warnText: '<strong>No context bridging.</strong> All necessary information must be specified in the delegation prompt.',
        ex1: 'Run only the sub-agent conversation to verify delegation prompt effect',
        ex1tag: 'â–¶ Run',
        fType: 'Sub-Agent Type',
        fPrompt: 'Delegation Prompt (passed to sub-agent)',
        fUserMessage: 'User Message (main conversation trigger)',
      },
      inject: {
        claudeMd: 'messages[].content â†’ system-reminder',
        outputStyle: 'system[] â†’ additional text block',
        slashCommand: 'messages[].content â†’ command-message',
        skill: 'tool_result (after Skill tool_use)',
        subAgent: 'Isolated separate API call (Task tool)',
      },
      btn: {
        send: 'Send to Claude â†’',
        simulate: 'â–¶ Simulate Effect',
        runSubAgent: 'â–¶ Run Sub-Agent',
      },
    },
  },
};

const i18n = {
  locale: localStorage.getItem('ci-lang') || (navigator.language.startsWith('ko') ? 'ko' : 'en'),
  t(key, vars = {}) {
    const val = key.split('.').reduce((o, k) => o?.[k], LOCALES[this.locale]) ?? key;
    return Object.entries(vars).reduce((s, [k, v]) => s.replace(`{${k}}`, v), val);
  },
  setLocale(lang) {
    this.locale = lang;
    localStorage.setItem('ci-lang', lang);
    applyI18n();
  }
};

function applyI18n() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = i18n.t(el.dataset.i18n);
  });
  document.querySelectorAll('[data-i18n-html]').forEach(el => {
    el.innerHTML = i18n.t(el.dataset.i18nHtml);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = i18n.t(el.dataset.i18nPlaceholder);
  });
  document.querySelectorAll('[data-i18n-title]').forEach(el => {
    el.title = i18n.t(el.dataset.i18nTitle);
  });
  // lang toggle button text
  const btn = document.getElementById('langToggleBtn');
  if (btn) btn.textContent = i18n.locale === 'ko' ? 'EN' : 'í•œ';
  // re-render dynamic content that depends on locale
  renderHistory();
  // re-render simulator form if visible
  if (document.getElementById('normalPanels').style.display !== 'none' && current) {
    const savedCfg = collectCfg();
    renderForm(current);
    for (const [k, v] of Object.entries(savedCfg)) {
      const el = document.getElementById('f-' + k);
      if (el) el.value = v;
    }
    updatePreview();
  }
  if (proxyCaptures.length > 0) {
    renderProxyList();
    if (selectedProxyId !== null) renderProxyDetail();
  } else {
    const list = document.getElementById('proxyList');
    if (list) list.innerHTML = `<div class="hist-empty">${i18n.t('proxy.noCaptures')}</div>`;
  }
  if (!proxyRunning) {
    const statusText = document.getElementById('proxyStatusText');
    if (statusText && !proxyRunning) statusText.textContent = i18n.t('proxy.stopped');
    const cmdEl = document.getElementById('proxyCmdText');
    if (cmdEl && !proxyRunning) cmdEl.textContent = i18n.t('proxy.startFirst');
  }
}

// â”€â”€â”€ Mechanism definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMechanisms() {
  const t = (k, v) => i18n.t(k, v);
  return {
  'claude-md': {
    label: 'CLAUDE.md',
    inject: t('mech.inject.claudeMd'),
    sendable: true,
    howHtml: `
      <div class="how-title">${t('mech.claudeMd.howTitle')}</div>
      <div class="how-text">${t('mech.claudeMd.howText')}</div>
      <div class="example-row">
        <span class="ex-tag">${t('mech.claudeMd.ex1tag')}</span>
        <span>${t('mech.claudeMd.ex1')}</span>
      </div>
      <div class="example-row">
        <span class="ex-tag">${t('mech.claudeMd.ex2tag')}</span>
        <span>${t('mech.claudeMd.ex2')}</span>
      </div>`,
    fields: [
      { id:'content', label:t('mech.claudeMd.fContent'), type:'textarea', tall:true, fileBtn:true,
        val:`# Project Standards\n\n## Tech Stack\n- TypeScript (strict mode)\n- Bun runtime\n- React + Vite frontend\n\n## Conventions\n- Named exports only\n- File naming: kebab-case\n- Write tests for all features\n- No console.log in production` },
      { id:'userMessage', label:t('mech.claudeMd.fUserMessage'), type:'textarea',
        val:'How should I structure my TypeScript project?' }
    ]
  },

  'output-style': {
    label: 'Output Style',
    inject: t('mech.inject.outputStyle'),
    sendable: true,
    howHtml: `
      <div class="how-title">${t('mech.outputStyle.howTitle')}</div>
      <div class="how-text">${t('mech.outputStyle.howText')}</div>
      <div class="example-row">
        <span class="ex-tag">${t('mech.outputStyle.ex1tag')}</span>
        <span>${t('mech.outputStyle.ex1')}</span>
      </div>
      <div class="example-row">
        <span class="ex-tag">${t('mech.outputStyle.ex2tag')}</span>
        <span>${t('mech.outputStyle.ex2')}</span>
      </div>`,
    fields: [
      { id:'name', label:t('mech.outputStyle.fName'), type:'input', val:'software-architect' },
      { id:'content', label:t('mech.outputStyle.fContent'), type:'textarea', tall:true,
        val:`You are operating as a senior software architect.\n\n## Response Guidelines\n- Lead with architectural decisions, not implementation details\n- Highlight trade-offs explicitly\n- Reference design patterns by name (Factory, Observer, CQRS)\n- Keep responses concise but precise` },
      { id:'userMessage', label:t('mech.outputStyle.fUserMessage'), type:'textarea',
        val:'Should I use Redux or React Context for state management?' }
    ]
  },

  'slash-command': {
    label: 'Slash Command',
    inject: t('mech.inject.slashCommand'),
    sendable: true,
    howHtml: `
      <div class="how-title">${t('mech.slashCommand.howTitle')}</div>
      <div class="how-text">${t('mech.slashCommand.howText')}</div>
      <div class="example-row">
        <span class="ex-tag">${t('mech.slashCommand.ex1tag')}</span>
        <span>${t('mech.slashCommand.ex1')}</span>
      </div>
      <div class="example-row">
        <span class="ex-tag">${t('mech.slashCommand.ex2tag')}</span>
        <span>${t('mech.slashCommand.ex2')}</span>
      </div>`,
    fields: [
      { id:'name', label:t('mech.slashCommand.fName'), type:'input', val:'review' },
      { id:'template', label:t('mech.slashCommand.fTemplate'), type:'textarea', tall:true,
        val:`Perform a thorough code review of the following code:\n\n{arg1}\n\nFocus on:\n1. Logic errors and off-by-one bugs\n2. Security vulnerabilities\n3. Performance issues\n4. Code clarity and naming` },
      { id:'args', label:t('mech.slashCommand.fArgs'), type:'textarea',
        val:`function calculateTotal(items) {\n  let total = 0;\n  for (var i = 0; i <= items.length; i++) {\n    total += items[i].price;\n  }\n  return total;\n}` }
    ]
  },

  'skill': {
    label: 'Skill',
    inject: t('mech.inject.skill'),
    sendable: false, simulatable: true,
    howHtml: `
      <div class="how-title">${t('mech.skill.howTitle')}</div>
      <div class="flow">
        <div class="flow-step">${t('mech.skill.flowStep1')}</div>
        <div class="flow-arrow">${t('mech.skill.flowArrow1')}</div>
        <div class="flow-step hi-purple">${t('mech.skill.flowStep2')}</div>
        <div class="flow-arrow">${t('mech.skill.flowArrow2')}</div>
        <div class="flow-step hi-purple">${t('mech.skill.flowStep3')}</div>
        <div class="flow-arrow">${t('mech.skill.flowArrow3')}</div>
        <div class="flow-step">${t('mech.skill.flowStep4')}</div>
      </div>
      <div class="warn-row" style="margin-top:6px">
        <span class="w-icon">âš ï¸</span>
        <span>${t('mech.skill.warnText')}</span>
      </div>
      <div class="example-row">
        <span class="ex-tag">${t('mech.skill.ex1tag')}</span>
        <span>${t('mech.skill.ex1')}</span>
      </div>`,
    fields: [
      { id:'name', label:t('mech.skill.fName'), type:'input', val:'git-helper' },
      { id:'description', label:t('mech.skill.fDescription'), type:'input',
        val:'Git workflows, commits, branches, rebasing, squashing, version control' },
      { id:'content', label:t('mech.skill.fContent'), type:'textarea', tall:true, fileBtn:true,
        val:`# Git Helper\n\nWhen invoked:\n1. Analyze the git-related request\n2. Provide exact commands with explanations\n3. Warn about destructive operations (reset --hard, force push)\n4. Suggest safe alternatives\n\nAlways include:\n- The exact git command(s)\n- What each command does\n- Any potential risks` },
      { id:'userMessage', label:t('mech.skill.fUserMessage'), type:'textarea',
        val:'How do I squash my last 3 commits?' }
    ]
  },

  'sub-agent': {
    label: 'Sub-Agent',
    inject: t('mech.inject.subAgent'),
    sendable: false, simulatable: true,
    howHtml: `
      <div class="how-title">${t('mech.subAgent.howTitle')}</div>
      <div class="flow">
        <div class="flow-api-label">${t('mech.subAgent.apiCall1')}</div>
        <div class="flow-step">${t('mech.subAgent.flowStep1')}</div>
        <div class="flow-arrow">${t('mech.subAgent.flowArrow1')}</div>
        <div class="flow-step hi-orange">${t('mech.subAgent.flowStep2')}</div>
        <hr class="flow-divider">
        <div class="flow-api-label">${t('mech.subAgent.apiCall2')}</div>
        <div class="flow-step hi-yellow">${t('mech.subAgent.flowStep3')}</div>
        <div class="flow-step">${t('mech.subAgent.flowStep4')}</div>
        <div class="flow-step">${t('mech.subAgent.flowStep5')}</div>
        <div class="flow-arrow">${t('mech.subAgent.flowArrow2')}</div>
        <div class="flow-api-label">${t('mech.subAgent.apiCall3')}</div>
        <div class="flow-step hi-orange">${t('mech.subAgent.flowStep6')}</div>
        <div class="flow-step">${t('mech.subAgent.flowStep7')}</div>
      </div>
      <div class="warn-row" style="margin-top:6px">
        <span class="w-icon">âš ï¸</span>
        <span>${t('mech.subAgent.warnText')}</span>
      </div>
      <div class="example-row">
        <span class="ex-tag">${t('mech.subAgent.ex1tag')}</span>
        <span>${t('mech.subAgent.ex1')}</span>
      </div>`,
    fields: [
      { id:'type', label:t('mech.subAgent.fType'), type:'select',
        options:['Explore','general-purpose','Plan','software-architect'], val:'Explore' },
      { id:'prompt', label:t('mech.subAgent.fPrompt'), type:'textarea', tall:true,
        val:`Analyze the authentication flow in this codebase.\n\nContext: OAuth 2.0 with PKCE, Next.js application.\n\nFocus on:\n1. Token storage mechanisms\n2. Refresh token rotation logic\n3. Background token refresh handling\n\nReport back with a structured summary.` },
      { id:'userMessage', label:t('mech.subAgent.fUserMessage'), type:'textarea',
        val:'Analyze our authentication implementation for security issues.' }
    ]
  }
  };
}

// â”€â”€â”€ Feature flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHOW_SIMULATOR = false; // trueë¡œ ë°”ê¾¸ë©´ Simulator íƒ­/ì¹´ë“œ í™œì„±í™”

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let current = 'claude-md';
let lastResponseText = '';
let currentPayload = null;
let mdEnabled = false;
let exportLang = 'curl';
let sessionHistory = [];

// â”€â”€â”€ Payload builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPayload(mech, cfg) {
  const sys = "You are Claude Code, Anthropic's official CLI for Claude.";
  const model = document.getElementById('modelSel').value;
  const msg = cfg.userMessage || '';

  if (mech === 'claude-md') {
    return {
      model, max_tokens: 1024, system: sys,
      messages: [{ role: 'user', content: [{ type: 'text',
        text: `<system-reminder>\nAs you answer the user's questions, you can use the following context:\n# claudeMd\nCodebase and user instructions are shown below. Be sure to adhere to these instructions. IMPORTANT: These instructions OVERRIDE any default behavior and you MUST follow them exactly as written.\n\nContents of /path/to/CLAUDE.md (project instructions, checked into the codebase):\n\n${cfg.content || ''}\n</system-reminder>\n\n${msg}`
      }] }]
    };
  }
  if (mech === 'output-style') {
    return {
      model, max_tokens: 1024,
      system: [
        { type: 'text', text: sys },
        { type: 'text', text: `# Output Style: ${cfg.name || 'custom'}\n\n${cfg.content || ''}` }
      ],
      messages: [{ role: 'user', content: msg }]
    };
  }
  if (mech === 'slash-command') {
    const expanded = (cfg.template || '').replace(/\{arg1\}/g, cfg.args || '');
    return {
      model, max_tokens: 1024, system: sys,
      messages: [{ role: 'user', content: [{ type: 'text',
        text: `<command-message>${cfg.name || 'command'} is runningâ€¦</command-message>\n\n${expanded}${cfg.args ? `\n\nARGUMENTS: ${cfg.args}` : ''}`
      }] }]
    };
  }
  if (mech === 'skill') {
    return {
      model, max_tokens: 1024, system: sys,
      messages: [
        { role: 'user', content: msg },
        { role: 'assistant', content: [{ type: 'tool_use', id: 'toolu_skill_01', name: 'Skill', input: { command: cfg.name || 'skill-name' } }] },
        { role: 'user',      content: [{ type: 'tool_result', tool_use_id: 'toolu_skill_01', content: cfg.content || '' }] }
      ]
    };
  }
  if (mech === 'sub-agent') {
    return {
      'âš¡ API Call #1 â€” Main Conversation': {
        model, max_tokens: 1024, system: sys,
        messages: [
          { role: 'user', content: msg },
          { role: 'assistant', content: [{ type: 'tool_use', id: 'toolu_task_01', name: 'Task',
              input: { subagent_type: cfg.type || 'Explore', prompt: cfg.prompt || '' } }] }
        ]
      },
      'ğŸ¤– API Call #2 â€” Sub-Agent (Isolated)': {
        model, max_tokens: 2048,
        system: `[${cfg.type || 'Explore'} specialized system prompt]\nâš ï¸  No main conversation context\nâœ… CLAUDE.md injected here too`,
        messages: [{ role: 'user', content: cfg.prompt || '' }]
      }
    };
  }
  return {};
}

// â”€â”€â”€ Sendable payload (for Export + simulate calls) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSendablePayload(mech, cfg) {
  const model = document.getElementById('modelSel').value;
  if (mech === 'skill') {
    return {
      model, max_tokens: 1024,
      system: [
        { type: 'text', text: "You are Claude Code, Anthropic's official CLI for Claude." },
        { type: 'text', text: `# Active Skill: ${cfg.name}\n\nDescription: ${cfg.description}\n\n${cfg.content}` }
      ],
      messages: [{ role: 'user', content: cfg.userMessage || '' }]
    };
  }
  if (mech === 'sub-agent') {
    return {
      model, max_tokens: 1024,
      system: `You are a ${cfg.type || 'general-purpose'} sub-agent. You operate in an isolated conversation with no access to the main conversation history.`,
      messages: [{ role: 'user', content: cfg.prompt || '' }]
    };
  }
  return buildPayload(mech, cfg);
}

// â”€â”€â”€ Collect config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function collectCfg() {
  const cfg = {};
  const M = getMechanisms();
  for (const f of M[current].fields) {
    const el = document.getElementById('f-' + f.id);
    cfg[f.id] = el ? el.value : (f.val || '');
  }
  return cfg;
}

// â”€â”€â”€ JSON Tree Viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _jtId = 0;
function buildJsonHtml(val, depth) {
  depth = depth || 0;
  if (val === null) return '<span class="jt-null">null</span>';
  if (val === true || val === false) return `<span class="jt-bool">${val}</span>`;
  if (typeof val === 'number') return `<span class="jt-num">${val}</span>`;
  if (typeof val === 'string') return `<span class="jt-str">"${esc(val)}"</span>`;

  const isArr = Array.isArray(val);
  const entries = isArr ? val.map((v, i) => [null, v]) : Object.entries(val);
  const open = isArr ? '[' : '{'; const close = isArr ? ']' : '}';
  if (entries.length === 0) return `<span>${open}${close}</span>`;

  const id = `jt${++_jtId}`;
  const label = isArr ? `${entries.length}` : `${entries.length}`;
  const rows = entries.map(([k, v], i) => {
    const comma = i < entries.length - 1 ? '<span style="color:var(--dim)">,</span>' : '';
    const keyPart = k !== null ? `<span class="jt-key">"${esc(String(k))}"</span><span style="color:var(--dim)">: </span>` : '';
    return `<div class="jt-row" style="padding-left:${(depth + 1) * 16}px">${keyPart}${buildJsonHtml(v, depth + 1)}${comma}</div>`;
  }).join('');
  const typeTag = isArr ? `[${label}]` : `{${label}}`;

  return `<span>`
    + `<span class="jt-btn" id="${id}-btn" onclick="jtToggle('${id}')">â–¼</span>`
    + `<span style="color:var(--dim)">${open}</span>`
    + `<span class="jt-tag" id="${id}-s" onclick="jtToggle('${id}')" style="display:none">${typeTag}</span>`
    + `<span id="${id}-b">`
    +   rows
    +   `<div style="padding-left:${depth * 16}px"><span style="color:var(--dim)">${close}</span></div>`
    + `</span>`
    + `</span>`;
}

function jtToggle(id) {
  const body = document.getElementById(`${id}-b`);
  const summary = document.getElementById(`${id}-s`);
  const btn = document.getElementById(`${id}-btn`);
  const open = body.style.display !== 'none';
  body.style.display = open ? 'none' : '';
  summary.style.display = open ? '' : 'none';
  btn.textContent = open ? 'â–¶' : 'â–¼';
}

function renderJsonTree(container, data) {
  let obj;
  try { obj = typeof data === 'string' ? JSON.parse(data) : data; }
  catch (e) { container.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2); return; }
  container.innerHTML = buildJsonHtml(obj, 0);
}

// â”€â”€â”€ Update preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePreview() {
  const cfg = collectCfg();
  const payload = buildPayload(current, cfg);
  currentPayload = payload;
  const code = document.getElementById('payloadCode');
  renderJsonTree(code, payload);

  // Size + token estimate
  const bytes = new TextEncoder().encode(JSON.stringify(payload)).length;
  const kb = (bytes / 1024).toFixed(1);
  const tokens = Math.ceil(bytes / 3.5);
  document.getElementById('sizePill').textContent = `${kb} KB Â· ~${tokens.toLocaleString()} tok`;

  // Update export tab if visible
  if (!document.getElementById('pv-export').classList.contains('hidden')) {
    updateExport(current, cfg);
  }
}

// â”€â”€â”€ Render form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderForm(mech) {
  const M = getMechanisms();
  const def = M[mech];
  document.getElementById('panelTitle').textContent = def.label;
  document.getElementById('injectChip').textContent = def.inject;

  let html = `<div class="how-box">${def.howHtml}</div>`;

  for (const f of def.fields) {
    const fileBtnHtml = f.fileBtn
      ? `<button class="file-btn" onclick="openFilePicker('f-${f.id}')">${i18n.t('form.fileOpen')}</button>`
      : '';

    if (f.type === 'textarea') {
      html += `<div class="field"><label><span>${f.label}</span>${fileBtnHtml}</label>
        <textarea id="f-${f.id}" class="${f.tall?'tall':''}" oninput="updatePreview()">${esc(f.val||'')}</textarea></div>`;
    } else if (f.type === 'input') {
      html += `<div class="field"><label><span>${f.label}</span>${fileBtnHtml}</label>
        <input type="text" id="f-${f.id}" value="${esc(f.val||'')}" oninput="updatePreview()"></div>`;
    } else if (f.type === 'select') {
      const opts = (f.options||[]).map(o=>`<option${o===f.val?' selected':''}>${o}</option>`).join('');
      html += `<div class="field"><label><span>${f.label}</span></label>
        <select id="f-${f.id}" onchange="updatePreview()">${opts}</select></div>`;
    }
  }

  document.getElementById('configBody').innerHTML = html;

  // Footer
  const footer = document.getElementById('configFooter');
  const copyBtn = `<button class="btn btn-copy" onclick="copyPayload()">${i18n.t('copy.json')}</button>`;
  if (def.sendable) {
    footer.innerHTML = copyBtn +
      `<button class="btn btn-send" id="actionBtn" onclick="sendToApi()">${i18n.t('mech.btn.send')}</button>`;
  } else if (mech === 'skill') {
    footer.innerHTML = copyBtn +
      `<button class="btn btn-sim" id="actionBtn" onclick="simulateSkill()">${i18n.t('mech.btn.simulate')}</button>`;
  } else if (mech === 'sub-agent') {
    footer.innerHTML = copyBtn +
      `<button class="btn btn-sa" id="actionBtn" onclick="simulateSubAgent()">${i18n.t('mech.btn.runSubAgent')}</button>`;
  }
}

// â”€â”€â”€ Switch mechanism â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchM(mech) {
  const landing   = document.getElementById('landingPanel');
  const normal    = document.getElementById('normalPanels');
  const proxy     = document.getElementById('proxyPanel');
  const tabNav    = document.getElementById('tabNav');
  const apiGroup  = document.getElementById('apiGroup');
  const modelSel  = document.getElementById('modelSel');
  const histBtn   = document.getElementById('histToggleBtn');

  if (mech === 'home') {
    landing.style.display  = 'flex';
    normal.style.display   = 'none';
    proxy.style.display    = 'none';
    tabNav.style.display   = 'none';
    if (apiGroup) apiGroup.style.display = 'none';
    if (modelSel) modelSel.style.display = 'none';
    if (histBtn)  histBtn.style.display  = 'none';
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    return;
  }

  landing.style.display = 'none';
  tabNav.style.display  = 'flex';
  if (modelSel) modelSel.style.display = '';

  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.m === mech));

  if (mech === 'proxy') {
    normal.style.display = 'none';
    proxy.style.display  = 'flex';
    if (apiGroup) apiGroup.style.display = 'none';
    if (modelSel) modelSel.style.display = 'none';
    if (histBtn)  histBtn.style.display  = 'none';
    return;
  }

  normal.style.display = 'flex';
  proxy.style.display  = 'none';
  if (apiGroup) apiGroup.style.display = 'flex';
  if (histBtn)  histBtn.style.display  = '';

  current = mech;
  renderForm(mech);
  updatePreview();
  showPTab('payload');
  document.getElementById('livePill').style.display = 'none';
  document.getElementById('respToolbar').style.display = 'none';
  document.getElementById('resp-view').innerHTML = '';
}

// â”€â”€â”€ Preview tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPTab(tab) {
  ['payload', 'response', 'export'].forEach(t => {
    document.getElementById('pv-' + t).classList.toggle('hidden', t !== tab);
    document.getElementById('ptab-' + t).classList.toggle('active', t === tab);
  });
  if (tab === 'export') {
    const cfg = collectCfg();
    updateExport(current, cfg);
  }
}

// â”€â”€â”€ Copy payload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyPayload() {
  const text = JSON.stringify(currentPayload, null, 2);
  navigator.clipboard.writeText(text).then(() => {
    document.querySelectorAll('.btn-copy, [onclick="copyPayload()"]').forEach(b => {
      const o = b.textContent; b.textContent = i18n.t('copy.copied');
      setTimeout(() => { b.textContent = o; }, 1500);
    });
  });
}

// â”€â”€â”€ Core send function â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callApi(payload, loadingMsg = i18n.t('api.sending')) {
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) {
    const inp = document.getElementById('apiKey');
    inp.focus(); inp.style.borderColor = 'var(--red)';
    setTimeout(() => { inp.style.borderColor = ''; }, 2000);
    return false;
  }

  const btn = document.getElementById('actionBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = `<span class="spin"></span> ${loadingMsg}`; }

  document.getElementById('resp-view').innerHTML =
    `<div style="color:var(--dim);padding-top:4px"><span class="spin"></span> ${loadingMsg}</div>`;
  document.getElementById('respToolbar').style.display = 'none';
  showPTab('response');

  try {
    const data = await window.electronAPI.sendToClaude(payload, apiKey);

    if (data.error) {
      document.getElementById('resp-view').innerHTML =
        `<div class="resp-err">Error: ${esc(data.error)}</div>`;
    } else if (data.response) {
      const r = data.response;
      lastResponseText = r.content?.filter(c => c.type === 'text').map(c => c.text).join('\n') || '';
      document.getElementById('resp-view').innerHTML =
        `<div class="json-tree-view" id="respJsonTree" style="flex:1;overflow:auto"></div>`;
      renderJsonTree(document.getElementById('respJsonTree'), r);
      document.getElementById('respToolbar').style.display = 'flex';
      document.getElementById('livePill').style.display = 'flex';
      saveHistory(current, collectCfg());
    }
    return true;
  } catch (e) {
    document.getElementById('resp-view').innerHTML =
      `<div class="resp-err">Network error: ${esc(e.message)}</div>`;
    return false;
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = btn.className.includes('btn-send') ? i18n.t('mech.btn.send')
                    : btn.className.includes('btn-sim') ? i18n.t('mech.btn.simulate')
                    : i18n.t('mech.btn.runSubAgent');
    }
  }
}

// â”€â”€â”€ Send (direct mechanisms) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendToApi() {
  const cfg = collectCfg();
  callApi(buildPayload(current, cfg));
}

// â”€â”€â”€ Simulate Skill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function simulateSkill() {
  const cfg = collectCfg();
  callApi(buildSendablePayload('skill', cfg), i18n.t('api.simulatingSkill'));
}

// â”€â”€â”€ Simulate Sub-Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function simulateSubAgent() {
  const cfg = collectCfg();
  callApi(buildSendablePayload('sub-agent', cfg), i18n.t('api.runningSubAgent', { type: cfg.type || 'Explore' }));
}

// â”€â”€â”€ Copy response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyResponse() {
  navigator.clipboard.writeText(lastResponseText).then(() => {
    const btn = document.querySelector('.resp-copy');
    if (btn) { btn.textContent = i18n.t('copy.copied'); setTimeout(() => { btn.textContent = i18n.t('copy.response'); }, 1500); }
  });
}

// â”€â”€â”€ Markdown toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResponseContent(text) {
  const container = document.getElementById('respText');
  if (!container) return;
  if (mdEnabled && typeof marked !== 'undefined') {
    container.innerHTML = marked.parse(text);
    container.className = 'resp-text md-rendered';
  } else {
    container.textContent = text;
    container.className = 'resp-text';
  }
}

function toggleMd() {
  mdEnabled = !mdEnabled;
  const btn = document.getElementById('mdToggleBtn');
  if (btn) btn.classList.toggle('active', mdEnabled);
  renderResponseContent(lastResponseText);
}

// â”€â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateCurl(payload) {
  const body = JSON.stringify(payload, null, 2).replace(/'/g, "'\\''");
  return `curl https://api.anthropic.com/v1/messages \\
  -H "x-api-key: $ANTHROPIC_API_KEY" \\
  -H "anthropic-version: 2023-06-01" \\
  -H "content-type: application/json" \\
  -d '${body}'`;
}

function generatePython(payload) {
  const json = JSON.stringify(payload, null, 2);
  return `import json, anthropic

client = anthropic.Anthropic()

payload = json.loads("""
${json}
""")

response = client.messages.create(**payload)
print(response.content[0].text)`;
}

function generateTypeScript(payload) {
  const obj = JSON.stringify(payload, null, 2);
  return `import Anthropic from "@anthropic-ai/sdk";

const client = new Anthropic();

const response = await client.messages.create(${obj});

console.log(response.content[0].text);`;
}

function updateExport(mech, cfg) {
  const code = document.getElementById('exportCode');
  if (!code) return;

  const payload = buildSendablePayload(mech, cfg);

  // Note for skill/sub-agent
  const note = document.getElementById('expNote');
  if (note) {
    if (mech === 'skill') {
      note.style.display = 'block';
      note.textContent = i18n.t('export.skillNote');
    } else if (mech === 'sub-agent') {
      note.style.display = 'block';
      note.textContent = i18n.t('export.subAgentNote');
    } else {
      note.style.display = 'none';
    }
  }

  let text = '';
  if (exportLang === 'curl') {
    text = generateCurl(payload);
    code.className = 'language-bash';
  } else if (exportLang === 'python') {
    text = generatePython(payload);
    code.className = 'language-python';
  } else {
    text = generateTypeScript(payload);
    code.className = 'language-typescript';
  }

  code.textContent = text;
  hljs.highlightElement(code);
}

function showExportLang(lang) {
  exportLang = lang;
  document.querySelectorAll('.exp-tab').forEach(b => {
    b.classList.toggle('active', b.dataset.lang === lang);
  });
  const cfg = collectCfg();
  updateExport(current, cfg);
}

function copyExport() {
  const code = document.getElementById('exportCode');
  if (!code) return;
  navigator.clipboard.writeText(code.textContent).then(() => {
    const btns = document.querySelectorAll('[onclick="copyExport()"]');
    btns.forEach(b => {
      const o = b.textContent; b.textContent = 'âœ“';
      setTimeout(() => { b.textContent = o; }, 1500);
    });
  });
}

// â”€â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BADGE_STYLES = {
  'claude-md':    { bg: 'var(--green)',  color: '#000', label: 'MD' },
  'output-style': { bg: 'var(--blue)',   color: '#000', label: 'ST' },
  'slash-command':{ bg: 'var(--yellow)', color: '#000', label: '/'  },
  'skill':        { bg: 'var(--purple)', color: '#fff', label: 'SK' },
  'sub-agent':    { bg: 'var(--orange)', color: '#000', label: 'SA' },
};

function mechBadge(mech) {
  const s = BADGE_STYLES[mech] || { bg: 'var(--border)', color: 'var(--text)', label: '?' };
  return `<span style="background:${s.bg};color:${s.color};border-radius:3px;padding:1px 5px;font-size:9px;font-weight:700;margin-right:5px;font-family:'SF Mono',monospace">${s.label}</span>`;
}

function saveHistory(mech, cfg) {
  const M = getMechanisms();
  const def = M[mech];
  const userMsg = (cfg.userMessage || cfg.prompt || '').trim();
  const entry = {
    id: Date.now(),
    ts: new Date().toLocaleTimeString(i18n.locale === 'ko' ? 'ko-KR' : 'en-US', { hour: '2-digit', minute: '2-digit' }),
    mech,
    mechLabel: def.label,
    userMsg: userMsg.slice(0, 60) + (userMsg.length > 60 ? 'â€¦' : ''),
    cfg: JSON.parse(JSON.stringify(cfg)),
  };
  sessionHistory.unshift(entry);
  if (sessionHistory.length > 10) sessionHistory.pop();
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById('histList');
  const countEl = document.getElementById('histCount');
  if (!list) return;
  if (countEl) countEl.textContent = `${sessionHistory.length} / 10`;
  if (sessionHistory.length === 0) {
    list.innerHTML = `<div class="hist-empty">${i18n.t('history.empty')}</div>`;
    return;
  }
  list.innerHTML = sessionHistory.map(e => `
    <div class="hist-entry" onclick="restoreHistory(${e.id})">
      <div class="hist-mech">${mechBadge(e.mech)}<span>${esc(e.mechLabel)}</span></div>
      <div class="hist-msg">${e.userMsg ? esc(e.userMsg) : `<em style="opacity:.5">${i18n.t('history.noMsg')}</em>`}</div>
      <div class="hist-time">${e.ts}</div>
    </div>
  `).join('');
}

function restoreHistory(id) {
  const entry = sessionHistory.find(e => e.id === id);
  if (!entry) return;
  switchM(entry.mech);
  for (const [k, v] of Object.entries(entry.cfg)) {
    const el = document.getElementById('f-' + k);
    if (el) el.value = v;
  }
  updatePreview();
}

function toggleHistory() {
  const panel = document.getElementById('histPanel');
  const btn = document.getElementById('histToggleBtn');
  const isHidden = panel.classList.contains('hidden');
  panel.classList.toggle('hidden', !isHidden);
  btn.classList.toggle('active', isHidden);
}

// â”€â”€â”€ File picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openFilePicker(fieldId) {
  if (!window.electronAPI || !window.electronAPI.openFile) {
    alert(i18n.t('form.fileElectronOnly'));
    return;
  }
  const content = await window.electronAPI.openFile();
  if (content !== null && content !== undefined) {
    const el = document.getElementById(fieldId);
    if (el) { el.value = content; updatePreview(); }
  }
}

// â”€â”€â”€ API key (with localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onApiKeyChange() {
  const v = document.getElementById('apiKey').value;
  localStorage.setItem('ci-api-key', v);
  const ok = v.trim().startsWith('sk-ant');
  document.getElementById('apiDot').className = 'api-dot' + (ok ? ' ok' : '');
  document.getElementById('apiSaved').style.display = v.trim() ? 'inline' : 'none';
}

// â”€â”€â”€ Util â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function escAttr(s) {
  return esc(s).replace(/"/g,'&quot;');
}

// â”€â”€â”€ Proxy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let proxyCaptures = [];
let selectedProxyId = null;
let proxyDetailTab = 'messages';
let msgFilter = 'user';
let msgSearchQuery = '';
let proxyDetailSearch = '';
let proxyDetailMechFilter = null;
let proxyRunning = false;
let proxyActualPort = 9090;

function updateProxyCmd() {
  const port = document.getElementById('proxyPort').value || '9090';
  const cmdEl = document.getElementById('proxyCmdText');
  if (cmdEl && proxyRunning) {
    cmdEl.style.color = 'var(--green)';
    cmdEl.textContent = `ANTHROPIC_BASE_URL=http://localhost:${port} claude`;
  }
}

function renderProxyStatus() {
  const status = document.getElementById('proxyStatus');
  const statusText = document.getElementById('proxyStatusText');
  const startBtn = document.getElementById('proxyStartBtn');
  const cmdEl = document.getElementById('proxyCmdText');
  if (!status || !startBtn) return;

  if (proxyRunning) {
    status.className = 'proxy-status running';
    if (statusText) statusText.textContent = i18n.t('proxy.running', { port: proxyActualPort });
    startBtn.textContent = i18n.t('proxy.stopProxy');
    startBtn.style.background = 'var(--red)';
    if (cmdEl) {
      cmdEl.style.color = 'var(--green)';
      cmdEl.textContent = `ANTHROPIC_BASE_URL=http://localhost:${proxyActualPort} claude`;
    }
  } else {
    status.className = 'proxy-status';
    if (statusText) statusText.textContent = i18n.t('proxy.stopped');
    startBtn.textContent = i18n.t('proxy.startProxy');
    startBtn.style.background = 'var(--blue)';
    if (cmdEl) {
      cmdEl.style.color = 'var(--dim)';
      cmdEl.textContent = i18n.t('proxy.startFirst');
    }
  }
}

async function toggleProxy() {
  const btn = document.getElementById('proxyStartBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spin"></span>'; }

  if (proxyRunning) {
    await window.electronAPI.proxyStop();
    window.electronAPI.offProxy();
    proxyRunning = false;
  } else {
    const port = parseInt(document.getElementById('proxyPort').value) || 9090;
    const result = await window.electronAPI.proxyStart(port);
    if (result.error) {
      alert(i18n.t('proxy.startFail') + result.error);
      if (btn) { btn.disabled = false; btn.textContent = i18n.t('proxy.startProxy'); }
      return;
    }
    proxyRunning = true;
    proxyActualPort = result.port;
    document.getElementById('proxyPort').value = result.port;

    window.electronAPI.onProxyRequest((data) => {
      proxyCaptures.unshift(data);
      if (proxyCaptures.length > 50) proxyCaptures.pop();
      renderProxyList();
    });
    window.electronAPI.onProxyResponse((data) => {
      const entry = proxyCaptures.find(e => e.id === data.id);
      if (entry) {
        entry.response = data;
        renderProxyList();
        if (selectedProxyId === data.id) renderProxyDetail();
      }
    });
  }

  if (btn) btn.disabled = false;
  renderProxyStatus();
}

function renderProxyList() {
  const list = document.getElementById('proxyList');
  const countEl = document.getElementById('proxyCount');
  if (!list) return;
  if (countEl) countEl.textContent = proxyCaptures.length;

  if (proxyCaptures.length === 0) {
    list.innerHTML = `<div class="hist-empty">${i18n.t('proxy.noCaptures')}</div>`;
    return;
  }

  list.innerHTML = proxyCaptures.map(e => {
    const model = e.body?.model ? `<div class="prx-model">${esc(e.body.model)}</div>` : '';
    const sel = e.id === selectedProxyId ? ' selected' : '';
    const statusBadge = e.response
      ? `<span style="font-size:10px;font-family:'SF Mono',monospace;flex-shrink:0;color:${e.response.status < 400 ? 'var(--green)' : 'var(--red)'}">${e.response.status || 'ERR'}</span>`
      : `<span style="font-size:10px;color:var(--dim);flex-shrink:0">â€¦</span>`;
    return `<div class="prx-entry${sel}" onclick="selectProxyEntry(${e.id})">
      <div style="display:flex;align-items:center;overflow:hidden">
        <span class="prx-method">${esc(e.method)}</span>
        <span class="prx-path">${esc(e.path)}</span>
        ${statusBadge}
        <span class="prx-ts">${e.ts}</span>
      </div>
      ${model}
    </div>`;
  }).join('');
}

function selectProxyEntry(id) {
  selectedProxyId = id;
  renderProxyList();
  renderProxyDetail();
}

// â”€â”€â”€ Messages view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Parse CLAUDE.md system-reminder into global/local sections
function parseClaudeMdSections(inner) {
  const re = /Contents of (.+?) \((.+?)\):\n\n([\s\S]*?)(?=\n\nContents of |\s*$)/g;
  const sections = [];
  let m;
  while ((m = re.exec(inner)) !== null) {
    const path = m[1], desc = m[2], content = m[3].trim();
    const fname = path.split('/').pop();
    const isGlobal = /global|private global/i.test(desc);
    const isMemory = /memory/i.test(desc) || /\/memory\//.test(path);
    let label, cls;
    if (isMemory) {
      label = 'ğŸ§  Memory: ' + fname; cls = 'green';
    } else if (/\/rules\//.test(path)) {
      label = (isGlobal ? 'ğŸ“œ Global Rule: ' : 'ğŸ“œ Local Rule: ') + fname;
      cls = isGlobal ? 'green' : 'cyan';
    } else if (/CLAUDE\.md$/i.test(path)) {
      label = isGlobal ? 'ğŸ“‹ Global CLAUDE.md' : 'ğŸ“‹ Local CLAUDE.md';
      cls = isGlobal ? 'green' : 'cyan';
    } else {
      label = 'ğŸ“‹ ' + fname; cls = 'green';
    }
    sections.push({ label, path, content, cls, scope: isGlobal ? 'global' : 'local' });
  }
  return sections;
}

// Parse user message text into typed portions and injected blocks
function parseUserText(text) {
  const parts = [];
  const blockRe = /(<system-reminder>[\s\S]*?<\/system-reminder>|<command-message>[\s\S]*?<\/command-message>)/g;
  let pos = 0, m;
  while ((m = blockRe.exec(text)) !== null) {
    if (m.index > pos) {
      const plain = text.slice(pos, m.index).trim();
      if (plain) parts.push({ type: 'text', content: plain });
    }
    const raw = m[0];
    if (raw.startsWith('<system-reminder>')) {
      const inner = raw.slice('<system-reminder>'.length, -'</system-reminder>'.length);
      if (/skills are available/i.test(inner)) {
        parts.push({ type: 'injected', label: 'ğŸ”§ Skills', content: inner, cls: 'green' });
      } else if (/currentDate|auto-memory/i.test(inner) && !/claudeMd|CLAUDE\.md/i.test(inner)) {
        parts.push({ type: 'injected', label: 'ğŸ§  Memory', content: inner, cls: 'green' });
      } else if (/claudeMd|CLAUDE\.md/i.test(inner)) {
        const sections = parseClaudeMdSections(inner);
        if (sections.length > 0) {
          for (const s of sections) {
            parts.push({ type: 'injected', label: s.label, content: s.content, cls: s.cls });
          }
        } else {
          parts.push({ type: 'injected', label: 'ğŸ“‹ CLAUDE.md', content: inner, cls: 'green' });
        }
      } else {
        parts.push({ type: 'injected', label: 'ğŸ“‹ system-reminder', content: inner, cls: 'green' });
      }
    } else {
      const inner = raw.slice('<command-message>'.length, -'</command-message>'.length);
      parts.push({ type: 'injected', label: 'âŒ¨ slash command', content: inner, cls: 'yellow' });
    }
    pos = m.index + raw.length;
  }
  if (pos < text.length) {
    const plain = text.slice(pos).trim();
    if (plain) parts.push({ type: 'text', content: plain });
  }
  return parts;
}

function highlightSearch(escapedHtml, query) {
  if (!query) return escapedHtml;
  const re = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
  return escapedHtml.replace(re, m => `<mark class="search-hl">${m}</mark>`);
}

let _activeBadgeUid = null;

function toggleBadge(uid) {
  const content = document.getElementById('bc_' + uid);
  const btn = document.getElementById('bb_' + uid);
  if (!content) return;

  // ì´ì „ í™œì„± ë°°ì§€ í•˜ì´ë¼ì´íŠ¸ í•´ì œ
  if (_activeBadgeUid && _activeBadgeUid !== uid) {
    const prevContent = document.getElementById('bc_' + _activeBadgeUid);
    const prevBtn = document.getElementById('bb_' + _activeBadgeUid);
    if (prevContent) { prevContent.style.display = 'none'; prevContent.classList.remove('badge-section-hl'); }
    if (prevBtn) { prevBtn.classList.remove('open', 'hl-active'); }
  }

  const open = content.style.display !== 'none';
  content.style.display = open ? 'none' : 'block';
  content.classList.toggle('badge-section-hl', !open);
  if (btn) {
    btn.classList.toggle('open', !open);
    btn.classList.toggle('hl-active', !open);
  }
  _activeBadgeUid = open ? null : uid;
}

// Render user message content with typed/injected separation
function renderUserMsgContent(text, typedOnly, query) {
  const parts = parseUserText(text);
  if (typedOnly) {
    const typed = parts.filter(p => p.type === 'text');
    if (typed.length === 0) return null;
    return typed.map(p => `<div class="msg-typed">${highlightSearch(esc(p.content), query)}</div>`).join('');
  }
  return parts.map(p => {
    if (p.type === 'text') {
      return `<div class="msg-typed">${highlightSearch(esc(p.content), query)}</div>`;
    }
    const uid = Math.random().toString(36).slice(2, 8);
    return `<div class="msg-injected-row">
      <span id="bb_${uid}" class="msg-badge ${p.cls} expandable" onclick="toggleBadge('${uid}')">${esc(p.label)}</span>
      <div id="bc_${uid}" class="badge-expand-content" style="display:none">${highlightSearch(esc(p.content), query)}</div>
    </div>`;
  }).join('');
}

function renderProxyMessages(entry, container) {
  const msgs = entry.body?.messages || [];
  if (msgs.length === 0) {
    container.innerHTML = `<div class="proxy-empty"><span>${i18n.t('proxy.noMessages')}</span></div>`;
    return;
  }

  const typedOnly = msgFilter === 'typed';
  const baseFiltered = (msgFilter === 'user' || typedOnly) ? msgs.filter(m => m.role === 'user')
    : msgFilter === 'assistant' ? msgs.filter(m => m.role === 'assistant')
    : msgs;

  const q = msgSearchQuery;

  const filterHtml = `<div class="msg-filter">
    <button class="mf-btn${msgFilter==='user'?' active':''}" onclick="setMsgFilter('user')">${i18n.t('messages.filterUser')}</button>
    <button class="mf-btn${msgFilter==='typed'?' active':''}" onclick="setMsgFilter('typed')">${i18n.t('messages.filterTyped')}</button>
    <button class="mf-btn${msgFilter==='assistant'?' active':''}" onclick="setMsgFilter('assistant')">${i18n.t('messages.filterAssistant')}</button>
    <button class="mf-btn${msgFilter==='all'?' active':''}" onclick="setMsgFilter('all')">${i18n.t('messages.filterAll')}</button>
    <span class="msg-count" id="msgCountEl"></span>
  </div>`;

  const searchHtml = `<div class="msg-search-bar">
    <input type="text" id="msgSearchInput" class="msg-search-input"
      placeholder="${esc(i18n.t('messages.searchPlaceholder'))}" value="${esc(q)}"
      oninput="setMsgSearch(this.value)"
      oncompositionstart="_imeComposing=true"
      oncompositionend="_imeComposing=false;setMsgSearch(this.value)">
    ${q ? `<button class="msg-search-clear" onclick="setMsgSearch('');document.getElementById('msgSearchInput')?.focus()" title="${esc(i18n.t('messages.searchClear'))}">âœ•</button>` : ''}
  </div>`;

  const cards = [];
  for (const msg of baseFiltered) {
    const contents = Array.isArray(msg.content)
      ? msg.content
      : [{ type: 'text', text: String(msg.content || '') }];

    // "ë‚´ê°€ ë³´ë‚¸ ê²ƒ" í•„í„°: ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ í…ìŠ¤íŠ¸ê°€ ì—†ëŠ” ë©”ì‹œì§€ ìŠ¤í‚µ
    const isUserFilter = msgFilter === 'user' || typedOnly;
    if (isUserFilter && msg.role === 'user') {
      const hasTypedText = contents.some(c => {
        if (c.type !== 'text' || !c.text || !c.text.trim()) return false;
        const parts = parseUserText(c.text);
        return parts.some(p => p.type === 'text');
      });
      if (!hasTypedText) continue;
    }

    const bodyParts = [];
    for (const c of contents) {
      if (c.type === 'text') {
        if (msg.role === 'user') {
          const rendered = renderUserMsgContent(c.text, isUserFilter, q);
          if (rendered !== null) bodyParts.push(rendered);
        } else {
          bodyParts.push(`<div class="msg-text">${highlightSearch(esc(c.text), q)}</div>`);
        }
      } else if (c.type === 'tool_use') {
        if (!isUserFilter) bodyParts.push(`<div class="msg-tool">ğŸ”§ ${esc(c.name)}()</div>`);
      } else if (c.type === 'tool_result') {
        if (!isUserFilter) {
          const preview = typeof c.content === 'string' ? c.content.slice(0, 120)
            : Array.isArray(c.content) ? c.content.map(x => x.text||'').join('').slice(0, 120) : '[object]';
          bodyParts.push(`<div class="msg-tool-result">ğŸ“¤ ${esc(preview)}${preview.length===120?'â€¦':''}</div>`);
        }
      } else {
        bodyParts.push(`<div class="msg-other">[${esc(c.type)}]</div>`);
      }
    }

    if (bodyParts.length === 0) continue;
    if (q && !bodyParts.join('').includes('class="search-hl"')) continue;

    cards.push(`<div class="msg-card msg-${esc(msg.role)}">
      <div class="msg-role">${esc(msg.role)}</div>
      <div class="msg-body">${bodyParts.join('')}</div>
    </div>`);
  }

  // flex/overflow ì „ë¶€ ë®ì–´ì”Œì›Œì„œ ë‹¨ìˆœ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆë¡œ ì „í™˜
  container.style.cssText = 'flex:1;overflow-y:auto;display:block';
  container.innerHTML = `<div style="position:sticky;top:0;z-index:1;background:var(--bg)">${filterHtml}${searchHtml}</div>` +
    `<div style="display:flex;flex-direction:column;gap:8px;padding:12px">${cards.join('') || `<div class="proxy-empty"><span>${i18n.t('proxy.noResults')}</span></div>`}</div>`;

  const countEl = document.getElementById('msgCountEl');
  if (countEl) countEl.textContent = i18n.t('proxy.msgCount', { count: cards.length, total: msgs.length });

  // Restore focus on search input after re-render
  {
    const inp = document.getElementById('msgSearchInput');
    if (inp && (q || _msgSearchWasFocused)) { inp.focus(); const len = inp.value.length; inp.setSelectionRange(len, len); }
  }
}

function setMsgFilter(f) {
  msgFilter = f;
  const entry = proxyCaptures.find(e => e.id === selectedProxyId);
  const detail = document.getElementById('proxyDetailView');
  if (entry && detail) renderProxyMessages(entry, detail);
}

let _imeComposing = false;
let _msgSearchWasFocused = false;
let _msgSearchTimer = null;

function setMsgSearch(q) {
  msgSearchQuery = q;
  if (_imeComposing) return;
  clearTimeout(_msgSearchTimer);
  _msgSearchTimer = setTimeout(() => {
    _msgSearchWasFocused = document.activeElement?.id === 'msgSearchInput';
    const entry = proxyCaptures.find(e => e.id === selectedProxyId);
    const detail = document.getElementById('proxyDetailView');
    if (entry && detail && proxyDetailTab === 'messages') renderProxyMessages(entry, detail);
  }, 150);
}

let searchCurrentIdx = -1;

let _detailSearchWasFocused = false;
let _detailSearchTimer = null;

function setProxyDetailSearch(q) {
  proxyDetailSearch = q;
  if (_imeComposing) return;
  clearTimeout(_detailSearchTimer);
  _detailSearchTimer = setTimeout(() => {
    _detailSearchWasFocused = document.activeElement?.id === 'proxyDetailSearchInput';
    searchCurrentIdx = -1;
    if (!q) proxyDetailMechFilter = null;
    renderProxyDetail();
    if (q) navigateSearchMatch(0);
  }, 150);
}

function navigateSearchMatch(delta) {
  const container = document.getElementById('proxyDetailCode')
                 || document.querySelector('.analysis-view');
  if (!container) return;
  const marks = container.querySelectorAll('mark.search-hl');
  if (marks.length === 0) return;
  // í˜„ì¬ í•˜ì´ë¼ì´íŠ¸ ì œê±°
  const prev = container.querySelector('mark.search-hl.current');
  if (prev) prev.classList.remove('current');
  // ìƒˆ ì¸ë±ìŠ¤ ê³„ì‚°
  if (delta === 0) searchCurrentIdx = 0;
  else searchCurrentIdx = ((searchCurrentIdx + delta) % marks.length + marks.length) % marks.length;
  marks[searchCurrentIdx].classList.add('current');
  marks[searchCurrentIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
  updateSearchCounter(marks.length);
}

function updateSearchCounter(total) {
  const el = document.getElementById('searchCounter');
  if (el) el.textContent = total > 0 ? `${searchCurrentIdx + 1}/${total}` : '0';
}

function setProxyDetailMechFilter(key, pattern) {
  if (proxyDetailMechFilter === key) {
    proxyDetailMechFilter = null;
  } else {
    proxyDetailMechFilter = key;
  }
  renderProxyDetail();
}

function getChipMeta() {
  return {
    cm: { color: 'var(--green)',
          who:  i18n.t('mechDesc.cm.who'),
          what: i18n.t('mechDesc.cm.what') },
    sc: { color: 'var(--yellow)',
          who:  i18n.t('mechDesc.sc.who'),
          what: i18n.t('mechDesc.sc.what') },
    sk: { color: 'var(--purple)',
          who:  i18n.t('mechDesc.sk.who'),
          what: i18n.t('mechDesc.sk.what') },
    sa: { color: 'var(--orange)',
          who:  i18n.t('mechDesc.sa.who'),
          what: i18n.t('mechDesc.sa.what') },
    mc: { color: '#4ec9dc',
          who:  i18n.t('mechDesc.mc.who'),
          what: i18n.t('mechDesc.mc.what') },
  };
}

function buildMechFilterChips(body) {
  const det = detectMechanisms(body);

  const chips = [];

  // CLAUDE.md â†’ ì„¹ì…˜ë³„ ë¶„ë¦¬ ì¹©
  if (det.claudeMd) {
    const sections = parseClaudeMdSections(det.claudeMd);
    if (sections.length > 0) {
      for (let i = 0; i < sections.length; i++) {
        const s = sections[i];
        // ì¹© ë‚´ ê²€ìƒ‰ íŒ¨í„´: í•´ë‹¹ ì„¹ì…˜ì˜ ì²« ì¤„ (ê³ ìœ ì„± í™•ë³´)
        const firstLine = s.content.split('\n').find(l => l.trim().length > 8) || s.content.slice(0, 40);
        chips.push({ key: 'cm_' + i, found: true, label: s.label, pattern: firstLine.trim(),
                      cls: s.cls === 'cyan' ? 'st' : 'cm', metaKey: 'cm' });
      }
    } else {
      chips.push({ key: 'cm', found: true, label: 'ğŸ“‹ CLAUDE.md', pattern: 'system-reminder', cls: 'cm', metaKey: 'cm' });
    }
  }

  for (let i = 0; i < det.slashCommands.length; i++) {
    chips.push({ key: 'sc_' + i, found: true, label: `âŒ¨ /${det.slashCommands[i].name}`, cls: 'sc', metaKey: 'sc' });
  }
  for (let i = 0; i < det.skills.length; i++) {
    const skName = det.skills[i].input?.skill || det.skills[i].input?.command || `Skill ${i + 1}`;
    chips.push({ key: 'sk_' + i, found: true, label: `ğŸ”§ ${skName}`, cls: 'sk', metaKey: 'sk' });
  }
  if (det.subAgents.length > 0) chips.push({ key: 'sa', found: true, label: 'ğŸ¤– Sub-Agent', pattern: det.subAgents[0]?.name || 'Agent', cls: 'sa', metaKey: 'sa' });
  for (let i = 0; i < det.mcpTools.length; i++) {
    const parts = det.mcpTools[i].name.split('__');
    const toolName = parts.slice(2).join('__') || det.mcpTools[i].name;
    chips.push({ key: 'mc_' + i, found: true, label: `ğŸ”Œ ${toolName}`, cls: 'mc', metaKey: 'mc' });
  }

  if (chips.length === 0) return '';

  const activeChip = chips.find(c => c.key === proxyDetailMechFilter);
  const meta = activeChip ? getChipMeta()[activeChip.metaKey] : null;
  const descBanner = meta
    ? `<div class="mech-filter-desc">
        <span class="mech-filter-desc-dot" style="background:${meta.color}"></span>
        <div class="mech-filter-desc-body">
          <span class="mech-filter-desc-who">${esc(meta.who)}</span>
          <span class="mech-filter-desc-what">${esc(meta.what)}</span>
        </div>
       </div>`
    : '';

  return '<div style="flex-shrink:0;border-bottom:1px solid var(--border)">'
    + '<div style="display:flex;flex-wrap:wrap;gap:5px;padding:5px 10px 7px">'
    + chips.map(c => {
        const active = proxyDetailMechFilter === c.key ? ' active' : '';
        const safePattern = (c.pattern || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        return `<span class="mech-chip ${c.cls} found btn${active}" onclick="setProxyDetailMechFilter('${c.key}','${safePattern}')">${c.label}</span>`;
      }).join('')
    + '</div>'
    + descBanner
    + '</div>';
}

function highlightMechInJsonTree(container, body, mechKey) {
  if (!mechKey) return;

  function hlRange(el, start, end) {
    const html = el.innerHTML;
    el.innerHTML = html.slice(0, start)
      + '<span class="mech-hl-text">' + html.slice(start, end) + '</span>'
      + html.slice(end);
    const hl = el.querySelector('.mech-hl-text');
    if (hl) hl.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  if (mechKey.startsWith('cm')) {
    const det = detectMechanisms(body);
    if (!det.claudeMd) return;
    const sections = parseClaudeMdSections(det.claudeMd);
    const idx = parseInt(mechKey.replace('cm_', ''));
    if (isNaN(idx) || !sections[idx]) return;
    const section = sections[idx];

    const escapedPath = esc('Contents of ' + section.path);
    const strEls = container.querySelectorAll('.jt-str');
    for (const el of strEls) {
      if (!el.textContent.includes('Contents of ' + section.path)) continue;
      const html = el.innerHTML;
      const start = html.indexOf(escapedPath);
      if (start === -1) continue;

      // ì„¹ì…˜ ë: ë‹¤ìŒ "Contents of " ë˜ëŠ” </system-reminder>
      const nextPos = html.indexOf('\n\nContents of ', start + escapedPath.length);
      const srEndPos = html.indexOf(esc('</system-reminder>'), start);
      let end;
      if (nextPos !== -1 && (srEndPos === -1 || nextPos <= srEndPos)) {
        end = nextPos;
      } else if (srEndPos !== -1) {
        end = srEndPos;
        while (end > start && html[end - 1] === '\n') end--;
      } else {
        end = html.length;
      }
      hlRange(el, start, end);
      break;
    }

  } else if (mechKey.startsWith('sc')) {
    const det = detectMechanisms(body);
    const idx = mechKey.includes('_') ? parseInt(mechKey.split('_')[1]) : 0;
    if (!det.slashCommands[idx]) return;
    let count = 0;
    for (const el of container.querySelectorAll('.jt-str')) {
      if (!el.textContent.includes('<command-message>')) continue;
      if (count === idx) {
        const html = el.innerHTML;
        const cmOpen = esc('<command-message>');
        const cmClose = esc('</command-message>');
        const start = html.indexOf(cmOpen);
        if (start < 0) { count++; continue; }
        const endPos = html.indexOf(cmClose, start);
        hlRange(el, start, endPos >= 0 ? endPos + cmClose.length : html.length);
        return;
      }
      count++;
    }

  } else if (mechKey.startsWith('sk')) {
    const det = detectMechanisms(body);
    if (!det.skills.length) return;
    const idx = mechKey.includes('_') ? parseInt(mechKey.split('_')[1]) : 0;
    const skill = det.skills[idx] || det.skills[0];
    if (skill) highlightToolUseById(container, skill.id);
  } else if (mechKey === 'sa') {
    const det = detectMechanisms(body);
    if (!det.subAgents.length) return;
    highlightToolUseById(container, det.subAgents[0].id);
  } else if (mechKey.startsWith('mc')) {
    const det = detectMechanisms(body);
    if (!det.mcpTools.length) return;
    const idx = mechKey.includes('_') ? parseInt(mechKey.split('_')[1]) : 0;
    const mc = det.mcpTools[idx] || det.mcpTools[0];
    if (mc) highlightToolUseById(container, mc.id);
  }
}

function expandAncestors(el) {
  let cur = el.parentElement;
  while (cur) {
    if (cur.id && cur.id.endsWith('-b') && cur.style.display === 'none') {
      jtToggle(cur.id.replace(/-b$/, ''));
    }
    cur = cur.parentElement;
  }
}

function highlightToolUseById(container, toolUseId) {
  const strEls = container.querySelectorAll('.jt-str');
  for (const el of strEls) {
    if (el.textContent !== `"${toolUseId}"`) continue;
    // jt-str â†’ jt-row("id" prop) â†’ jt-N-b (body) â†’ outer span â†’ jt-row (array item)
    const itemRow = el.parentElement?.parentElement?.parentElement?.parentElement;
    if (!itemRow || !itemRow.classList.contains('jt-row')) break;
    expandAncestors(itemRow);
    itemRow.classList.add('mech-hl-row');
    itemRow.scrollIntoView({ behavior: 'smooth', block: 'start' });
    return;
  }
}

function applyDetailHighlight(container, query) {
  if (!query) return;
  const re = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
  const nodes = [];
  while (walker.nextNode()) nodes.push(walker.currentNode);
  for (const node of nodes) {
    const text = node.textContent;
    if (!re.test(text)) continue;
    re.lastIndex = 0;
    let html = '', last = 0, m;
    while ((m = re.exec(text)) !== null) {
      html += esc(text.slice(last, m.index));
      html += `<mark class="search-hl">${esc(m[0])}</mark>`;
      last = m.index + m[0].length;
    }
    html += esc(text.slice(last));
    const span = document.createElement('span');
    span.innerHTML = html;
    node.parentNode.replaceChild(span, node);
  }
}

function renderProxyDetail() {
  const entry = proxyCaptures.find(e => e.id === selectedProxyId);
  const detail = document.getElementById('proxyDetailView');
  if (!detail) return;

  // Messages íƒ­ì—ì„œ ë³€ê²½í•œ inline style ì›ë³µ
  detail.style.cssText = 'flex:1;overflow:hidden;display:flex;flex-direction:column';

  if (!entry) {
    detail.innerHTML = `<div class="proxy-empty"><span style="font-size:28px">ğŸ”</span><span>${i18n.t('proxy.selectRequest')}</span></div>`;
    return;
  }

  if (proxyDetailTab === 'messages') {
    renderProxyMessages(entry, detail);
    return;
  }

  if (proxyDetailTab === 'analysis') {
    const prevAnalysisScroll = detail.querySelector('[style*="overflow:auto"]')?.scrollTop ?? 0;
    renderProxyAnalysis(entry, detail);
    if (proxyDetailMechFilter) {
      requestAnimationFrame(() => {
        const scrollEl = detail.querySelector('[style*="overflow:auto"]');
        if (scrollEl) scrollEl.scrollTop = prevAnalysisScroll;
        const activeSection = detail.querySelector(`[data-mech-key="${proxyDetailMechFilter}"]`);
        if (activeSection) {
          activeSection.classList.add('mech-section-active');
          activeSection.scrollIntoView({ block: 'start', behavior: 'smooth' });
        }
      });
    }
    if (proxyDetailSearch) {
      applyDetailHighlight(detail, proxyDetailSearch);
      const marks = detail.querySelectorAll('mark.search-hl');
      if (marks.length > 0) {
        if (searchCurrentIdx < 0) searchCurrentIdx = 0;
        if (searchCurrentIdx >= marks.length) searchCurrentIdx = 0;
        marks[searchCurrentIdx].classList.add('current');
        updateSearchCounter(marks.length);
      }
    }
    if (proxyDetailSearch || _detailSearchWasFocused) {
      const inp = document.getElementById('proxyDetailSearchInput');
      if (inp) { inp.focus(); const len = inp.value.length; inp.setSelectionRange(len, len); }
    }
    return;
  }

  const data = proxyDetailTab === 'request' ? entry.body : (entry.response?.body ?? null);

  const q = proxyDetailSearch;
  const searchNav = q ? `<div class="search-nav">
    <span id="searchCounter"></span>
    <button class="search-nav-btn" onclick="navigateSearchMatch(-1)" title="${esc(i18n.t('search.prev'))}">â–²</button>
    <button class="search-nav-btn" onclick="navigateSearchMatch(1)" title="${esc(i18n.t('search.next'))}">â–¼</button>
  </div>` : '';
  const searchBar = `<div class="msg-search-bar" style="flex-shrink:0">
    <input type="text" class="msg-search-input" id="proxyDetailSearchInput"
      placeholder="${esc(i18n.t('analysis.searchPlaceholder'))}" value="${esc(q)}"
      oninput="setProxyDetailSearch(this.value)"
      oncompositionstart="_imeComposing=true"
      oncompositionend="_imeComposing=false;setProxyDetailSearch(this.value)">
    ${searchNav}
    ${q ? `<button class="msg-search-clear" onclick="setProxyDetailSearch('');document.getElementById('proxyDetailSearchInput')?.focus()" title="${esc(i18n.t('messages.searchClear'))}">âœ•</button>` : ''}
  </div>`;
  const mechChips = proxyDetailTab === 'request' ? buildMechFilterChips(entry.body) : '';
  const header = `<div style="flex-shrink:0">${searchBar}${mechChips}</div>`;

  if (data === null || data === undefined) {
    detail.innerHTML = header + `<div style="color:var(--dim);padding:16px;font-size:12px">${proxyDetailTab === 'response' ? i18n.t('proxy.waitingResponse') : i18n.t('proxy.noBody')}</div>`;
    return;
  }

  const prevScrollTop = document.getElementById('proxyDetailCode')?.scrollTop ?? 0;
  detail.innerHTML = header + '<div class="json-tree-view" id="proxyDetailCode" style="flex:1;overflow:auto"></div>';
  const code = document.getElementById('proxyDetailCode');
  renderJsonTree(code, data);
  if (proxyDetailMechFilter) {
    code.scrollTop = prevScrollTop;
    highlightMechInJsonTree(code, entry.body, proxyDetailMechFilter);
  }
  if (q) {
    applyDetailHighlight(code, q);
    const marks = code.querySelectorAll('mark.search-hl');
    if (marks.length > 0) {
      if (searchCurrentIdx < 0) searchCurrentIdx = 0;
      if (searchCurrentIdx >= marks.length) searchCurrentIdx = 0;
      marks[searchCurrentIdx].classList.add('current');
      marks[searchCurrentIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
      updateSearchCounter(marks.length);
    }
  }

  if (q || _detailSearchWasFocused) {
    const inp = document.getElementById('proxyDetailSearchInput');
    if (inp) { inp.focus(); const len = inp.value.length; inp.setSelectionRange(len, len); }
  }
}

// â”€â”€â”€ Proxy Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detectMechanisms(body) {
  const found = { claudeMd: null, outputStyle: null, slashCommands: [], skills: [], subAgents: [], mcpTools: [] };
  if (!body) return found;

  // Output Style: system is array with 2+ items
  if (Array.isArray(body.system) && body.system.length >= 2) {
    found.outputStyle = body.system.filter(s => s.type === 'text').map(s => s.text);
  }

  // Scan messages
  const msgs = body.messages || [];
  for (const msg of msgs) {
    const contents = Array.isArray(msg.content) ? msg.content
                   : (typeof msg.content === 'string' ? [{ type: 'text', text: msg.content }] : []);

    for (const c of contents) {
      if (c.type === 'text' && typeof c.text === 'string') {
        // CLAUDE.md: ì—¬ëŸ¬ <system-reminder> ë¸”ë¡ì—ì„œ Contents of íŒ¨í„´ì´ ìˆëŠ” ê²ƒ ëª¨ë‘ ìˆ˜ì§‘
        for (const m of c.text.matchAll(/<system-reminder>([\s\S]*?)<\/system-reminder>/g)) {
          const inner = m[1].trim();
          if (/Contents of /i.test(inner)) {
            found.claudeMd = found.claudeMd ? found.claudeMd + '\n\n' + inner : inner;
          }
        }
        // Slash Command: <command-message> tag (multiple per conversation)
        for (const cmdMatch of c.text.matchAll(/<command-message>([\s\S]*?)<\/command-message>/g)) {
          const tag = cmdMatch[1].trim();
          const nameMatch = tag.match(/^#\s*\/(\S+)/);
          const name = nameMatch ? nameMatch[1] : `Cmd ${found.slashCommands.length + 1}`;
          found.slashCommands.push({ name, tag, full: c.text });
        }
      }
      // Skill tool_use
      if (c.type === 'tool_use' && c.name === 'Skill') {
        found.skills.push({ id: c.id, input: c.input });
      }
      // Sub-Agent (Task / Agent tool)
      if (c.type === 'tool_use' && (c.name === 'Task' || c.name === 'Agent')) {
        found.subAgents.push({ id: c.id, name: c.name, input: c.input });
      }
      // MCP tool_use
      if (c.type === 'tool_use' && c.name && c.name.startsWith('mcp__')) {
        found.mcpTools.push({ id: c.id, name: c.name, input: c.input });
      }
      // tool_result for Skill / MCP
      if (c.type === 'tool_result') {
        const skill = found.skills.find(s => s.id === c.tool_use_id);
        if (skill) skill.result = typeof c.content === 'string' ? c.content : JSON.stringify(c.content, null, 2);
        const mcp = found.mcpTools.find(m => m.id === c.tool_use_id);
        if (mcp) mcp.result = typeof c.content === 'string' ? c.content : JSON.stringify(c.content, null, 2);
      }
    }
  }
  return found;
}

function renderProxyAnalysis(entry, container) {
  const body = entry.body;
  const det = detectMechanisms(body);
  const hasAny = det.claudeMd || det.outputStyle || det.slashCommands.length || det.skills.length || det.subAgents.length || det.mcpTools.length;

  const mechChipsHtml = buildMechFilterChips(body);

  const aq = proxyDetailSearch;
  const analysisSearchBar = `<div class="msg-search-bar" style="flex-shrink:0">
    <input type="text" class="msg-search-input" id="proxyDetailSearchInput"
      placeholder="${esc(i18n.t('analysis.searchPlaceholder'))}" value="${esc(aq)}"
      oninput="setProxyDetailSearch(this.value)"
      oncompositionstart="_imeComposing=true"
      oncompositionend="_imeComposing=false;setProxyDetailSearch(this.value)">
    ${aq ? `<button class="msg-search-clear" onclick="setProxyDetailSearch('');document.getElementById('proxyDetailSearchInput')?.focus()" title="${esc(i18n.t('messages.searchClear'))}">âœ•</button>` : ''}
  </div>`;

  let html = '<div style="flex:1;overflow:auto"><div class="analysis-view">';

  if (!hasAny) {
    html += `<div class="analysis-none">${i18n.t('analysis.noMechanisms')}</div>`;
    html += '</div></div>';
    container.innerHTML = `<div style="flex-shrink:0">${analysisSearchBar}${mechChipsHtml}</div>` + html;
    return;
  }

  // Model info
  if (body?.model) {
    html += `<div class="analysis-kv"><span class="ak">model</span><span class="av">${esc(body.model)}</span></div>`;
  }

  // CLAUDE.md
  if (det.claudeMd) {
    const mdSections = parseClaudeMdSections(det.claudeMd);
    if (mdSections.length > 0) {
      html += `<div class="analysis-section" data-mech-key="cm">
        <div class="analysis-section-title" style="color:var(--green)">${i18n.t('analysis.claudeMdTitle')}</div>
        <div class="analysis-desc">${i18n.t('analysis.claudeMdDesc')}</div>`;
      for (let si = 0; si < mdSections.length; si++) {
        const s = mdSections[si];
        const color = s.scope === 'global' ? 'var(--green)' : 'var(--blue)';
        const hlClass = s.scope === 'global' ? 'highlight-green' : 'highlight-blue';
        html += `<div style="margin-top:8px" data-mech-key="cm_${si}">
          <div style="font-size:10px;font-weight:700;color:${color};margin-bottom:4px">${esc(s.label)}</div>
          <div style="font-size:10px;color:var(--dim);margin-bottom:4px;word-break:break-all">${esc(s.path)}</div>
          <div class="analysis-block ${hlClass}">${esc(s.content)}</div>
        </div>`;
      }
      html += '</div>';
    } else {
      html += `<div class="analysis-section" data-mech-key="cm">
        <div class="analysis-section-title" style="color:var(--green)">${i18n.t('analysis.claudeMdTitle')}</div>
        <div class="analysis-desc">${i18n.t('analysis.claudeMdDesc')}</div>
        <div class="analysis-block highlight-green">${esc(det.claudeMd)}</div>
      </div>`;
    }
  }

  // Output Style
  if (det.outputStyle) {
    const extra = det.outputStyle.slice(1).join('\n\n---\n\n');
    html += `<div class="analysis-section" data-mech-key="st">
      <div class="analysis-section-title" style="color:var(--blue)">${i18n.t('analysis.outputStyleTitle')}</div>
      <div class="analysis-desc">${i18n.t('analysis.outputStyleDesc')}</div>
      <div class="analysis-block highlight-blue">${esc(extra)}</div>
    </div>`;
  }

  // Slash Command + Skill (ì—°ê²°ëœ íë¦„ì´ë©´ í•˜ë‚˜ë¡œ í•©ì¹¨)
  const slashSkillLinked = det.slashCommands.length > 0 && det.skills.length > 0;

  det.slashCommands.forEach((cmd, i) => {
    html += `<div class="analysis-section" data-mech-key="sc_${i}">
      <div class="analysis-section-title" style="color:var(--yellow)">${i18n.t('analysis.slashCmdTitle')}</div>
      <div class="analysis-desc">${i18n.t('analysis.slashCmdDesc', { cmd: esc(cmd.name) })}</div>
      <div class="analysis-block highlight-yellow">${esc(cmd.full)}</div>
    </div>`;
  });

  det.skills.forEach((sk, i) => {
    html += `<div class="analysis-section" data-mech-key="sk_${i}">
      <div class="analysis-section-title" style="color:var(--purple)">${i18n.t(slashSkillLinked ? 'analysis.skillLinkedTitle' : 'analysis.skillTitle')}</div>
      <div class="analysis-desc">${i18n.t(slashSkillLinked ? 'analysis.skillLinkedDesc' : 'analysis.skillDesc')}</div>
      <div class="analysis-kv"><span class="ak">id</span><span class="av">${esc(sk.id)}</span></div>
      <div class="analysis-block highlight-purple jt-json-block" data-json="${escAttr(JSON.stringify(sk.input))}"></div>
      ${sk.result ? `<div class="analysis-kv"><span class="ak">result (tool_result)</span></div><div class="analysis-block highlight-purple">${esc(sk.result)}</div>` : `<div class="analysis-kv"><span class="ak" style="color:var(--dim)">${i18n.t('analysis.noToolResult')}</span></div>`}
    </div>`;
  });

  // Sub-Agents
  for (const sa of det.subAgents) {
    const isJson = sa.input && typeof sa.input === 'object';
    html += `<div class="analysis-section" data-mech-key="sa">
      <div class="analysis-section-title" style="color:var(--orange)">${esc(sa.name)} â€” Sub-Agent</div>
      <div class="analysis-desc">${i18n.t('analysis.subAgentDesc')}</div>
      <div class="analysis-kv"><span class="ak">subagent_type</span><span class="av" style="color:var(--orange)">${esc(sa.input?.subagent_type || sa.input?.type || '?')}</span></div>
      <div class="analysis-block highlight-orange ${isJson ? 'jt-json-block' : ''}" ${isJson ? `data-json="${escAttr(JSON.stringify(sa.input))}"` : ''}>${isJson ? '' : esc(sa.input?.prompt || '')}</div>
    </div>`;
  }

  // MCP Tools
  det.mcpTools.forEach((mc, i) => {
    const parts = mc.name.split('__');
    const serverName = parts[1] || '?';
    const toolName = parts.slice(2).join('__') || mc.name;
    const isJson = mc.input && typeof mc.input === 'object';
    html += `<div class="analysis-section" data-mech-key="mc_${i}">
      <div class="analysis-section-title" style="color:#4ec9dc">ğŸ”Œ ${esc(toolName)} <span style="font-weight:400;opacity:.7">(${esc(serverName)})</span></div>
      <div class="analysis-desc">${i18n.t('mechDesc.mc.what')}</div>
      <div class="analysis-kv"><span class="ak">id</span><span class="av">${esc(mc.id)}</span></div>
      <div class="analysis-block ${isJson ? 'jt-json-block' : ''}" style="border-left:2px solid rgba(78,201,220,.4);background:rgba(78,201,220,.06)" ${isJson ? `data-json="${escAttr(JSON.stringify(mc.input))}"` : ''}>${isJson ? '' : esc(JSON.stringify(mc.input, null, 2))}</div>
      ${mc.result ? `<div class="analysis-kv"><span class="ak">result (tool_result)</span></div><div class="analysis-block" style="border-left:2px solid rgba(78,201,220,.4);background:rgba(78,201,220,.06)">${esc(mc.result)}</div>` : ''}
    </div>`;
  });

  html += '</div></div>';
  container.innerHTML = `<div style="flex-shrink:0">${analysisSearchBar}${mechChipsHtml}</div>` + html;
  container.querySelectorAll('.jt-json-block').forEach(el => {
    try { renderJsonTree(el, JSON.parse(el.dataset.json)); }
    catch (e) { el.textContent = el.dataset.json; }
  });
}

function showDetailTab(tab) {
  proxyDetailTab = tab;
  proxyDetailSearch = '';
  proxyDetailMechFilter = null;
  document.querySelectorAll('.dtab').forEach(b => b.classList.toggle('active', b.dataset.dtab === tab));
  // Analysis tab copy button - hide it (analysis viewëŠ” copyê°€ ì˜ë¯¸ì—†ìŒ)
  const copyBtn = document.querySelector('[onclick="copyProxyDetail()"]');
  if (copyBtn) copyBtn.style.display = (tab === 'analysis' || tab === 'messages') ? 'none' : '';
  renderProxyDetail();
}

function clearProxyCaptures() {
  proxyCaptures = [];
  selectedProxyId = null;
  renderProxyList();
  renderProxyDetail();
}

function copyProxyCmd() {
  const el = document.getElementById('proxyCmdText');
  if (!el || !proxyRunning) return;
  navigator.clipboard.writeText(el.textContent).then(() => {
    const btn = document.querySelector('[onclick="copyProxyCmd()"]');
    if (btn) { const o = btn.textContent; btn.textContent = 'âœ“'; setTimeout(() => btn.textContent = o, 1500); }
  });
}

function copyProxyDetail() {
  const entry = proxyCaptures.find(e => e.id === selectedProxyId);
  if (!entry) return;
  const data = proxyDetailTab === 'request' ? entry.body : (entry.response?.body ?? null);
  if (data === null || data === undefined) return;
  const text = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('[onclick="copyProxyDetail()"]');
    if (btn) { const o = btn.textContent; btn.textContent = 'âœ“'; setTimeout(() => btn.textContent = o, 1500); }
  });
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  // Cmd+F / Ctrl+F: í˜„ì¬ íƒ­ì— ë§ëŠ” ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤
  if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
    const proxyInp = document.getElementById('proxyDetailSearchInput');
    const msgInp = document.getElementById('msgSearchInput');
    const target = proxyInp || msgInp;
    if (target) {
      e.preventDefault();
      target.focus();
      target.select();
    }
  }
  // Escape: ê²€ìƒ‰ ì´ˆê¸°í™”
  if (e.key === 'Escape') {
    const proxyInp = document.getElementById('proxyDetailSearchInput');
    const msgInp = document.getElementById('msgSearchInput');
    if (proxyInp && document.activeElement === proxyInp && proxyDetailSearch) {
      setProxyDetailSearch('');
    } else if (msgInp && document.activeElement === msgInp && msgSearchQuery) {
      setMsgSearch('');
    }
  }
  // Enter / Shift+Enter: ê²€ìƒ‰ ë§¤ì¹­ ì´ì „/ë‹¤ìŒ ì´ë™
  if (e.key === 'Enter') {
    const proxyInp = document.getElementById('proxyDetailSearchInput');
    if (proxyInp && document.activeElement === proxyInp) {
      e.preventDefault();
      navigateSearchMatch(e.shiftKey ? -1 : 1);
    }
  }
});

document.getElementById('modelSel').addEventListener('change', updatePreview);

if (window.electronAPI?.platform === 'darwin') document.body.classList.add('darwin');

const savedKey = localStorage.getItem('ci-api-key');
if (savedKey) {
  document.getElementById('apiKey').value = savedKey;
  onApiKeyChange();
}

// Apply initial i18n (after DOM is ready)
applyI18n();

// ì‹œë®¬ë ˆì´í„° í”Œë˜ê·¸ì— ë”°ë¼ ê´€ë ¨ UI ìˆ¨ê¸°ê¸°
if (!SHOW_SIMULATOR) {
  // íƒ­ ìˆ¨ê¸°ê¸°
  document.querySelectorAll('.tab:not([data-m="proxy"])').forEach(t => t.style.display = 'none');
  // ëœë”© Simulator ì¹´ë“œ ìˆ¨ê¸°ê¸°
  const simCard = document.querySelector('.landing-card:not(.proxy)');
  if (simCard) simCard.style.display = 'none';
  // API Key, ëª¨ë¸ ì„ íƒ, History ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì‹œë®¬ë ˆì´í„° ì „ìš©)
  const apiGroup = document.getElementById('apiGroup');
  const modelSel = document.getElementById('modelSel');
  const histBtn  = document.getElementById('histToggleBtn');
  if (apiGroup) apiGroup.style.display = 'none';
  if (modelSel) modelSel.style.display = 'none';
  if (histBtn)  histBtn.style.display  = 'none';
}

if (!SHOW_SIMULATOR) {
  switchM('proxy'); // ì‹œë®¬ë ˆì´í„° êº¼ì§€ë©´ ë°”ë¡œ í”„ë¡ì‹œ ëª¨ë“œë¡œ
} else {
  switchM('home');
}
</script>
</body>
</html>
